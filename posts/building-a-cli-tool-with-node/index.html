
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/images/cabin.png" >
    <link href="/styles/main.css" rel="stylesheet">
    
    <title>Building a CLI tool with Node</title>
    
    
    <meta name="description" content="A short post explaining the essential techniques required to convert your Node.js project into a command line tool">
    
    <link rel="alternate" type="application/atom+xml" title="Integralist" href="http://feeds.feedburner.com/Integralist">
  </head>
  <body>
    <nav>
      <h1 class="name">
          <a href="/">Integralist</a> <span class="role">BBC News Engineer</span>
      </h1>
      <div class="menu icon-menu"></div>
      <ul class="nav-links">
        <li class="text-link">
          <a href="/about.html">about</a>
        </li>
        <li class="text-link">
          <a href="/projects.html">projects</a>
        </li>
        <li class="text-link">
          <a href="/archives.html">archives</a>
        </li>
      </ul>
      <div class="social-media">
        <a href="https://github.com/integralist" class="icon-github"></a>
        <a href="https://twitter.com/integralist" class="icon-twitter"></a>
      </div>
    </nav>
    <div class="content">

<div class="post-head group">
  <a href="/posts/building-a-cli-tool-with-node/">
    <h1 class="post-title">Building a CLI tool with Node</h1>
  </a>
  <span class="post-date">2014 &#183; 1 &#183; 11</span>
</div>

<div class="post-body"><h2><a name="what-well-cover" class="anchor" href="#what-well-cover"><span class="header-link"></span></a>What we&#39;ll cover</h2>
<p><em>reading time: approx. 15mins</em></p>
<ul>
<li>Introduction</li>
<li>Secret Sauce</li>
<li>Node/NPM Installation</li>
<li>Process</li>
<li>Automation</li>
<li>PhantomJS</li>
<li>Squirrel</li>
<li>How it works</li>
<li>The Code</li>
<li>Packaging</li>
<li>Publishing</li>
<li>Conclusion</li>
</ul>
<h2><a name="introduction" class="anchor" href="#introduction"><span class="header-link"></span></a>Introduction</h2>
<p>I&#39;m going to introduce to you the concepts and techniques required to build a command line tool utilising <a href="http://nodejs.org/">Node.js</a>.</p>
<p>Building a command line tool gives you the opportunity to automate a particular process that would otherwise take you a lot longer to do manually or by yourself.</p>
<p>There are command line tools built in a myriad of different languages and the one we&#39;ll be focusing on is <a href="http://nodejs.org/">Node.js</a>. </p>
<p>For those short on time I&#39;ve condensed the core principles for you into a bullet pointed list to help you on your way. This is the &#39;secret sauce&#39; for converting your node script into a fully functioning command line tool. But I do hope you&#39;ll stick around a bit longer to see what else I have to show you...</p>
<h2><a name="secret-sauce" class="anchor" href="#secret-sauce"><span class="header-link"></span></a>Secret Sauce</h2>
<ul>
<li>In your <code>package.json</code> file include the settings:<ul>
<li><code>&quot;preferGlobal&quot;: &quot;true&quot;</code></li>
<li><code>&quot;bin&quot;: { &quot;name-of-command&quot;: &quot;path-to-script.js&quot; }</code></li>
</ul>
</li>
<li>Add <code>#! /usr/bin/env node</code> to your <code>path-to-script.js</code></li>
<li>To test your new command <code>name-of-command</code> use <code>npm link</code></li>
</ul>
<p>That&#39;s it. The rest of what you need to do is decide what functionality you want to implement.</p>
<h2><a name="nodenpm-installation" class="anchor" href="#nodenpm-installation"><span class="header-link"></span></a>Node/NPM Installation</h2>
<p>To install Node you have a few options:</p>
<ul>
<li><a href="http://nodejs.org/download/">OS specific installer</a> for Windows, Mac or binary</li>
<li><a href="http://brew.sh/">Homebrew</a>: <code>brew install node</code></li>
<li><a href="https://github.com/isaacs/nave#nave">Nave</a></li>
<li><a href="https://github.com/creationix/nvm#node-version-manager">NVM</a></li>
</ul>
<p>Note: NPM is installed as part of Node so there is no separate installation</p>
<p>To test that Node and NPM is installed correctly, run the following commands in your terminal:</p>
<ul>
<li><code>node --version</code></li>
<li><code>npm --version</code></li>
</ul>
<h2><a name="process" class="anchor" href="#process"><span class="header-link"></span></a>Process</h2>
<p>Let&#39;s consider an example process: generating an Application Cache Manifest file.</p>
<p>If <a href="http://www.html5rocks.com/en/tutorials/appcache/beginner/">AppCache</a> is unfamiliar to you, here is a short description: it allows you to take your application offline by specifying pages and resources to cache in case the user loses their internet connection; or tries to access your application later when they&#39;re no longer online.</p>
<p>Typically you&#39;ll create a <a href="http://appcachefacts.info/">appcache.manifest</a> file which you&#39;ll specify the configuration details of your offline requirements.</p>
<p>I won&#39;t go into too much detail about AppCache itself as that will be a distraction for the purpose of what we want to focus on, but below is an example file...</p>
<pre><code><div class="highlight"><pre><span class="nx">CACHE</span> <span class="nx">MANIFEST</span>

<span class="nx">CACHE</span><span class="o">:</span>
<span class="nx">foo</span><span class="p">.</span><span class="nx">jpg</span>
<span class="nx">index</span><span class="p">.</span><span class="nx">html</span>
<span class="nx">offline</span><span class="p">.</span><span class="nx">html</span>
<span class="nx">styles</span><span class="p">.</span><span class="nx">css</span>
<span class="nx">behaviours</span><span class="p">.</span><span class="nx">js</span>

<span class="nx">NETWORK</span><span class="o">:</span>
<span class="o">*</span>

<span class="nx">FALLBACK</span><span class="o">:</span>
<span class="err">/ /offline.html</span>
</pre></div>
</code></pre>
<p>As you can see we&#39;ve specified...</p>
<ul>
<li>a jpg image</li>
<li>two HTML files</li>
<li>a CSS file</li>
<li>a JavaScript file</li>
</ul>
<p>These are the resources we want to cache in case the user goes offline.</p>
<p>We&#39;ve also specified that all items requested by the user should require a network to be accessed.</p>
<p>Finally, we state that any file we access and which we&#39;ve not cached should redirect the user to a file called <code>offline.html</code></p>
<h2><a name="automation" class="anchor" href="#automation"><span class="header-link"></span></a>Automation</h2>
<p>Having to manually look up all the images, style sheets, scripts and other pages linked from a web page would be tedious.</p>
<p>Generating an appcache manifest file is the process we want to try and automate. </p>
<p>We can do this by writing some Node code along with some additional tools, but that isn&#39;t very easy to consume (even for us writing the script) as we would need to open up the code and to tell it which web page we want it to interrogate.</p>
<p>We also want other people to have the benefit of this tool, without them needing to download a folder full of code; asking them to change specific lines of code; as well as running specific commands to run the scripts.</p>
<p>That&#39;s where making a command line tool is going to help.</p>
<h2><a name="phantomjs" class="anchor" href="#phantomjs"><span class="header-link"></span></a>PhantomJS</h2>
<p>First of all we want to figure out how we&#39;re going to solve this problem.</p>
<p>We&#39;ll be using a tool called <a href="http://phantomjs.org/">PhantomJS</a> which is a headless (i.e. chromeless) browser. </p>
<p>Specifically it&#39;s a headless <a href="http://www.webkit.org/">WebKit</a> which provides a JavaScript API we can tap into and will let us do things such as open up web pages and analyse their network requests (amongst many other things, but those are the two fundamental aspects we&#39;re interested in).</p>
<p>There is a node module we can use to load up PhantomJS and start interacting with its API. We&#39;ll be using that to get us started.</p>
<p>We can then convert our code into a command line tool with relative ease using Node&#39;s package manager <a href="https://npmjs.org/">NPM</a> and a <code>package.json</code> file.</p>
<h2><a name="squirrel" class="anchor" href="#squirrel"><span class="header-link"></span></a>Squirrel</h2>
<p>Luckily enough I&#39;ve already done the work for you. It&#39;s an open source project called <a href="https://github.com/Integralist/Squirrel#squirrel">Squirrel.js</a>.</p>
<p>To install it run the command: <code>npm install -g squirrel-js</code>.</p>
<p>Once installed you can use it by running the command: <code>squirrel [url]</code></p>
<p>An example would be <code>squirrel bbc.co.uk/news</code></p>
<p>This would generate (in the current directory) an <code>appcache.manifest</code> populated with all relevant page resources.</p>
<h2><a name="how-it-works" class="anchor" href="#how-it-works"><span class="header-link"></span></a>How it works</h2>
<p>I started off Squirrel by first writing the relevant Node/PhantomJS code which incorporated the functionality I was after.</p>
<p>I then added an additional script which bootstrapped that code and would allow me to take in arguments that configured how the code ran.</p>
<p>What I ended up with was two scripts:</p>
<ul>
<li><a href="https://github.com/Integralist/Squirrel/blob/master/lib/squirrel.js"><code>squirrel.js</code></a></li>
<li><a href="https://github.com/Integralist/Squirrel/blob/master/lib/appcache.js"><code>appcache.js</code></a></li>
</ul>
<p>The first does the set-up work:</p>
<ul>
<li>We specify the environment we want the script to be executed by (in this case Node)</li>
<li>We parse the arguments passed by the user</li>
<li>We read a dummy/internal appcache.manifest file</li>
<li>We open a shell child process and call PhantomJS and pass it the script we want it to execute (in this case <code>appcache.js</code>) and the dummy manifest file</li>
<li>When the second script finishes its work (collating the web page data) we return to this first script and then display some statistic information for the user and generate the manifest file.</li>
</ul>
<p>The second script handles the processing of the web page the user has requested:</p>
<ul>
<li>We take in the dummy manifest file</li>
<li>Create listeners for page resources that are requested</li>
<li>Set the viewport size</li>
<li>Open the web page and store off the resources</li>
<li>Get all links from the page (we do this by executing JavaScript code directly in the web page)</li>
<li>Convert the content of the manifest and inject the resources found and then return that as a JSON file</li>
</ul>
<h2><a name="the-code" class="anchor" href="#the-code"><span class="header-link"></span></a>The Code</h2>
<p>Now you understand the steps the code takes, let&#39;s start reviewing the code. We&#39;ll display the code as a whole and then run through it piecemeal.</p>
<h3><a name="squirrel-js" class="anchor" href="#squirrel-js"><span class="header-link"></span></a>squirrel.js</h3>
<pre><code><div class="highlight"><pre><span class="err">#</span><span class="o">!</span> <span class="err">/usr/bin/env node</span>

<span class="kd">var</span> <span class="nx">userArguments</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">// copies arguments list but removes first two options (script exec type &amp; exec location)</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">userArguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Only one argument should be specified (the url you want to generate the appcache for)&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">fs</span>               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">shell</span>            <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">execFile</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">phantomjs</span>        <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;phantomjs&#39;</span><span class="p">).</span><span class="nx">path</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">scriptToExecute</span>  <span class="o">=</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/appcache.js&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">manifest</span>         <span class="o">=</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/../appcache.manifest&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">url</span>              <span class="o">=</span> <span class="nx">userArguments</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">manifestContent</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">data</span><span class="p">;</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span> <span class="nx">bootstrap</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">bootstrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">contentAsBuffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

    <span class="nx">manifestContent</span> <span class="o">=</span> <span class="nx">contentAsBuffer</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>

    <span class="nx">shell</span><span class="p">(</span><span class="nx">phantomjs</span><span class="p">,</span> <span class="p">[</span><span class="nx">scriptToExecute</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">manifestContent</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

        <span class="c1">// Sometimes an error in the loaded page&#39;s JavaScript doesn&#39;t get picked up or thrown?</span>
        <span class="c1">// But the error comes in via stdout and causes JSON parsing to break</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Whoops! Seems there was an error? You\&#39;ll find the stack trace below.&#39;</span><span class="p">);</span>
            <span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">displayStatistics</span><span class="p">();</span>
        <span class="nx">createManifestFile</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">displayStatistics</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span> <span class="c1">// adds extra line of spacing when displaying the results</span>
    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Links: &#39;</span>      <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">links</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Images: &#39;</span>     <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">images</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;CSS: &#39;</span>        <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">css</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;JavaScript: &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">javascript</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">createManifestFile</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/appcache.manifest&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">manifestContent</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

        <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\nManifest file created&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">message</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>The first line <code>#! /usr/bin/env node</code> is critical for the script to be used within the context of a shell. We need to inform the shell what process should handle the script.</p>
<p>Next we want to retrieve the arguments passed into the command. If we run <code>squirrel bbc.co.uk/news</code> then <code>process.argv</code> will be an Array containing:</p>
<ul>
<li>the script execution type (<code>node</code>)</li>
<li>the script being executed (<code>squirrel.js</code>)</li>
<li>any other arguments (in this instance we only have one other argument: <code>bbc.co.uk/news</code>) </li>
</ul>
<p>We ignore the first two arguments and store off the user specific arguments so we can reference them later: </p>
<p><code>var userArguments = process.argv.slice(2);</code></p>
<p>Our script only knows how to handle a single argument (the page url to load). The following line isn&#39;t really needed as we&#39;ll ignore any more than one argument, but it&#39;s useful for the code to have clear intent and so we throw an error if more than one argument is passed...</p>
<pre><code><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">userArguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Only one argument should be specified (the url you want to generate the appcache for)&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>Because we&#39;re using PhantomJS we&#39;ll need to open up a shell and call the <code>phantomjs</code> command: </p>
<p><code>var shell = require(&#39;child_process&#39;).execFile;</code></p>
<p>We also need to get a reference to the <code>bin</code> directory where the PhantomJS executable is stored:</p>
<p><code>var phantomjs = require(&#39;phantomjs&#39;).path;</code></p>
<p>Next we store a reference to the script we want PhantomJS to execute; as well as the dummy manifest file:</p>
<pre><code><div class="highlight"><pre><span class="kd">var</span> <span class="nx">scriptToExecute</span> <span class="o">=</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/appcache.js&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">manifest</span>        <span class="o">=</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/../appcache.manifest&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">url</span>             <span class="o">=</span> <span class="nx">userArguments</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</pre></div>
</code></pre>
<p>As the PhantomJS script we&#39;ll be executing needs a reference to the dummy manifest file, we&#39;ll asynchronously read the content of the file and then pass it over to a bootstrap function:</p>
<p><code>fs.readFile(manifest, bootstrap);</code></p>
<p>Our <code>bootstrap</code> function does exactly what you would expect; it starts up our application, in this case by opening the shell and calling PhantomJS (you&#39;ll also notice that Node passed the content of the manifest as a Buffer, which we need to convert back into a String):</p>
<pre><code><div class="highlight"><pre><span class="kd">function</span> <span class="nx">bootstrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">contentAsBuffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

    <span class="nx">manifestContent</span> <span class="o">=</span> <span class="nx">contentAsBuffer</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>

    <span class="nx">shell</span><span class="p">(</span><span class="nx">phantomjs</span><span class="p">,</span> <span class="p">[</span><span class="nx">scriptToExecute</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">manifestContent</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// code...</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>At this point in the code execution we would be within the <code>appcache.js</code> file. </p>
<p>We&#39;ll move over to there now...</p>
<h3><a name="appcache-js" class="anchor" href="#appcache-js"><span class="header-link"></span></a>appcache.js</h3>
<p>The purpose of <code>appcache.js</code> is to get information from the user requested page and to pass it back to <code>squirrel.js</code> to process.</p>
<p>Again we&#39;ll start by seeing the script as a whole and then we&#39;ll break down the individual parts (don&#39;t worry, we won&#39;t be going over each line of code, only the important parts):</p>
<pre><code><div class="highlight"><pre><span class="kd">var</span> <span class="nx">unique</span>     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash.uniq&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">system</span>     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span>         <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">page</span>       <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;webpage&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">args</span>       <span class="o">=</span> <span class="nx">system</span><span class="p">.</span><span class="nx">args</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">manifest</span>   <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">css</span>        <span class="o">=</span> <span class="p">[];</span>
<span class="kd">var</span> <span class="nx">images</span>     <span class="o">=</span> <span class="p">[];</span>
<span class="kd">var</span> <span class="nx">javascript</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">var</span> <span class="nx">links</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">url</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">path</span><span class="p">;</span>

<span class="nx">bootstrap</span><span class="p">();</span>
<span class="nx">pageSetUp</span><span class="p">();</span>
<span class="nx">openPage</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">bootstrap</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">urlProvided</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="nx">cleanUrl</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Sorry a valid URL could not be recognised&#39;</span><span class="p">);</span>
            <span class="nx">error</span><span class="p">.</span><span class="nx">additional</span> <span class="o">=</span> <span class="s1">&#39;Valid URL Example: bbc.co.uk/news&#39;</span><span class="p">;</span>

        <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>

        <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">bbcNews</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// We want to serve up the responsive code base...</span>
        <span class="nx">phantom</span><span class="p">.</span><span class="nx">addCookie</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span>  <span class="o">:</span> <span class="s1">&#39;ckps_d&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span> <span class="o">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
            <span class="s1">&#39;domain&#39;</span><span class="o">:</span> <span class="s1">&#39;.bbc.co.uk&#39;</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">pageSetUp</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">page</span><span class="p">.</span><span class="nx">onResourceRequested</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="sr">/\.(?:png|jpeg|jpg|gif)$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">images</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="sr">/\.(?:js)$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">javascript</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="sr">/\.(?:css)$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">css</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">page</span><span class="p">.</span><span class="nx">onError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">trace</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Error :&#39;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">);</span>

        <span class="nx">trace</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Trace:  &#39;</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">file</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">page</span><span class="p">.</span><span class="nx">viewportSize</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">width</span><span class="o">:</span> <span class="mi">1920</span><span class="p">,</span> <span class="nx">height</span><span class="o">:</span> <span class="mi">800</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">openPage</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">links</span>      <span class="o">=</span> <span class="nx">unique</span><span class="p">(</span><span class="nx">getLinks</span><span class="p">());</span>
        <span class="nx">images</span>     <span class="o">=</span> <span class="nx">unique</span><span class="p">(</span><span class="nx">images</span><span class="p">);</span>
        <span class="nx">css</span>        <span class="o">=</span> <span class="nx">unique</span><span class="p">(</span><span class="nx">css</span><span class="p">);</span>
        <span class="nx">javascript</span> <span class="o">=</span> <span class="nx">unique</span><span class="p">(</span><span class="nx">javascript</span><span class="p">);</span>

        <span class="nx">populateManifest</span><span class="p">();</span>

        <span class="c1">// Anything written to `stdout` is actually passed back to our Node script callback</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
            <span class="nx">links</span>           <span class="o">:</span> <span class="nx">links</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
            <span class="nx">images</span>          <span class="o">:</span> <span class="nx">images</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
            <span class="nx">css</span>             <span class="o">:</span> <span class="nx">css</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
            <span class="nx">javascript</span>      <span class="o">:</span> <span class="nx">javascript</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
            <span class="nx">manifestContent</span> <span class="o">:</span> <span class="nx">manifest</span>
        <span class="p">}));</span>

        <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">urlProvided</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="sr">/(?:www\.)?[a-z-z1-9]+\./i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">cleanUrl</span><span class="p">(</span><span class="nx">providedUrl</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If no http or https found at the start of the url...</span>
    <span class="k">if</span> <span class="p">(</span><span class="sr">/^(?!https?:\/\/)[\w\d]/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">providedUrl</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="nx">providedUrl</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">bbcNews</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="sr">/bbc.co.uk\/news/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getLinks</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">item</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">writeVersion</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">manifest</span> <span class="o">=</span> <span class="nx">manifest</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/# Timestamp: \d+/i</span><span class="p">,</span> <span class="s1">&#39;# Timestamp: &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">());</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">writeListContentFor</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">manifest</span> <span class="o">=</span> <span class="nx">manifest</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;(# &#39;</span> <span class="o">+</span> <span class="nx">str</span> <span class="o">+</span> <span class="s1">&#39;)\\n[\\s\\S]+?\\n\\n&#39;</span><span class="p">,</span> <span class="s1">&#39;igm&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">cg</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cg</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;\n\n&#39;</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">populateManifest</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">writeVersion</span><span class="p">();</span>

    <span class="nx">writeListContentFor</span><span class="p">(</span><span class="s1">&#39;Images&#39;</span><span class="p">,</span> <span class="nx">images</span><span class="p">);</span>
    <span class="nx">writeListContentFor</span><span class="p">(</span><span class="s1">&#39;Internal HTML documents&#39;</span><span class="p">,</span> <span class="nx">links</span><span class="p">);</span>
    <span class="nx">writeListContentFor</span><span class="p">(</span><span class="s1">&#39;Style Sheets&#39;</span><span class="p">,</span> <span class="nx">css</span><span class="p">);</span>
    <span class="nx">writeListContentFor</span><span class="p">(</span><span class="s1">&#39;JavaScript&#39;</span><span class="p">,</span> <span class="nx">javascript</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>We begin by using the PhantomJS API to create a new web page:</p>
<pre><code><div class="highlight"><pre><span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;webpage&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">();</span>
</pre></div>
</code></pre>
<p>Next, we check that a url was provided and if so we clean it to be in the appropriate format required (e.g. it has an <code>http</code> protocol). Otherwise we throw an error and stop PhantomJS:</p>
<pre><code><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">urlProvided</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">url</span> <span class="o">=</span> <span class="nx">cleanUrl</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Sorry a valid URL could not be recognised&#39;</span><span class="p">);</span>
    <span class="nx">error</span><span class="p">.</span><span class="nx">additional</span> <span class="o">=</span> <span class="s1">&#39;Valid URL Example: bbc.co.uk/news&#39;</span><span class="p">;</span>

    <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>I also put in a check to see if the url passed was for <code>bbc.co.uk/news</code> and if so I use PhantomJS to set a cookie which allows the responsive version of the site to be loaded (the purpose was merely to demonstrate some of the useful PhantomJS APIs such as <code>addCookie</code>):</p>
<pre><code><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">bbcNews</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">addCookie</span><span class="p">({</span>
        <span class="s1">&#39;name&#39;</span>  <span class="o">:</span> <span class="s1">&#39;ckps_d&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span> <span class="o">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
        <span class="s1">&#39;domain&#39;</span><span class="o">:</span> <span class="s1">&#39;.bbc.co.uk&#39;</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>For PhantomJS to analyse the network data (so we can track what style sheets, JavaScript and images have been requested by the page) we need to use special PhantomJS handlers to interpret the requests:</p>
<pre><code><div class="highlight"><pre><span class="nx">page</span><span class="p">.</span><span class="nx">onResourceRequested</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="sr">/\.(?:png|jpeg|jpg|gif)$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">images</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="sr">/\.(?:js)$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">javascript</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="sr">/\.(?:css)$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">css</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</code></pre>
<p>We also use another PhantomJS API feature which allows us to determine the size of the browser window that is opened:</p>
<p><code>page.viewportSize = { width: 1920, height: 800 };</code></p>
<p>We then tell PhantomJS to open the specified web page. Once the page is open (the <code>load</code> event fired) a callback is executed:</p>
<pre><code><div class="highlight"><pre><span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// code...</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>Within the callback we store off the resources that were found and we call a function that handles replacing the content of our String (the dummy manifest) and replacing it with a list of each set of resources:</p>
<pre><code><div class="highlight"><pre><span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">links</span>      <span class="o">=</span> <span class="nx">unique</span><span class="p">(</span><span class="nx">getLinks</span><span class="p">());</span>
    <span class="nx">images</span>     <span class="o">=</span> <span class="nx">unique</span><span class="p">(</span><span class="nx">images</span><span class="p">);</span>
    <span class="nx">css</span>        <span class="o">=</span> <span class="nx">unique</span><span class="p">(</span><span class="nx">css</span><span class="p">);</span>
    <span class="nx">javascript</span> <span class="o">=</span> <span class="nx">unique</span><span class="p">(</span><span class="nx">javascript</span><span class="p">);</span>

    <span class="nx">populateManifest</span><span class="p">();</span>

    <span class="c1">// Remaining code...</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>Finally, we create a data object to hold statistics about the resources requested; convert it to a JSON string and log it using the <code>console</code> API. </p>
<p>Once this is done we tell PhantomJS to <code>exit</code> (if we didn&#39;t do that then the process would stall):</p>
<pre><code><div class="highlight"><pre><span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Previous code...</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
        <span class="nx">links</span>           <span class="o">:</span> <span class="nx">links</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">images</span>          <span class="o">:</span> <span class="nx">images</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">css</span>             <span class="o">:</span> <span class="nx">css</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">javascript</span>      <span class="o">:</span> <span class="nx">javascript</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">manifestContent</span> <span class="o">:</span> <span class="nx">manifest</span>
    <span class="p">}));</span>

    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>Looking back on the above code you may wonder how we get the data back to our <code>squirrel.js</code> script? Take another look at the <code>console.log</code>, this code has an odd side effect which is that any code logged by PhantomJS is passed back to our shell callback (originally executed within <code>squirrel.js</code>).</p>
<p>Let&#39;s revisit our <code>squirrel.js</code> script...</p>
<h3><a name="back-to-squirrel-js" class="anchor" href="#back-to-squirrel-js"><span class="header-link"></span></a>Back to squirrel.js</h3>
<pre><code><div class="highlight"><pre><span class="nx">shell</span><span class="p">(</span><span class="nx">phantomjs</span><span class="p">,</span> <span class="p">[</span><span class="nx">scriptToExecute</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">manifestContent</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Whoops! Seems there was an error? You\&#39;ll find the stack trace below.&#39;</span><span class="p">);</span>
        <span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">displayStatistics</span><span class="p">();</span>
    <span class="nx">createManifestFile</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>The callback function is run when the PhantomJS script finishes execution. It is passed any errors that may have occurred and if there are then we throw the error:</p>
<p><code>if (err) throw err;</code></p>
<p>The other arguments are the standard output and standard error provided by the shell. In this case the standard output would be our JSON string which we <code>console.log</code>&#39;ed from <code>appcache.js</code>. We parse the JSON string, converting it back into an object so we can present the data to the user who has run the <code>squirrel</code> command.</p>
<p>A side note is that we wrap this conversion in a <code>try/catch</code> clause to protect against web pages that cause a JavaScript error to occur (the error isn&#39;t picked up by <code>stderr</code> but <code>stdout</code> and so it causes the JSON parsing to break):</p>
<pre><code><div class="highlight"><pre><span class="k">try</span> <span class="p">{</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>Once we have our data we call <code>displayStatistics</code> which uses the <code>stdout</code> to write a message to the user&#39;s terminal.</p>
<p>Last we call <code>createManifestFile</code> which creates a <code>appcache.manifest</code> file in the user&#39;s current directory:</p>
<pre><code><div class="highlight"><pre><span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/appcache.manifest&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">manifestContent</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\nManifest file created&#39;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>Now that we have an understanding of how the script works in its entirety, let&#39;s look at how we can allow others to download and install our work.</p>
<h2><a name="packaging" class="anchor" href="#packaging"><span class="header-link"></span></a>Packaging</h2>
<p>For other users to install our module we&#39;ll need to publish it to a public repository. The place to do this is the <a href="https://npmjs.org/">NPM</a> registry. </p>
<p>To publish to NPM you&#39;ll need a <a href="https://npmjs.org/doc/json.html">package.json</a> file.</p>
<p>The purpose of the package.json is to specify the dependencies for the project you&#39;re working on. In this instance it specifies the dependencies required by Squirrel to do its job.</p>
<p>Below is Squirrel&#39;s package.json file:</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;squirrel-js&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;0.1.3&quot;</span><span class="p">,</span>
  <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;Node based cli tool using PhantomJS to automate generation of an Application Cache manifest file for a specified URL&quot;</span><span class="p">,</span>
  <span class="s2">&quot;main&quot;</span><span class="o">:</span> <span class="s2">&quot;lib/squirrel&quot;</span><span class="p">,</span>
  <span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;test&quot;</span><span class="o">:</span> <span class="s2">&quot;echo &quot;</span><span class="nb">Error</span><span class="o">:</span> <span class="nx">no</span> <span class="nx">test</span> <span class="nx">specified</span><span class="s2">&quot; &amp;&amp; exit 1&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;engines&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;node&quot;</span><span class="o">:</span> <span class="s2">&quot;&gt;=0.10&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;repository&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;git&quot;</span><span class="p">,</span>
    <span class="s2">&quot;url&quot;</span><span class="o">:</span> <span class="s2">&quot;git://github.com/Integralist/Squirrel.git&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;preferGlobal&quot;</span><span class="o">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
  <span class="s2">&quot;bin&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;squirrel&quot;</span><span class="o">:</span> <span class="s2">&quot;lib/squirrel.js&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;phantomjs&quot;</span><span class="o">:</span> <span class="s2">&quot;~1.9.2-6&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lodash.uniq&quot;</span><span class="o">:</span> <span class="s2">&quot;~2.4.1&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;keywords&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">&quot;appcache&quot;</span><span class="p">,</span>
    <span class="s2">&quot;phantomjs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cli&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;author&quot;</span><span class="o">:</span> <span class="s2">&quot;Mark McDonnell &lt;mark.mcdx@gmail.com&gt; (http://www.integralist.co.uk/)&quot;</span><span class="p">,</span>
  <span class="s2">&quot;license&quot;</span><span class="o">:</span> <span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
  <span class="s2">&quot;bugs&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;url&quot;</span><span class="o">:</span> <span class="s2">&quot;https://github.com/Integralist/Squirrel/issues&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;homepage&quot;</span><span class="o">:</span> <span class="s2">&quot;https://github.com/Integralist/Squirrel&quot;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>You can read up on all the different properties for the package.json file on the <a href="https://npmjs.org/doc/json.html">NPM registry site</a>. </p>
<p>The important items to take note of are...</p>
<ul>
<li><code>&quot;preferGlobal&quot;: &quot;true&quot;</code></li>
<li><code>&quot;bin&quot;: { &quot;squirrel&quot;: &quot;lib/squirrel.js&quot; }</code></li>
</ul>
<p>...the first property indicates that when a user installs your module that you would prefer it to be installed globally (in this case we do want it installed globally as it means the user can run the command any where in their system).</p>
<p>The second property indicates where the command will find the code required to execute the command.</p>
<p>For you to be able to test that your command works you&#39;ll need to run the command: <code>npm link</code> which (in this case) will create a symlink from the command <code>squirrel</code> to the <code>squirrel.js</code> file.</p>
<h2><a name="publishing" class="anchor" href="#publishing"><span class="header-link"></span></a>Publishing</h2>
<p>To publish your code you need to first register on <a href="https://npmjs.org/signup">NPM</a> for an account.</p>
<p>Once you have an account you need to verify your account via the command line. To do this run the command: <code>npm adduser</code> which will ask you to specify a username and a password.</p>
<p>Once your account is verified you can then publish your module to the NPM registry using the command: <code>npm publish</code>.</p>
<p>It can take a few minutes for your module to become publicly available for users to install.</p>
<p>Be aware that if you make some updates to your code and try to run <code>npm publish</code> without updating the package.json file&#39;s <code>version</code> property then NPM will return an error advising you to include an updated version number.</p>
<h2><a name="conclusion" class="anchor" href="#conclusion"><span class="header-link"></span></a>Conclusion</h2>
<p>This is a small example of the sort of command line tools you can develop. The next time you find yourself doing a repetitious task then consider whether it would be useful to automate the process into a reusable cli tool.</p>
</div>

<!--Social sharing icons-->
<div class="social">
  <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a>
  <div data-size="medium" data-annotation="bubble" data-width="300" class="g-plusone"></div>
  <a href="http://news.ycombinator.com/submit" class="hn-share-button">Vote on HN</a>
</div>
<!--Disqus comments, Make sure to replace `colinwren` with your account name in the Disqus helper script below-->
<div id="comments">
  <div id="disqus_thread"></div>
</div>

<!--Helper scripts for social share icons-->
<!--Hacker News-->
<script type="text/javascript">
  (function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.src = '//hnbutton.appspot.com/static/hn.min.js';
    s.parentNode.insertBefore(g, s);
  }(document, 'script'));
</script>

<!--Twitter-->
<script type="text/javascript">
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
</script>

<!--Google Plus-->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>

<!--Disqus-->
<script type="text/javascript">
  var disqus_shortname = 'integralist'; // Change this to your Disqus account name

  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js" type="text/javascript"></script>
    <script src="/scripts/main.js" type="text/javascript"></script>
    <script src="/scripts/Imager.js" type="text/javascript"></script>
    <script>
        var _gaq=[['_setAccount','UA-33159515-1'],['_trackPageview']];
        (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
        g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>
  </body>
</html>

