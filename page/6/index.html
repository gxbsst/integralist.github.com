<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/images/cabin.png" >
    <link href="/styles/main.css" rel="stylesheet">
    
    <title>Integralist -> BBC News Engineer</title>
    
    
    <link rel="alternate" type="application/atom+xml" title="Integralist" href="http://feeds.feedburner.com/Integralist">
  </head>
  <body>
    <nav>
      <h1 class="name">
          <a href="/">Integralist</a> <span class="role">BBC News Engineer</span>
      </h1>
      <div class="menu icon-menu"></div>
      <ul class="nav-links">
        <li class="text-link">
          <a href="/about.html">about</a>
        </li>
        <li class="text-link">
          <a href="/projects.html">projects</a>
        </li>
        <li class="text-link">
          <a href="/archives.html">archives</a>
        </li>
      </ul>
      <div class="social-media">
        <a href="https://github.com/integralist" class="icon-github"></a>
        <a href="https://twitter.com/integralist" class="icon-twitter"></a>
      </div>
    </nav>
    <div class="content">


  <div class="post-head group">
  <a href="/posts/stark-simplified-separation-of-components-into-decoupled-applications/">
    <h1 class="post-title">Stark - Simplified separation of components into decoupled applications</h1>
  </a>
  <span class="post-date">2013 &#183; 8 &#183; 7</span>
</div>

<div class="post-body"><h2><a name="what-well-cover" class="anchor" href="#what-well-cover"><span class="header-link"></span></a>What we&#39;ll cover</h2>
<p><em>reading time: approx. 18mins</em></p>
<ul>
<li>Convoluted solutions</li>
<li>Simplicity</li>
<li>Perfection?</li>
<li>Good code design</li>
<li>The front-end landscape</li>
<li>Introducing Stark</li>
<li>How does it work</li>
<li>Components and Extensions</li>
<li>Convention over configuration</li>
<li>Examples</li>
<li>Conclusion</li>
</ul>
<h2><a name="convoluted-solutions" class="anchor" href="#convoluted-solutions"><span class="header-link"></span></a>Convoluted solutions</h2>
<p>The web industry is a fascinating beast. It is constantly evolving, changing, morphing itself into new shapes and producing fun tools for our pleasure (and disposal). It&#39;s like a hyper-active child: it can&#39;t sit still.</p>
<p>For all the good things that come from this inherent behaviour (e.g. every few weeks there are new toys and techniques, tricks and tips and those beloved buzz words), there is one problem that seems to consequentially arise… complication.</p>
<p>It seems we&#39;ve lost the simplicity in solutions we provide. It would seem we&#39;re a breed of enthusiasts who (knowingly or unknowingly) love to over-engineer things, and there in lies the problem.</p>
<p>Now I see this in lots of different places, down to the architectures we create, to the code we write to the designs we implement. </p>
<h2><a name="simplicity" class="anchor" href="#simplicity"><span class="header-link"></span></a>Simplicity</h2>
<p>&quot;Simplicity&quot; is defined as… </p>
<blockquote>
<p>the quality or condition of being easy to understand or do</p>
</blockquote>
<p>…but this doesn&#39;t always present itself in the projects I see or have worked on in the past.</p>
<h2><a name="perfection" class="anchor" href="#perfection"><span class="header-link"></span></a>Perfection?</h2>
<p>Now let&#39;s be clear here, I&#39;m no white knight in shining armour. I, like most developers, have at some point written (and may continue to write) bad code. That&#39;s just the way it is when you either have tight deadlines, or you&#39;re unsure of how to solve a problem (or whatever other reason there may be for writing bad code). Sometimes what we do can seem more like a &#39;feeling out&#39; process than a fine art.</p>
<p>What we do is a creative process. Yes writing &#39;code&#39; isn&#39;t usually thought of as creative but it is, it is an art and a difficult one at that. </p>
<p>Any time I&#39;ve seen some bad code and thought &quot;WTF?&quot;, I&#39;m not trying to disrespect the author, or question their skills as a developer. That&#39;s just a gut reaction we all have when looking at something we don&#39;t understand. </p>
<p>We need to remember to put ourselves into the shoes of the author and take their perspective, try to understand the circumstances that brought about the code we&#39;re looking at now.</p>
<p>It&#39;s all so easy to criticise, it&#39;s another to &quot;do&quot; (and do well).</p>
<h2><a name="good-code-design" class="anchor" href="#good-code-design"><span class="header-link"></span></a>Good code design</h2>
<p>When I started working at the BBC I had the pleasure of working with a chap called <a href="http://twitter.com/danscotton">Dan Scotton</a>. Dan, like me, loved to draw his code structure. It was a great exercise in making sure you weren&#39;t going to write code that was redundant or useless. Usually he would ask for my thoughts on code he was working on, which was great to be a part of because it helped both Dan and myself better understand the problem and what the right solution should be (you&#39;d be surprised how many developers keep their code or ideas tightly guarded, afraid of conflict or disapproval from others).</p>
<p>One of the main points I always reiterated to Dan was the idea of simplicity: &quot;<em>it needs to be as simple, yet effective, efficient and practical as possible</em>&quot; (luckily I didn&#39;t need to preach for too long, as Dan already incorporated those ideas).</p>
<p>But Dan also introduced me to the principles of good &#39;code design&#39;. Through him I was inspired to read older software engineering books (mostly around object-oriented code and design - lower level, server-side, languages such as Java, C++, Ruby etc). </p>
<p>For years up until this point I was already a big believer in Design Patterns (as prescribed by &#39;The Gang of Four&#39;) but that didn&#39;t mean I understood the principle of good code &#39;design&#39;. Reading these older software engineering books helped nail home the idea of simplicity which really is the heart of the subject and ironically is the hardest and most complicated principle to truly understand.</p>
<h2><a name="the-front-end-landscape" class="anchor" href="#the-front-end-landscape"><span class="header-link"></span></a>The front-end landscape</h2>
<p>So where am I going with this and what problem am I trying to solve?</p>
<p>Well, for me the front-end developer landscape has become a dumping ground of overly complicated and over-engineered solutions.</p>
<p>There are some seriously good tools out there. For example, the CSS pre-processor <a href="http://sass-lang.com/">Sass</a> is a useful tool which solves a particular problem. Sass is a just one small piece of the overall puzzle (forgive me this next bit), but… </p>
<blockquote>
<p>with great power, comes great responsibility</p>
</blockquote>
<p>…Sass (like most of the tools we have at our disposal) can, and is, mis-used. </p>
<p>With regards to Sass, I&#39;ve seen developers writing mixins that try to solve a thousand different problems all at once (scenarios they may never have). I can only assume they must be thinking: &quot;<em>if I include this extra piece of functionality then people will thank me later when they do finally need it</em>&quot;. </p>
<p>This isn&#39;t just a problem with developers trying to solve too many problems at once. It ultimately comes down to breaching, and probably a lack of understanding, many good code design principles that help us avoid such disastrously unmaintainable and unscalable code**</p>
<p>**if you want a good book to read on the subject then I can whole heartedly recommend you get &quot;<a href="http://www.poodr.info/">Practical Object-Oriented Design in Ruby</a>&quot; (also read my own write-up of that book: &quot;<a href="http://integralist.co.uk/Object-Oriented-Design.html">Object-Oriented Design</a>&quot;)</p>
<h2><a name="introducing-stark" class="anchor" href="#introducing-stark"><span class="header-link"></span></a>Introducing Stark</h2>
<p>This brings me to a project I&#39;ve been working on (and still am working on) called <a href="https://github.com/Integralist/Stark#stark">Stark</a>.</p>
<p>Stark is a work in progress. It is by no means a finished product. But the principles it tries to incorporate are things I&#39;ll attempt to explain in more detail here in this post, and are definitely worth your time investigating further still.</p>
<p>So what is Stark?</p>
<p>Stark is simply a fancy name for a &#39;strategy&#39;. It&#39;s not another development framework. It&#39;s a way of thinking about, and implementing your project&#39;s architecture and code design. Primarily based around the loading of JavaScript and JavaScript based components, communication between those components and also the CSS that provides the &#39;skin&#39; for those components.</p>
<p>It is a mix-mash of different techniques and styles but ultimately is aiming for simplicity and effectiveness. </p>
<p>The API I&#39;ve used, and some of the code structure is based off of the great work <a href="http://twitter.com/addyosmani">Addy Osmani</a> has done with his <a href="http://aurajs.com/">Aura.js project</a>. </p>
<p>It&#39;s worth noting that what I&#39;ve done here for Stark is not even in the same league as Aura. The reason I mention this is because I&#39;m aiming for… simplicity :-) I didn&#39;t want (or need) the extra bells and whistles. I had my own set of problems I was trying to solve, and reducing the number of dependencies, libraries etc was important for me.</p>
<p>I&#39;m also not suggesting you should use <a href="https://github.com/Integralist/Stark#stark">Stark</a> (I&#39;m not suggesting my way is the best way), but just to use it as a basis for learning about other ways of thinking and approaching front-end work.</p>
<h2><a name="how-does-it-work" class="anchor" href="#how-does-it-work"><span class="header-link"></span></a>How does it work</h2>
<p>Stark is based around the idea of components (pages being made up of uniquely individual components).</p>
<p>Components are written into the page using plain HTML. Our JavaScript application when initialised will find all components and instantiate them for you automatically. The components can have fallback content which won&#39;t be visible as long as JavaScript is enabled (this is because in the <code>&lt;head&gt;</code> of the page we have a single inline <code>&lt;script&gt;</code> tag which adds the class <code>js</code> to the <code>&lt;html&gt;</code> tag. With this class added our CSS only applies styling to elements if there is a <code>.js</code> class available - similar to how Modernizr works).</p>
<p>On the JavaScript side of things we utilise AMD (Asynchronous Module Definition) which is an API for loading individual JavaScript modules. Nothing new here. But we also use <a href="http://requirejs.org/">RequireJS</a> for our script loader. Lastly, because we&#39;re lazy-loading component JavaScript modules at run time (e.g. in development) we don&#39;t want to be doing that when we go live (e.g. into production) because we want to be good web citizens and reduce the number of HTTP requests we make, so we lean very heavily on a custom build script using the associated <a href="http://requirejs.org/docs/optimization.html">r.js</a> tool which handles that for us.</p>
<p>On the CSS side of things we want to be as maintainable, flexible and scalable (i.e. all the great things <a href="http://csswizardry.com/">Harry Roberts</a> talks about). We use the <a href="http://integralist.co.uk/Maintainable-CSS-with-BEM.html">BEM</a> naming conventions for making sure our CSS isn&#39;t overly specific and we use <a href="http://sass-lang.com/">Sass</a> for helping to keep our implementation details of a component encapsulated within the component&#39;s own style sheet. We also use a trick that <a href="http://twitter.com/jaffathecake">Jake Archibald</a> came up with for generating an IE based style sheet (we&#39;ll cover that shortly).</p>
<p>Later on when we look at some example code this will start making a bit more sense.</p>
<h2><a name="components-and-extensions" class="anchor" href="#components-and-extensions"><span class="header-link"></span></a>Components and Extensions</h2>
<p>I made reference above, and I do so regularly in <a href="https://github.com/Integralist/Stark#stark">Stark</a> to &#39;components&#39; and &#39;extensions&#39;. </p>
<p>I think components are pretty self explanatory, but just to be clear: they are self-contained pieces of functionality. </p>
<p>Components know nothing about each other (i.e. they lack &#39;context&#39;). Components communicate through the &#39;mediator&#39; design pattern, meaning they can publish an event when they do something interesting and they can also be notified of events outside them, but they don&#39;t need to know anything about the objects that publish those outside events. Total separation means components can more easily be updated and migrated if need be.</p>
<p>Extensions on the other hand are just small pieces of extra functionality that you can mix into your code. The mediator pattern itself is an extension that I include (i.e. &#39;mix&#39;) into my application.</p>
<p>I&#39;ll give examples of these shortly.</p>
<h2><a name="convention-over-configuration" class="anchor" href="#convention-over-configuration"><span class="header-link"></span></a>Convention over configuration</h2>
<p>Oh boy, &quot;convention over configuration&quot; is usually an alarm bell for me when looking at a new project. It screams &quot;<em>hey, this is my opinionated view on how things should be done</em>&quot;. But what I didn&#39;t realise before (which I do realise now) is that, it&#39;s not until you try and solve a particular problem that you soon discover yourself becoming very opinionated about the route you&#39;ve taken to implement that solution. </p>
<p>We developers are a sensitive bunch and don&#39;t normally take criticisms well.</p>
<p>But the difference between you and an overly opinionated developer is that those opinionated developers generally aren&#39;t willing to hear alternatives or to take advice or alternative ways of thinking about a problem. </p>
<p>I like to think I&#39;m very open to suggestions, change and better ways of doing things. If someone opens up an issue (or better yet a pull request) that suggests a more effective way of solving a problem, then I&#39;m happy to hear it.</p>
<p>That being said, I&#39;ve implemented a small set of conventions (<a href="https://github.com/Integralist/Stark#conventions">explained in the repo</a>, but I&#39;ll cover briefly here)…</p>
<ul>
<li>HTML components need a <code>data-attribute</code> and an <code>id</code></li>
<li>The data attribute needs to take the form of: <code>data-component=&quot;xxx&quot;</code></li>
<li>The id attribute needs to take the form of: <code>id=&quot;js-component-xxx&quot;</code></li>
<li>The <code>xxx</code> mentioned above needs to be the name of the component</li>
<li>Components are placed inside a <code>/components/</code> directory</li>
<li>Extensions are placed inside a <code>/extensions/</code> directory</li>
<li>Each page has its own bootstrap js file <code>boostrap-xxx.js</code></li>
<li>JavaScript needs to be loaded at the bottom of the page</li>
<li>Components need to have an <code>init</code> method</li>
</ul>
<p>…see that wasn&#39;t too bad now was it.</p>
<h2><a name="examples" class="anchor" href="#examples"><span class="header-link"></span></a>Examples</h2>
<p>Finally we come to some code!</p>
<h3><a name="api" class="anchor" href="#api"><span class="header-link"></span></a>API</h3>
<ul>
<li><code>app.use(&#39;extension&#39;, &#39;extension&#39;, &#39;extension&#39;)</code> loads specified extensions</li>
<li><code>app.start()</code> goes through the HTML looking for components to load</li>
</ul>
<p>As mentioned earlier, we use RequireJS and AMD to wrap the above API calls, for example… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// the only part of this code that needs to change</span>
<span class="c1">// is the list of extensions you want to use</span>
<span class="c1">// the rest is standard (read: required to be run)</span>
<span class="nx">require</span><span class="p">([</span><span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;configuration&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;extension-a&#39;</span><span class="p">,</span> <span class="s1">&#39;extension-b&#39;</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>But now let&#39;s look at each section individually… </p>
<h3><a name="html" class="anchor" href="#html"><span class="header-link"></span></a>HTML…</h3>
<pre><code class="lang-html"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-component=</span><span class="s">&quot;hello&quot;</span> <span class="na">id=</span><span class="s">&quot;js-component-hello&quot;</span><span class="nt">&gt;</span>hello<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">data-component=</span><span class="s">&quot;world&quot;</span> <span class="na">id=</span><span class="s">&quot;js-component-world&quot;</span><span class="nt">&gt;</span>world<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;libs/require.js&quot;</span> <span class="na">data-main=</span><span class="s">&quot;bootstrap-about&quot;</span> <span class="na">async</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div>
</code></pre>
<p>As you can see we have a <code>data-component</code> attribute which is used by the JavaScript application when it is booting up (initialised). </p>
<p>But we also have an <code>id</code> attribute which I use to reference the component from within the component&#39;s JavaScript module code. So for example, based on the &#39;conventions&#39; I mentioned earlier, the JavaScript application will find a HTML <code>div</code> with a <code>data-component</code> name of <code>hello</code> and will try to load <code>components/hello/component.js</code> - inside of that JavaScript file I might want to replace the <code>div</code> in the DOM with a totally different chunk of HTML code, or I might want to inject more HTML inside of that <code>div</code> element, the choice is up to you as the developer to decide what to do at that point.</p>
<p>You don&#39;t really need to include the <code>id</code> attribute if you don&#39;t want to but my build script will try and use it as a reference to the DOM node. You can reference the DOM node any way you see fit, I just personally prefer the speed of native <code>getElementById</code> to grab DOM nodes.</p>
<p>Originally I had thought about not using an empty <code>div</code> container with a custom <code>data-</code> attribute but just a simple HTML comment <code>&lt;!-- #component hello --&gt;</code> but then I realised that there wasn&#39;t an easy hook into the page without parsing the entire DOM, and also there was no fallback content that could be provided.</p>
<h3><a name="bootstrap" class="anchor" href="#bootstrap"><span class="header-link"></span></a>Bootstrap...</h3>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">require</span><span class="p">([</span><span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;configuration&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;mediator&#39;</span><span class="p">,</span> <span class="s1">&#39;extension-a&#39;</span><span class="p">,</span> <span class="s1">&#39;extension-b&#39;</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>I had considered just having a single bootstrap script but the list of extensions used is very likely going to be different per page, hence we have a different bootstrap for each page.</p>
<p>The bootstrap loads in our JavaScript application along with a configuration object (which is just the RequireJS config)… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
    <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">&#39;./&#39;</span><span class="p">,</span>
    <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">jquery</span><span class="o">:</span> <span class="s1">&#39;libs/jquery&#39;</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>Once our application is loaded we tell the app what extensions we want to use and then we tell the application to start.</p>
<h3><a name="component" class="anchor" href="#component"><span class="header-link"></span></a>Component...</h3>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">define</span><span class="p">({</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;an example component&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>This is an example component. As mentioned earlier: components need to have a public <code>init</code> method, otherwise they can do whatever you want them to.</p>
<h3><a name="extension" class="anchor" href="#extension"><span class="header-link"></span></a>Extension...</h3>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Silly example</span>
<span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">blah</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">blah</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span> <span class="o">+</span> <span class="s1">&#39; BLAH!&#39;</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>This is an example extension. Extensions can do whatever you want them to do. </p>
<p>The only thing worth noting about extensions is that they can&#39;t take advantage of dependency injection (e.g. can&#39;t be passed directly into your components). </p>
<p>To work around this Stark uses the idea of a single global namespace called <code>app</code> (e.g. <code>window.app = {};</code>) which you can attach any extensions or other data you need to pass around.</p>
<p>So for example, our Mediator extension uses <code>window.app.mediator = mediator;</code> like so… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">mediator</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="c1">// code</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="c1">// public api</span>
        <span class="p">};</span>

    <span class="p">}());</span>

    <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">mediator</span> <span class="o">=</span> <span class="nx">mediator</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">mediator</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p><strong>Don&#39;t mistake the phrase: &quot;<em>Don&#39;t pollute the global namespace</em>&quot; with &quot;<em>Don&#39;t ever use the global namespace ever ever ever</em>&quot; - that&#39;s just dogmatic nonsense.</strong></p>
<h3><a name="css" class="anchor" href="#css"><span class="header-link"></span></a>CSS</h3>
<p>So our CSS uses Sass to help us keep our code more easily maintainable. Each page should load a page specific style sheet that contains the code relevant for that page.</p>
<p>So our example page loads <code>project.css</code>, the Sass file looks like this… </p>
<pre><code class="lang-sass"><div class="highlight"><pre><span class="cm">/* =============================================================================</span>
  <span class="cm">Base Utilities</span>
  <span class="cm">========================================================================== */</span>

  <span class="cm">@import &#39;partials/variables&#39;;</span>
  <span class="cm">@import &#39;partials/utils&#39;;</span>
  <span class="cm">@import &#39;partials/baseline&#39;;</span>
  <span class="cm">@import &#39;partials/grid&#39;;</span>

<span class="cm">/* =============================================================================</span>
  <span class="cm">Patterns</span>
  <span class="cm">These are common design patterns abstracted into reusable chunks of code</span>
  <span class="cm">========================================================================== */</span>

  <span class="cm">@import &#39;patterns/media&#39;;</span>

<span class="cm">/* =============================================================================</span>
  <span class="cm">Core</span>
  <span class="cm">This is the experience for either really old devices, or non-js devices</span>
  <span class="cm">========================================================================== */</span>

  <span class="cm">@import &#39;partials/core&#39;;</span>

<span class="cm">/* =============================================================================</span>
  <span class="cm">Groups</span>
  <span class="cm">Any design enhancements that aren&#39;t a separate component and aren&#39;t part </span>
  <span class="cm">of the core experience should be placed within one of the following groups.</span>

  <span class="cm">Note: we&#39;re using inheritance for our CSS loading strategy which means each</span>
  <span class="cm">stylesheet inherits styles from the group that came before it</span>
  <span class="cm">========================================================================== */</span>

  <span class="cm">@import &#39;groups/group1&#39;;</span>
  <span class="cm">@import &#39;groups/group2&#39;;</span>
  <span class="cm">@import &#39;groups/group3&#39;;</span>
  <span class="cm">@import &#39;groups/group4&#39;;</span>

<span class="cm">/* =============================================================================</span>
  <span class="cm">Components</span>
  <span class="cm">You only need to import components into the top-level project/project-ie files</span>
  <span class="cm">Components have been built to be self contained.</span>
  <span class="cm">This means they encapsulate any logic about viewport dimensions.</span>
  <span class="cm">This allows them to control their own visual display.</span>
  <span class="cm">========================================================================== */</span>

  <span class="cm">@import &#39;components/hello&#39;;</span>
  <span class="cm">@import &#39;components/world&#39;;</span>
  <span class="cm">@import &#39;components/features-and-analysis&#39;;</span>
  <span class="cm">@import &#39;components/index&#39;;</span>
</pre></div>
</code></pre>
<p>I won&#39;t go into detail for each part of this file because the code comments should be self explanatory. But we&#39;ll look at bit more at the &#39;groups&#39; and also the &#39;components&#39;.</p>
<h4><a name="groups" class="anchor" href="#groups"><span class="header-link"></span></a>Groups</h4>
<p>We break-down our layouts into &#39;groups&#39;, and each group inherits styles from the group that came before it.</p>
<p>Here is what our group 1 looks like… </p>
<pre><code class="lang-sass"><div class="highlight"><pre><span class="cm">/* =============================================================================</span>
   <span class="cm">Group 1</span>
   <span class="cm">All devices sizes</span>
   <span class="cm">========================================================================== */</span>

<span class="nc">.js</span> <span class="err">{</span>
    <span class="nt">body</span> <span class="err">{</span>
        <span class="na">background-color</span><span class="o">:</span> <span class="nb">red</span><span class="err">;</span>
    <span class="err">}</span>
<span class="err">}</span>
</pre></div>
</code></pre>
<p>…so group 1 is applied for all device sizes and we&#39;re saying all device sizes should see a red background colour.</p>
<pre><code class="lang-sass"><div class="highlight"><pre><span class="cm">/* =============================================================================</span>
   <span class="cm">Group 2</span>
   <span class="cm">Viewport &gt;= 400px</span>
   <span class="cm">========================================================================== */</span>

<span class="nc">.js</span> <span class="err">{</span>
    <span class="k">@include</span><span class="nd"> respond-min</span><span class="p">(</span><span class="nv">$mq-group2</span><span class="p">)</span> <span class="err">{</span>
        <span class="nt">body</span> <span class="err">{</span>
            <span class="na">background-color</span><span class="o">:</span> <span class="nb">yellow</span><span class="err">;</span>
        <span class="err">}</span>
    <span class="err">}</span>
<span class="err">}</span>
</pre></div>
</code></pre>
<p>All our other groups constrain their stylings using media queries (which we&#39;ve abstracted into a mixin) and use a variable to store a reference to the relevant break-point size.</p>
<p>You can see that the styles are constrained further by the <code>.js</code> class prefix and nesting the rest of the CSS/Sass inside of it.</p>
<p>In our group 2 we&#39;re overriding our previous groups styling by saying we want the background colour to be yellow for group 2 sized devices.</p>
<h4><a name="components" class="anchor" href="#components"><span class="header-link"></span></a>Components</h4>
<p>Our components work in a similar way to our groups… </p>
<ul>
<li>Set a base line style</li>
<li>Encapsulate styles within the component style sheet</li>
<li>Use media queries to apply changes to the component</li>
</ul>
<p>Here is an example component… </p>
<pre><code class="lang-sass"><div class="highlight"><pre><span class="cm">/* =============================================================================</span>
   <span class="cm">Component: Features &amp; Analysis</span>
   <span class="cm">Distinguishes featured content from standard content</span>
   <span class="cm">========================================================================== */</span>

<span class="err">[</span><span class="na">data-component</span><span class="o">=</span><span class="s2">&quot;features-and-analysis&quot;</span><span class="p">]</span> <span class="err">{</span>
    <span class="na">border</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nb">blue</span><span class="err">;</span>

    <span class="k">@include</span><span class="nd"> respond-min</span><span class="p">(</span><span class="nv">$mq-group2</span><span class="p">)</span> <span class="err">{</span>
        <span class="k">&amp;</span> <span class="err">{</span>
            <span class="na">border-color</span><span class="o">:</span> <span class="ni">pink</span><span class="err">;</span>

            <span class="nc">.media</span> <span class="err">{</span>
                <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="err">;</span>
                <span class="na">width</span><span class="o">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="kt">%</span><span class="err">;</span>
            <span class="err">}</span>
        <span class="err">}</span>
    <span class="err">}</span>

    <span class="k">@include</span><span class="nd"> respond-min</span><span class="p">(</span><span class="nv">$mq-group3</span><span class="p">)</span> <span class="err">{</span>
        <span class="k">&amp;</span> <span class="err">{</span>
            <span class="na">border-color</span><span class="o">:</span> <span class="nb">yellow</span><span class="err">;</span>

            <span class="nc">.media</span> <span class="err">{</span>
                <span class="na">width</span><span class="o">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="kt">%</span><span class="err">;</span>
            <span class="err">}</span>
        <span class="err">}</span>
    <span class="err">}</span>

    <span class="k">@include</span><span class="nd"> respond-min</span><span class="p">(</span><span class="nv">$mq-group4</span><span class="p">)</span> <span class="err">{</span>
        <span class="k">&amp;</span> <span class="err">{</span>
            <span class="na">border-color</span><span class="o">:</span> <span class="nb">red</span><span class="err">;</span>

            <span class="nc">.media</span> <span class="err">{</span>
                <span class="na">width</span><span class="o">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="kt">%</span><span class="err">;</span>
            <span class="err">}</span>
        <span class="err">}</span>
    <span class="err">}</span>
<span class="err">}</span>
</pre></div>
</code></pre>
<h4><a name="internet-explorer" class="anchor" href="#internet-explorer"><span class="header-link"></span></a>Internet Explorer</h4>
<p>So how do we encapsulate logic (read: bug fixes) for Internet Explorer? We use Sass to help us incorporate these IE specific fixes… </p>
<pre><code class="lang-sass"><div class="highlight"><pre><span class="err">[</span><span class="na">data-component</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span><span class="p">]</span> <span class="err">{</span>
    <span class="na">border</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nb">blue</span><span class="err">;</span>

    <span class="k">@include</span><span class="nd"> respond-min</span><span class="p">(</span><span class="nv">$mq-group2</span><span class="p">)</span> <span class="err">{</span>
        <span class="k">&amp;</span> <span class="err">{</span>
            <span class="na">border-color</span><span class="o">:</span> <span class="nb">green</span><span class="err">;</span>

            <span class="k">@include</span><span class="nd"> old-ie</span> <span class="err">{</span>
                <span class="na">border-width</span><span class="o">:</span> <span class="mi">2</span><span class="kt">px</span><span class="err">;</span>
            <span class="err">}</span>
        <span class="err">}</span>
    <span class="err">}</span>

    <span class="k">@include</span><span class="nd"> respond-min</span><span class="p">(</span><span class="nv">$mq-group3</span><span class="p">)</span> <span class="err">{</span>
        <span class="k">&amp;</span> <span class="err">{</span>
            <span class="na">border-color</span><span class="o">:</span> <span class="nb">yellow</span><span class="err">;</span>

            <span class="k">@include</span><span class="nd"> old-ie</span> <span class="err">{</span>
                <span class="na">border-width</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="err">;</span>
            <span class="err">}</span>
        <span class="err">}</span>
    <span class="err">}</span>

    <span class="k">@include</span><span class="nd"> respond-min</span><span class="p">(</span><span class="nv">$mq-group4</span><span class="p">)</span> <span class="err">{</span>
        <span class="k">&amp;</span> <span class="err">{</span>
            <span class="na">border-color</span><span class="o">:</span> <span class="nb">red</span><span class="err">;</span>

            <span class="k">@include</span><span class="nd"> old-ie</span> <span class="err">{</span>
                <span class="na">border-width</span><span class="o">:</span> <span class="mi">4</span><span class="kt">px</span><span class="err">;</span>
            <span class="err">}</span>
        <span class="err">}</span>
    <span class="err">}</span>
<span class="err">}</span>
</pre></div>
</code></pre>
<p>…in the above example you can see we have a <code>old-ie</code> mixin that applies a different style for Internet Explorer versions &lt;= 8. It&#39;s nested inside and the way the mixin works is when you compile this Sass code, if a variable (<code>$old-ie</code>) is set to <code>true</code> then the mixin will generate the relevant code.</p>
<p>So in our HTML page we have the following code… </p>
<pre><code class="lang-html"><div class="highlight"><pre><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;styles/project.css&quot;</span><span class="nt">&gt;</span>
<span class="c">&lt;!--[if lte IE 8]&gt;</span>
<span class="c">&lt;link rel=&quot;stylesheet&quot; href=&quot;styles/project-ie.css&quot;&gt;</span>
<span class="c">&lt;![endif]--&gt;</span>
</pre></div>
</code></pre>
<p>…as you can see we use a Microsoft Conditional Comment to load an additional style sheet just for IE versions less than or equal to 8.</p>
<p>The contents of the associated Sass file is… </p>
<pre><code class="lang-sass"><div class="highlight"><pre><span class="k">@import</span> <span class="s">&#39;partials/variables&#39;;</span>

<span class="na">$old-ie</span><span class="o">:</span> <span class="n-Pseudo">true</span><span class="err">;</span>
<span class="na">$fix-mqs</span><span class="o">:</span> <span class="nv">$mq-group4</span><span class="err">;</span>

<span class="k">@import</span> <span class="s">&#39;project&#39;;</span>
</pre></div>
</code></pre>
<p>…this Sass file will generate a <code>project-ie.css</code> file. It simply sets some variables and then imports our main <code>projects.scss</code> file. But when we import that file, the decision the Sass code makes (e.g. the <code>old-ie</code> mixin) will change as it relies on variables which we&#39;ve overwritten within <code>project-ie.css</code>.</p>
<p>Also, our media query mixin internally uses the variable <code>fix-mqs</code> and because IE &lt;=8 doesn&#39;t support media queries, we overwrite that variable value with a fix width (in this case we want old IE to load up our group 4 width, which is our desktop width).</p>
<h2><a name="conclusion" class="anchor" href="#conclusion"><span class="header-link"></span></a>Conclusion</h2>
<p>OK, so this was a quick run-through of my Stark project and its purpose might still not be totally clear to a lot of you at this point. But as I said from the start, I&#39;m not selling an all encompassing framework or set of tools that work &#39;out of the box&#39;. I&#39;m simply demonstrating a &#39;strategy&#39;, a way of working, thinking, and writing/structuring your front-end code.</p>
<p>I&#39;d love to hear your feedback and get your thoughts so <a href="http://twitter.com/integralist">contact me on twitter</a>, open up an discussion on <a href="https://github.com/Integralist/Stark">GitHub</a> (or better yet a Pull Request).</p>
</div>

  <div class="comments">
    <a href="/posts/stark-simplified-separation-of-components-into-decoupled-applications/#comments">
      <span class="icon-bubbles"></span>
      Comments
    </a>
  </div>

  <div class="post-head group">
  <a href="/posts/generate-application-cache-manifest-with-phantomjs/">
    <h1 class="post-title">Generate Application Cache Manifest with PhantomJS</h1>
  </a>
  <span class="post-date">2013 &#183; 8 &#183; 4</span>
</div>

<div class="post-body"><h2><a name="what-well-cover" class="anchor" href="#what-well-cover"><span class="header-link"></span></a>What we&#39;ll cover</h2>
<p><em>reading time: approx. 11mins</em></p>
<ul>
<li>What is PhantomJS?</li>
<li>Why use PhantomJS?</li>
<li>How can we use it?</li>
<li>Basic introduction</li>
<li>Let&#39;s break down Squirrel</li>
<li>Other PhantomJS features</li>
<li>Conclusion</li>
</ul>
<h2><a name="what-is-phantomjs" class="anchor" href="#what-is-phantomjs"><span class="header-link"></span></a>What is PhantomJS?</h2>
<p>To quote the source…</p>
<blockquote>
<p>PhantomJS is a headless WebKit scriptable with a JavaScript API. It has fast and native support for various web standards: DOM handling, CSS selector, JSON, Canvas, and SVG.</p>
</blockquote>
<h2><a name="why-use-phantomjs" class="anchor" href="#why-use-phantomjs"><span class="header-link"></span></a>Why use PhantomJS?</h2>
<p>So why do you care? Well, having a headless WebKit allows you to do all sorts of things. You can automate anything within a browser environment, and that&#39;s very cool!</p>
<p>So for example, I work for BBC News on the responsive code base and some of the very talented guys here have recently released an open-source project called <a href="https://github.com/BBC-News/wraith">Wraith</a> which is a front-end regression testing tool that lets you grab screen shot images of web pages at different dimensions (it&#39;s great for making sure your recent CSS commits or changes hasn&#39;t broken your site, it doesn&#39;t replace acceptance tests, unit tests or manual testing but it helps improve confidence). </p>
<p>In case you&#39;re wondering, the definition of &#39;wraith&#39; is…</p>
<blockquote>
<p>a ghost or ghostlike image of someone</p>
</blockquote>
<p>…see what we did there, Phantom… ghost… wraith… yeah?</p>
<p>But there are other spin-offs such as <a href="http://casperjs.org/">CasperJS</a> and <a href="https://github.com/jonleighton/poltergeist#poltergeist---a-phantomjs-driver-for-capybara">Poltergeist</a> both of which are named on a variation of the phantom theme but focus specifically on user/acceptance testing a user interface by allowing developers to interact with a web page programmatically.</p>
<h2><a name="how-can-we-use-it" class="anchor" href="#how-can-we-use-it"><span class="header-link"></span></a>How can we use it?</h2>
<p>We&#39;ll be using PhantomJS to help us interrogate a web page of the user&#39;s choice. It will check the network requests, store them and then generate a Application Cache manifest file based on the content of the web page.</p>
<p>So I wrote a small script that allows you to do this which I called <a href="https://github.com/integralist/squirrel">Squirrel</a> because you&#39;re storing away small pieces of information… like… nuts? Yeah I think you see where I&#39;m coming from.</p>
<p>This is very much a work in progress but the principles are there and it also demonstrates some different parts of PhantomJS that you might be interested in.</p>
<p>I won&#39;t go into the details of what the Application Cache does (or should do), I&#39;ll <a href="http://www.html5rocks.com/en/tutorials/appcache/beginner/">leave that to another</a>.</p>
<h2><a name="basic-introduction" class="anchor" href="#basic-introduction"><span class="header-link"></span></a>Basic introduction</h2>
<p>Here&#39;s a super quick introduction on how to use PhantomJS… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;webpage&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">(),</span>
    <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;http://www.phantomjs.org/&#39;</span><span class="p">;</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Page is loaded!</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>…here we load the PhantomJS <code>webpage</code> module, and call the <code>create()</code> method which instantiates a new web page.</p>
<p>We then call the <code>open()</code> method on this web page object and pass in the URL of the web page we want to open.</p>
<p>We then execute the <code>exit()</code> method on Phantom itself which tells the script that we&#39;re finished doing what we&#39;re doing.</p>
<p>That&#39;s it. Super simple run down of how to use PhantomJS.</p>
<h2><a name="lets-break-down-squirrel" class="anchor" href="#lets-break-down-squirrel"><span class="header-link"></span></a>Let&#39;s break down Squirrel</h2>
<p>OK, so let&#39;s review our Squirrel repo (specifically the <code>appcache.js</code> file).</p>
<p>The process of our script is as follows…</p>
<ol>
<li>Set-up variables and load specific modules</li>
<li>Set-up event listeners for resources requested, received and any errors detected.</li>
<li>In the <code>onResourceReceived</code> we check the <code>contentType</code> of the resource and if it falls into any of the categories we&#39;re interested in (image, style sheet, javascript) then we store it.</li>
<li>Check the URL provided by the user is in the required format.</li>
<li>If the URL is our example <code>bbc.co.uk/news</code> then set an additional cookie (required to load the Responsive version of BBC News site)</li>
<li>Open the URL specified by the user (the clean-up version).</li>
<li>Get a list of all anchors/links found in the web page.</li>
<li>Make sure we have a unique list of each resource type.</li>
<li>Call a function <code>populateManifest()</code> that will begin the process of populating our manifest file.</li>
<li>Exit our PhantomJS script.</li>
</ol>
<h3><a name="set-up" class="anchor" href="#set-up"><span class="header-link"></span></a>Set-up</h3>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">_</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash&#39;</span><span class="p">),</span>
    <span class="nx">system</span>     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">),</span>
    <span class="nx">fs</span>         <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
    <span class="nx">page</span>       <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;webpage&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">(),</span>
    <span class="nx">args</span>       <span class="o">=</span> <span class="nx">system</span><span class="p">.</span><span class="nx">args</span><span class="p">,</span>
    <span class="nx">path</span>       <span class="o">=</span> <span class="s1">&#39;./appcache.manifest&#39;</span><span class="p">,</span>
    <span class="nx">manifest</span>   <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span>
    <span class="nx">css</span>        <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">jpgs</span>       <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">pngs</span>       <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">gifs</span>       <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">images</span>     <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">javascript</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">links</span><span class="p">,</span> <span class="nx">url</span><span class="p">;</span>
</pre></div>
</code></pre>
<p>…OK so this looks a bit ugly but this long list of variables is basically us loading the Lo-Dash utility library, the Node file system, the PhantomJS web page module and then grabbing any arguments passed via the command line and reading the content of our manifest file.</p>
<p>You might be wondering about the long list of empty Arrays, well we have to set each variable to an empty Array because Arrays are a reference type object which means if we did <code>var css = jpgs = pngs = gifs = images = javascript = [];</code> then although we&#39;d end up with shorter code (a one liner) it means that we&#39;re not getting a unique Array for each variable but sharing a single Array instance (which isn&#39;t what we want).</p>
<h3><a name="functions" class="anchor" href="#functions"><span class="header-link"></span></a>Functions</h3>
<p>We have a whole group of functions that carry out different things for us, so we&#39;ll just quickly scan over them…</p>
<ul>
<li><p><code>getLinks</code> uses the PhantomJS&#39; <code>evaluate</code> method on the web page object (which lets you parse the open web page using JavaScript, meaning you run JavaScript code within the context of the open web page).</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">getLinks</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">item</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
      <span class="p">});</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
</li>
<li><p><code>populateManifest</code> is called next but this just delegates calls to the following other functions.</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">populateManifest</span><span class="p">(){</span>
  <span class="nx">writeVersion</span><span class="p">();</span>

  <span class="nx">writeListContentFor</span><span class="p">(</span><span class="s1">&#39;Images&#39;</span><span class="p">,</span> <span class="nx">images</span><span class="p">);</span>
  <span class="nx">writeListContentFor</span><span class="p">(</span><span class="s1">&#39;Internal HTML documents&#39;</span><span class="p">,</span> <span class="nx">links</span><span class="p">);</span>
  <span class="nx">writeListContentFor</span><span class="p">(</span><span class="s1">&#39;Style Sheets&#39;</span><span class="p">,</span> <span class="nx">css</span><span class="p">);</span>
  <span class="nx">writeListContentFor</span><span class="p">(</span><span class="s1">&#39;JavaScript&#39;</span><span class="p">,</span> <span class="nx">javascript</span><span class="p">);</span>

  <span class="nx">writeManifest</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</code></pre>
</li>
<li><code>writeVersion</code> replaces the current time stamp within our manifest file (we&#39;re doing this in memory, not saving the change back to the manifest file yet).<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">writeVersion</span><span class="p">(){</span>
  <span class="nx">manifest</span> <span class="o">=</span> <span class="nx">manifest</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/# Timestamp: \d+/i</span><span class="p">,</span> <span class="s1">&#39;# Timestamp: &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</code></pre>
</li>
<li><code>writeListContentFor</code> is called multiple times and is just an abstraction for a common pattern of code which looks through the manifest file content for &#39;hooks&#39; and then replace the content found with the updated content that we&#39;ve parsed from the page as it was loading (e.g. the event listener we set-up for <code>onResourceReceived</code> which checked the <code>contentType</code> of the resource being loaded).<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">writeListContentFor</span> <span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">manifest</span> <span class="o">=</span> <span class="nx">manifest</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;(# &#39;</span> <span class="o">+</span> <span class="nx">str</span> <span class="o">+</span> <span class="s1">&#39;)\\n[\\s\\S]+?\\n\\n&#39;</span><span class="p">,</span> <span class="s1">&#39;igm&#39;</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">cg</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">cg</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;\n\n&#39;</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</code></pre>
</li>
<li><code>writeManifest</code> opens up our original manifest file using Node&#39;s file system module and writes over the content with the new content string we&#39;ve constructed in the <code>manifest</code> variable.<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">writeManifest</span><span class="p">(){</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">manifest</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
</li>
<li><code>urlProvided</code> just checks to make sure an argument was provided by the user on the command line.<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">urlProvided</span><span class="p">(){</span>
  <span class="k">return</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="sr">/(?:www\.)?[a-z-z1-9]+\./i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
</li>
<li><code>cleanUrl</code> takes in a URL and formats it so it doesn&#39;t break PhantomJS<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">cleanUrl</span> <span class="p">(</span><span class="nx">providedUrl</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// If no http or https found at the start of the url...</span>
  <span class="k">if</span> <span class="p">(</span><span class="sr">/^(?!https?:\/\/)[\w\d]/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">providedUrl</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="nx">providedUrl</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</code></pre>
</li>
<li><code>bbcNews</code> checks to see if the URL is for the BBC News site (if it is then later on we&#39;ll do something specific for that scenario). It&#39;s not essential for the script to work, just something specific I wanted to demonstrate.<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">bbcNews</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">(</span><span class="sr">/bbc.co.uk\/news/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</code></pre>
</li>
</ul>
<h3><a name="checking-resources-that-are-loaded" class="anchor" href="#checking-resources-that-are-loaded"><span class="header-link"></span></a>Checking resources that are loaded</h3>
<p>The following is our event handler that checks the content type of the resource being loaded and stores it in the relevant Array.</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">page</span><span class="p">.</span><span class="nx">onResourceReceived</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Some requests can have `contentType = null` which causes errors if we don&#39;t check for truthy value</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">contentType</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;text/css&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">css</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// application/javascript &amp; application/x-javascript</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;javascript&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">javascript</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;image/png&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;data:image&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">pngs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;image/jpeg&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;data:image&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">jpgs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;image/gif&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;data:image&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">gifs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</code></pre>
<p>To be honest we don&#39;t need to separate the content types out into jpg, gif and png. We could just have an images Array that holds them all - it would be cleaner and more efficient code, something like...</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">page</span><span class="p">.</span><span class="nx">onResourceReceived</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">contentType</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;text/css&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">css</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;javascript&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">javascript</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="sr">/image\/(?:png|jpeg|gif)/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">contentType</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;data:image&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">images</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</code></pre>
<h3><a name="checking-for-errors" class="anchor" href="#checking-for-errors"><span class="header-link"></span></a>Checking for errors</h3>
<p>This should be self explanatory, but basically it checks for any errors that happen while the page is loading and displays them for the user… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">page</span><span class="p">.</span><span class="nx">onError</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">trace</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>

    <span class="nx">trace</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">file</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<h3><a name="ensure-url-is-provided" class="anchor" href="#ensure-url-is-provided"><span class="header-link"></span></a>Ensure URL is provided</h3>
<p>Following conditional makes sure that a URL was provided by the user from the command line and if not it displays appropriate feedback to the user to let them know what they should be doing… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">urlProvided</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">url</span> <span class="o">=</span> <span class="nx">cleanUrl</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Sorry a valid URL should have been provided&#39;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Example usage: phantomjs appcache.js bbc.co.uk/news&#39;</span><span class="p">);</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<h3><a name="setting-custom-headers" class="anchor" href="#setting-custom-headers"><span class="header-link"></span></a>Setting custom headers</h3>
<p>The following code isn&#39;t needed for our Squirrel repo to do its job, I just stuck it in to demonstrate how you could use an interesting feature of PhantomJS which is to set cookies.</p>
<p>Here we check if the URL being requested is BBC News and if so I want the user to load up the responsive code base version of the site, and to do that we need to set a cookie for the page to know to load that version of the page… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">bbcNews</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// We want to serve up the responsive code base...</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">addCookie</span><span class="p">({</span>
        <span class="s1">&#39;name&#39;</span>  <span class="o">:</span> <span class="s1">&#39;ckps_d&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span> <span class="o">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
        <span class="s1">&#39;domain&#39;</span><span class="o">:</span> <span class="s1">&#39;.bbc.co.uk&#39;</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<h3><a name="the-main-star-of-the-show" class="anchor" href="#the-main-star-of-the-show"><span class="header-link"></span></a>The main star of the show</h3>
<p>Here is the fundamental piece of the puzzle, the call to open the web page specified by the user and which once the page has loaded then parses the page for the information we&#39;re interested in…  </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">links</span> <span class="o">=</span> <span class="nx">getLinks</span><span class="p">();</span>

    <span class="nx">links</span>      <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">unique</span><span class="p">(</span><span class="nx">links</span><span class="p">);</span>
    <span class="nx">images</span>     <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">unique</span><span class="p">(</span><span class="nx">pngs</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">jpgs</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">gifs</span><span class="p">));</span>
    <span class="nx">css</span>        <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">unique</span><span class="p">(</span><span class="nx">css</span><span class="p">);</span>
    <span class="nx">javascript</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">unique</span><span class="p">(</span><span class="nx">javascript</span><span class="p">);</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;links: &#39;</span><span class="p">,</span> <span class="nx">links</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;images: &#39;</span><span class="p">,</span> <span class="nx">images</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;css: &#39;</span><span class="p">,</span> <span class="nx">css</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;javascript: &#39;</span><span class="p">,</span> <span class="nx">javascript</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

    <span class="nx">populateManifest</span><span class="p">();</span>

    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>…PhantomJS passes us a status string as an argument to the callback function and which tells us if the page loaded successfully or not.</p>
<p>After we&#39;ve called our main <code>populateManifest()</code> method we then tell PhantomJS to stop (<code>phantom.exit()</code>).</p>
<h2><a name="example-usage" class="anchor" href="#example-usage"><span class="header-link"></span></a>Example usage</h2>
<p>So how do we use this script? Well, once you&#39;ve cloned down the repo and followed the installation instructions you simply jump inside our cloned directory and run something like:</p>
<p><code>phantomjs appcache.js bbc.co.uk/news</code></p>
<h2><a name="other-phantomjs-features" class="anchor" href="#other-phantomjs-features"><span class="header-link"></span></a>Other PhantomJS features</h2>
<p>Here follows are a quick run down of some other features available to you when using PhantomJS, just check the <a href="https://github.com/ariya/phantomjs/wiki/API-Reference">PhantomJS API</a> for full details.</p>
<ul>
<li>Custom Headers</li>
<li>Remote Debugging</li>
<li>View Port Sizing</li>
</ul>
<h3><a name="custom-headers" class="anchor" href="#custom-headers"><span class="header-link"></span></a>Custom Headers</h3>
<p>For BBC News I wrote a similar script, but because I was interrogating a local development URL which uses test data I had to set some additional headers to get the page to load live data…</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">page</span><span class="p">.</span><span class="nx">customHeaders</span> <span class="o">=</span> <span class="p">{</span> 
    <span class="s1">&#39;X-Candy-Override&#39;</span><span class="o">:</span> <span class="s1">&#39;https://api.live.bbc.co.uk&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X-Compiled-Js&#39;</span>   <span class="o">:</span> <span class="s1">&#39;true&#39;</span>
<span class="p">};</span>
</pre></div>
</code></pre>
<h3><a name="remote-debugging" class="anchor" href="#remote-debugging"><span class="header-link"></span></a>Remote Debugging</h3>
<p>You can remote debug your code by executing your code with a debug flag <code>phantomjs --remote-debugger-port=9000 appcache.js [url]</code>, you can then open up Chrome or Safari and access the debugger via <code>http://127.0.0.1:9000/</code></p>
<h3><a name="view-port-size" class="anchor" href="#view-port-size"><span class="header-link"></span></a>View Port Size</h3>
<p>You can change the dimensions of the page being loaded using the <code>viewportSize</code> property (this is used in the <a href="http://github.com/BBC-News/wraith/">Wraith</a> open-source project released by BBC News)… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">page</span><span class="p">.</span><span class="nx">viewportSize</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">width</span><span class="o">:</span> <span class="mi">320</span><span class="p">,</span> <span class="nx">height</span><span class="o">:</span> <span class="mi">480</span> <span class="p">};</span>
</pre></div>
</code></pre>
<h2><a name="conclusion" class="anchor" href="#conclusion"><span class="header-link"></span></a>Conclusion</h2>
<p>Hopefully this introduction to PhantomJS was useful. The Squirrel repo is still a work in progress so feel free to open up an issue (or better yet a pull request) on GitHub if you find any problems.</p>
<p>I&#39;ll likely follow up this article at some point in the future with one about using CasperJS so keep your eyes peeled for that.</p>
<p>Any other feedback then catch me on <a href="http://twitter.com/integralist">twitter</a>.</p>
</div>

  <div class="comments">
    <a href="/posts/generate-application-cache-manifest-with-phantomjs/#comments">
      <span class="icon-bubbles"></span>
      Comments
    </a>
  </div>


<div class="pagination group">
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
      <a href="/page/5/" class="newer"> Newer &#8594;</a>
    
  
    
    
  
    
    
      <a href="/page/7/" class="older"> &#8592; Older</a>
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
</div>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js" type="text/javascript"></script>
    <script src="/scripts/main.js" type="text/javascript"></script>
    <script src="/scripts/Imager.js" type="text/javascript"></script>
    <script>
        var _gaq=[['_setAccount','UA-33159515-1'],['_trackPageview']];
        (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
        g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>
  </body>
</html>

