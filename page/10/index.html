<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/images/cabin.png" >
    <link href="/styles/main.css" rel="stylesheet">
    
    <title>Integralist -> BBC News Engineer</title>
    
    
    <link rel="alternate" type="application/atom+xml" title="Integralist" href="http://feeds.feedburner.com/Integralist">
  </head>
  <body>
    <nav>
      <h1 class="name">
          <a href="/">Integralist</a> <span class="role">BBC News Engineer</span>
      </h1>
      <div class="menu icon-menu"></div>
      <ul class="nav-links">
        <li class="text-link">
          <a href="/about.html">about</a>
        </li>
        <li class="text-link">
          <a href="/projects.html">projects</a>
        </li>
        <li class="text-link">
          <a href="/archives.html">archives</a>
        </li>
      </ul>
      <div class="social-media">
        <a href="https://github.com/integralist" class="icon-github"></a>
        <a href="https://twitter.com/integralist" class="icon-twitter"></a>
      </div>
    </nav>
    <div class="content">


  <div class="post-head group">
  <a href="/posts/ruby-and-the-sinatra-framework/">
    <h1 class="post-title">Ruby and the Sinatra framework</h1>
  </a>
  <span class="post-date">2012 &#183; 7 &#183; 22</span>
</div>

<div class="post-body"><h2><a name="what-we-ll-cover"class="anchor" href="#what-we-ll-cover"><span class="header-link"></span></a>What we&#39;ll cover</h2>
<p><em>reading time: approx. 23mins</em></p>
<ul>
<li>Introduction<ul>
<li>DSL vs GPL</li>
</ul>
</li>
<li>GitHub Repository</li>
<li>Sinatra</li>
<li>Hosting</li>
<li>Example<ul>
<li>Requirements</li>
<li>Set-up</li>
<li>Shotgun</li>
<li>Loading pages</li>
<li>Loading templates</li>
<li>Static resources</li>
<li>Handling errors</li>
<li>Performance</li>
<li>Hosting our application</li>
</ul>
</li>
<li>Conclusions</li>
</ul>
<h2><a name="introduction"class="anchor" href="#introduction"><span class="header-link"></span></a>Introduction</h2>
<p>In my opinion there&#39;s isn&#39;t enough good information on the web about how to get started building a <a href="http://www.ruby-lang.org/" title="The Ruby Programming Language">Ruby</a> based website (unless you want to use the ever popular <a href="http://rubyonrails.org/" title="Ruby on Rails">Ruby on Rails</a> framework). </p>
<p>But even then, it&#39;s not as straight forward as you&#39;d think (not for someone new to the language or server-side coding in general).</p>
<h3><a name="dsl-vs-gpl"class="anchor" href="#dsl-vs-gpl"><span class="header-link"></span></a>DSL vs GPL</h3>
<p>Before we go any further, it&#39;s worth clarifying the difference between a Domain Specific Language (DSL) and a General Purpose Language (GPL). Languages like JavaScript and PHP are DSL&#39;s** because they were designed to be run within a specific &#39;domain&#39; (and by domain we really mean &#39;environment&#39;) such as the web. But languages like Python and Ruby are GPL&#39;s because they can run within many different domains (e.g. Ruby can run on the web, desktop, command line etc).</p>
<p>If we look at a DSL language such as <a href="http://www.php.net/" title="PHP Hypertext Preprocessor">PHP</a>**: it is very easy to build a site using PHP because you can just input some procedural code, upload the file onto a server that supports PHP (and what server doesn&#39;t nowadays) and that&#39;s all there is to it (!now I&#39;m obviously not suggesting this is good practice - I&#39;m just illustrating the point that if you wanted to <strong>just get started</strong> with PHP then that is all there is to it).</p>
<p>With a GPL such as Ruby it isn&#39;t so straight forward (it&#39;s like the old adage &quot;the question is easy when you know the answer&quot;: Ruby can be easy to use and get set-up when you know what you&#39;re doing, but the fundamentals - in my opinion - are difficult to grasp without a helping hand).</p>
<p><em>**PHP (and JavaScript) were designed to be DSL&#39;s but have since evolved more into GPL&#39;s as they can be run on the desktop as well as the web (and many other environments they weren&#39;t originally designed for).</em></p>
<p>My issue with Ruby is that there is no &quot;just get started&quot; guide for those who want to build a site with it but not have to deal with design patterns such as MVC (maybe not straight away at least). I wouldn&#39;t be surprised if developers new to Ruby felt obliged to use Ruby on Rails because it seems to be the only Ruby related framework out there that gets any real spotlight - and I understand why, because it truly is an all encompassing framework - but I wanted a Ruby site without the bloat of a framework like <a href="http://rubyonrails.org/" title="Ruby on Rails">Ruby on Rails</a>. I didn&#39;t want all the confusing MVC structure and features that I&#39;d never use. Hence why I&#39;m writing this now.</p>
<h2><a name="github-repository"class="anchor" href="#github-repository"><span class="header-link"></span></a>GitHub Repository</h2>
<p>You can find an example repository with all code discussed in this article here: <a href="https://github.com/Integralist/passage"><a href="https://github.com/Integralist/passage">https://github.com/Integralist/passage</a></a></p>
<h2><a name="sinatra"class="anchor" href="#sinatra"><span class="header-link"></span></a>Sinatra</h2>
<p>So, let me begin by introducing you to <a href="http://www.sinatrarb.com/" title="Put this in your pipe and smoke it">Sinatra</a>. Sinatra is a micro web framework for Ruby that although small (much smaller than a framework such as Ruby on Rails) is still surprising complex and powerful (I&#39;d highly recommend reading O&#39;Reilly&#39;s book &quot;<a href="http://shop.oreilly.com/product/0636920019664.do" title="Ruby for the Web">Sinatra: Up and Running</a>&quot;).</p>
<p>Sinatra does require you to do a lot of work off your own back, but at the same time it doesn&#39;t enforce a particular style on you. It&#39;s also very easy to get a site up and running with Sinatra and that is hopefully what I&#39;ll demonstrate here today.</p>
<h2><a name="hosting"class="anchor" href="#hosting"><span class="header-link"></span></a>Hosting</h2>
<p>Now running a site locally on your computer is one thing, but you want to be able to share it with the community and let others use it! Ruby hosting is something I&#39;m still looking into but I have found two popular options for those who aren&#39;t willing to put their money where their mouth is just yet (e.g. developers who are just experimenting with Ruby to see if it&#39;ll work for them). These are:</p>
<ul>
<li><a href="http://www.heroku.com/" title="Cloud Application Platform">Heroku</a></li>
<li><a href="https://openshift.redhat.com/app/" title="Develop and Scale Apps in the Cloud">OpenShift</a></li>
</ul>
<p>OpenShift is a relative newcomer to the hosting arena and currently is free (although paid for plans are likely to be introduced soon).</p>
<p>Heroku is one of the most well known and talked about Ruby web hosts and offers both free and paid for options.</p>
<p>This means we can use either one to host our application for free and so allow us to test their services, and if you discover your latest web creation is doing well and getting lots of traffic then these platforms can scale to meet your needs.</p>
<p>For today we&#39;ll be using the first option Heroku, but we&#39;ll come back to the hosting aspect at the end of this article when we&#39;re ready to actually upload our test application.</p>
<h2><a name="example"class="anchor" href="#example"><span class="header-link"></span></a>Example</h2>
<h3><a name="requirements"class="anchor" href="#requirements"><span class="header-link"></span></a>Requirements</h3>
<p>OK, for us to build our application we&#39;re going to need to install the following software...</p>
<ul>
<li>Ruby (Programming Language - see my <a href="https://github.com/Integralist/Blog-Posts/blob/master/Introduction-to-Ruby.md" title="Introduction to Ruby (a front-end developers perspective)">introduction to the Ruby language</a> for more information on how to do this)</li>
<li>Sinatra (Web Framework)</li>
<li>Bundler (Dependancy Manager)</li>
<li>Shotgun (Utility)</li>
<li>Thin (Web Server)</li>
</ul>
<p>When Ruby is installed it provides you with a tool called &#39;gems&#39;. It is a list of code based projects and each one is referred to as a &#39;gem&#39;. These gems are actually hosted publically on <a href="http://rubygems.org/" title="Your community gem host"><a href="http://rubygems.org/">http://rubygems.org/</a></a>. If you ever need a piece of functionality that you don&#39;t fancy writing yourself then you can search for a &#39;gem&#39; that has already been built and download it, and then use it within your application.</p>
<p>For example, you could be looking for a way to send email from your Ruby application. You would then search the Ruby Gems site (or you can do it via the command line) for a gem that provides this functionality. In this instance you would probably find the gem <code>Pony</code> which does exactly this and can be installed simply by running the command <code>gem install pony</code>.</p>
<p>So, with this new knowledge about <code>gems</code> let us start downloading the above software. Start by opening your CLI (Command Line Interface) tool of choice. I&#39;m on a Macintosh so by default that will be the Terminal app. </p>
<p>All we need to do is to execute the following command <code>gem install name_of_gem</code>...</p>
<ul>
<li>Sinatra: <code>gem install sinatra</code></li>
<li>Bundler: <code>gem install bundler</code></li>
<li>Shotgun: <code>gem install shotgun</code></li>
<li>Thin: <code>gem install thin</code></li>
</ul>
<p>To see what &#39;gems&#39; you have already installed you can run the command <code>gem list --local</code> and this will display something similar to this (which is what I have installed on my own machine currently)…</p>
<pre><code class="lang-sh"><div class="highlight"><pre>bundler <span class="o">(</span>1.1.3<span class="o">)</span>
cgi_multipart_eof_fix <span class="o">(</span>2.5.0<span class="o">)</span>
daemons <span class="o">(</span>1.1.8<span class="o">)</span>
eventmachine <span class="o">(</span>0.12.10<span class="o">)</span>
fastthread <span class="o">(</span>1.0.7<span class="o">)</span>
gem_plugin <span class="o">(</span>0.2.3<span class="o">)</span>
i18n <span class="o">(</span>0.6.0<span class="o">)</span>
mail <span class="o">(</span>2.4.4<span class="o">)</span>
mime-types <span class="o">(</span>1.18<span class="o">)</span>
polyglot <span class="o">(</span>0.3.3<span class="o">)</span>
pony <span class="o">(</span>1.4<span class="o">)</span>
rack <span class="o">(</span>1.4.1<span class="o">)</span>
rack-protection <span class="o">(</span>1.2.0<span class="o">)</span>
rake <span class="o">(</span>0.9.2.2, 0.9.2<span class="o">)</span>
rubygems-bundler <span class="o">(</span>0.3.0, 0.2.8<span class="o">)</span>
sass <span class="o">(</span>3.1.17<span class="o">)</span>
shotgun <span class="o">(</span>0.9<span class="o">)</span>
sinatra <span class="o">(</span>1.3.2<span class="o">)</span>
thin <span class="o">(</span>1.3.1<span class="o">)</span>
tilt <span class="o">(</span>1.3.3<span class="o">)</span>
treetop <span class="o">(</span>1.4.10<span class="o">)</span>
</pre></div>
</code></pre>
<h3><a name="set-up"class="anchor" href="#set-up"><span class="header-link"></span></a>Set-up</h3>
<p>Now we have our software set-up, lets open our programming tool of choice and start writing some code.</p>
<p>First thing we want to do is to create a file that will be our application. So lets go ahead and do that and call it <code>app.rb</code> and lets add the following content to it…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="c1">#!/usr/bin/env ruby</span>

<span class="nb">require</span> <span class="s1">&#39;sinatra&#39;</span>

<span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
    <span class="s2">&quot;Hello World!&quot;</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>…now open your CLI, direct yourself to the folder where the above file is located and run <code>ruby app.rb</code>.</p>
<p>You should see a message similar to this…</p>
<pre><code class="lang-sh"><div class="highlight"><pre><span class="o">==</span> Sinatra/1.3.2 has taken the stage on 4567 <span class="k">for </span>development with backup from Thin
&gt;&gt; Thin web server <span class="o">(</span>v1.3.1 codename Triple Espresso<span class="o">)</span>
&gt;&gt; Maximum connections <span class="nb">set </span>to 1024
&gt;&gt; Listening on 0.0.0.0:4567, CTRL+C to stop
</pre></div>
</code></pre>
<p>You should now be able to open your web browser and go to: <code>http://localhost:4567/</code> and see the message &quot;Hello World!&quot;</p>
<p>If you can then OK, this is our app, good job!</p>
<p>Lets quickly recap what we&#39;ve got in our file:</p>
<ul>
<li><p><code>#!/usr/bin/env ruby</code><br>The first line tells the interpreter that&#39;s trying to run this file that we should interpret this file as a Ruby application.</p>
</li>
<li><p><code>require &#39;sinatra&#39;</code><br>Here we&#39;re loading in the Sinatra framework ready for us to use.</p>
</li>
<li><p><code>get &#39;/&#39; do &quot;Hello World!&quot; end</code><br>This is Sinatra&#39;s &quot;Classic&quot;** DSL syntax which basically says when someone loads the home page show them the message &quot;Hello World!&quot;.</p>
</li>
</ul>
<p><em>**There are two ways to build Sinatra applications: one is the &quot;Classic&quot; way (which we&#39;ll be doing as it&#39;s much easier to understand) and the other is the &quot;Modular&quot; way which doesn&#39;t use the DSL syntax and taps straight into the base Sinatra Class.</em></p>
<h3><a name="shotgun"class="anchor" href="#shotgun"><span class="header-link"></span></a>Shotgun</h3>
<p>One quick note about running your Ruby application: we used <code>ruby app.rb</code> but for development purposes we want to use our <code>shotgun</code> utility instead. </p>
<p>What <code>shotgun</code> does is it restarts the web server for every HTTP request it receives. This is only useful for local development, you wouldn&#39;t do this on a live server as that would just be wasting resources. The reason we use <code>shotgun</code> is because otherwise if we&#39;re running our application using <code>ruby app.rb</code> and decide to make a tweak to our code then we wouldn&#39;t be able to see the change until we restarted the web server! So we&#39;d have to first stop Sinatra (<code>Ctrl+C</code>) and then start it back up again (<code>ruby app.rb</code>) and that&#39;s a lot of hassle when you&#39;re making changes every few seconds and checking them in your web browser. So <code>shotgun</code> helps workaround this issue (while we&#39;re in development). Just run: <code>shotgun app.rb</code> and it&#39;ll take care of the rest**.</p>
<p><em>**One thing I&#39;ve noticed using <code>shotgun</code> is that it can affect other resources. For example, I was caching resources and for some reason when running <code>shotgun</code> I noticed the resources weren&#39;t being cached - but if I shut it down and run <code>ruby app.rb</code> instead then the resources would show as cached? Apparently it has something to do with the internals of how <code>shotgun</code> works and is something to be aware of if you notice something not working then just try running your Ruby application without <code>shotgun</code>.</em></p>
<p>So at this point you&#39;ve got some Ruby code and you&#39;re able to view it in a web browser. Now lets look further at Sinatra&#39;s DSL syntax...</p>
<h3><a name="loading-pages"class="anchor" href="#loading-pages"><span class="header-link"></span></a>Loading pages</h3>
<p>If you wanted to add a new page called &quot;Projects&quot; that you accessed via <code>http://localhost:4567/projects</code> then all you would need to do is add the following code…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">get</span> <span class="s1">&#39;/projects&#39;</span> <span class="k">do</span>
    <span class="c1"># page content</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>What we&#39;ve done is created a new &#39;route&#39; - a new way for a user to access your application.</p>
<p>Imagine now that this &#39;projects&#39; page had a login form on it that let the user enter a username and password and this form POST&#39;ed the data entered by the user back to the current page...</p>
<pre><code class="lang-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;dl&gt;</span>
        <span class="nt">&lt;dt&gt;</span>Name<span class="nt">&lt;/dt&gt;</span>
        <span class="nt">&lt;dd&gt;&lt;input</span> <span class="na">name=</span><span class="s">&quot;user&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;&lt;/dd&gt;</span>
        <span class="nt">&lt;dt&gt;</span>Email<span class="nt">&lt;/dt&gt;</span>
        <span class="nt">&lt;dd&gt;&lt;input</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;&lt;/dd&gt;</span>
    <span class="nt">&lt;/dl&gt;</span>
    <span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Send&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</code></pre>
<p>...for you to access the POST&#39;ed data then you would need to add another &#39;route&#39; to handle it. But this time instead of using a <code>get</code> request it would be a <code>post</code> request like so…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">post</span> <span class="s1">&#39;/projects&#39;</span> <span class="k">do</span>
    <span class="c1"># do something with the form fields</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span>
    <span class="n">pass</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>…you&#39;ll notice that the form data is passed to the block using special parameters called <code>params</code>. So in the above example we had two form fields with the names <code>user</code> and <code>password</code> and we&#39;re assigning their values to the variables <code>user</code> and <code>pass</code> where we can now do validation on the values.</p>
<p>You can also use the URL path as a way for the user to interact with your application. For example if you had a page which added two numbers together then it could be handled directly via the URL as follows…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">get</span> <span class="s1">&#39;/add/:a/:b&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">a</span><span class="o">.</span><span class="n">to_i</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">to_i</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>…this would display on the page the result of adding <code>a</code> and <code>b</code> together. So if I went to the URL <code>http://localhost:4567/add/2/2</code> then this would display <code>4</code> as that would be the result of <code>2 + 2</code> (which was the two parameters I specified within the URL).</p>
<h3><a name="loading-templates"class="anchor" href="#loading-templates"><span class="header-link"></span></a>Loading templates</h3>
<p>Now at the moment we&#39;re using the fact that with Ruby, the last expression inside a function is what gets returned from that function. These calls to <code>get</code> and <code>post</code> are actually function calls hidden behind an abstraction. So in my original example we were displaying &quot;Hello World!&quot; to the page because that was the last expression inside the <code>get</code> call.</p>
<p>But we ideally want to be displaying HTML to the user! To do this we&#39;ll use &#39;templates&#39;.</p>
<p>Note that templates can be inlined inside your Ruby code, but personally I prefer them to be external because I think that&#39;s a lot cleaner and abides by the &#39;separate of concerns&#39; rule (which I like to keep to whenever possible).</p>
<p>Our code is going to start looking something like this…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
    <span class="n">erb</span> <span class="ss">:home</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">&#39;/projects&#39;</span> <span class="k">do</span>
    <span class="n">erb</span> <span class="ss">:projects</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>…what this is doing is using ERB (which stands for &#39;Embedded Ruby&#39;) and is the standard templating language available in Ruby - although there are many templating languages you could load and use in its place. What we&#39;ve said here in our code is load the <code>:home</code> template (.erb file) when on the home page, and load the <code>:project</code> template (.erb file) when on the projects page.</p>
<p>By default Sinatra looks for templates inside of a root folder called <code>views</code> (you can change this if you want but I didn&#39;t bother as <code>views</code> made the most sense for a folder containing &#39;templates&#39;).</p>
<p>Inside our <code>views</code> folder we&#39;ll need to create two files then: <code>home.erb</code> and <code>projects.erb</code> and they&#39;ll look a little bit like this…</p>
<pre><code class="lang-html"><div class="highlight"><pre><span class="c">&lt;!-- home.erb --&gt;</span>
<span class="nt">&lt;p&gt;</span>HTML content for my home page<span class="nt">&lt;/p&gt;</span>

<span class="c">&lt;!-- projects.erb --&gt;</span>
<span class="nt">&lt;p&gt;</span>HTML content for my projects page<span class="nt">&lt;/p&gt;</span>
</pre></div>
</code></pre>
<p>Now this doesn&#39;t look like much of a HTML page, and that&#39;s because I&#39;m using (or I&#39;m going to be using very shortly) what Sinatra refers to as a main layout file and this &#39;layout&#39; file will contain the rest of my HTML code and will be wrapped around my above templates. </p>
<p>What this means is I can have a &#39;master&#39; HTML file that stays the same for every page and I can load my templates into that master layout. This is done by creating a <code>layout.erb</code> file (also within the <code>views</code> folder). If Sinatra finds a <code>layout.erb</code> file it will automatically use it as a master layout for all your templates.</p>
<p>But if I didn&#39;t create a <code>layout.erb</code> file then I could have modified my templates above to include a full set of HTML like so…</p>
<pre><code class="lang-html"><div class="highlight"><pre><span class="c">&lt;!-- home.erb --&gt;</span>
<span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>My Page<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
       <span class="nt">&lt;p&gt;</span>HTML content for my home page<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</code></pre>
<p>…but I prefer having a master layout to handle this stuff, so lets create a <code>layout.erb</code> file (within the <code>views</code> folder) and add the following content to it…</p>
<pre><code class="lang-erb"><div class="highlight"><pre><span class="x">&lt;!-- layout.erb --&gt;</span>
<span class="x">&lt;!doctype html&gt;</span>
<span class="x">&lt;html&gt;</span>
<span class="x">    &lt;head&gt;</span>
<span class="x">        &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="x">        &lt;title&gt;My Page&lt;/title&gt;</span>
<span class="x">    &lt;/head&gt;</span>
<span class="x">    &lt;body&gt;</span>
<span class="x">       </span><span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    &lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</pre></div>
</code></pre>
<p>…you should notice the Ruby tags <code>&lt;% %&gt;</code> which are used to place Ruby code inside of them. Here we&#39;re telling Ruby to <code>yield</code> to the template file we&#39;re loading. So for example when a user accesses the home page and we load <code>home.erb</code>, we&#39;re effectively loading the <code>layout.erb</code> file and telling it that when it reaches the <code>body</code> tag we want it to load in the content from the <code>home.erb</code> file into it so it will end up rendering in the web browser like this…</p>
<pre><code class="lang-html"><div class="highlight"><pre><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>My Page<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
       <span class="nt">&lt;p&gt;</span>HTML content for my home page<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</code></pre>
<p>If you want to load a different master layout for a specific page then you can do that also. For example I have a page that I display to users of Internet Explorer version 7 or lower. The master layout for that page is a lot simpler than the other pages of my site in that it loads different stylesheets specifically for this IE page. So in my application file I have the following…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">get</span> <span class="s1">&#39;/internet-explorer&#39;</span> <span class="k">do</span>
    <span class="n">erb</span> <span class="ss">:ie</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="ss">:layout_ie</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>…and what you can see here is that I&#39;m not only telling Sinatra to load the <code>ie.erb</code> file but to also use the <code>layout_ie.erb</code> file as the master layout file for this page rather than the default <code>layout.erb</code>.</p>
<p>One other thing worth mentioning is that you can pass variables from your route block into your template using class instance variables…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">post</span> <span class="s1">&#39;/contact&#39;</span> <span class="k">do</span>
    <span class="n">redirect</span> <span class="s2">&quot;/contact-error/name&quot;</span> <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">].</span><span class="n">empty?</span>
    <span class="n">redirect</span> <span class="s2">&quot;/contact-error/email&quot;</span> <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">].</span><span class="n">empty?</span>
    <span class="n">redirect</span> <span class="s2">&quot;/contact-error/message&quot;</span> <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:message</span><span class="o">].</span><span class="n">empty?</span>

    <span class="n">erb</span> <span class="ss">:contact_success</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">&#39;/contact-error/:field&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">field</span><span class="o">|</span>
    <span class="vi">@field</span> <span class="o">=</span> <span class="n">field</span>
    <span class="n">erb</span> <span class="ss">:contact_error</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>…in the above example when a user makes an error on my contact form I redirect them to a page that shows them what field they made an error on. In my template file I have…</p>
<pre><code class="lang-html"><div class="highlight"><pre><span class="nt">&lt;p&gt;</span>Sorry there was an error with your form submission. Seems you didn&#39;t fill in the <span class="err">&lt;</span>%= @field %&gt; field.<span class="nt">&lt;/p&gt;</span>
</pre></div>
</code></pre>
<p>…notice I picked up the field from the URL and stored it in a class instance variable and used that variable within my template.</p>
<h3><a name="static-resources"class="anchor" href="#static-resources"><span class="header-link"></span></a>Static resources</h3>
<p>OK, the next thing to be aware of is that Sinatra serves up ALL static resources from a folder called <code>public</code> (again you can change this but I&#39;m happy using it - as the name is perfectly logical already).</p>
<p>What this means is that if you have a file path like: <code>/path/to/file</code> then for that to work you need to have the folders/files within the root <code>public</code> folder otherwise Sinatra can&#39;t locate them. It DOESN&#39;T mean you have to change all your paths to <code>/public/path/to/file</code>. You keep the path the same as it is already but you just move the files/folders inside of a root folder called <code>public</code>.</p>
<p>So for example in all my projects I have my JavaScript files in the following directory…</p>
<p><code>Assets/Scripts/</code></p>
<p>…and all my CSS in the following directory…</p>
<p><code>Assets/Styles/</code></p>
<p>…all I need to do is create an <code>Assets</code> folder within the <code>public</code> folder. Within that I then have the <code>Assets</code> folder, and inside of that is my <code>Scripts</code> and <code>Styles</code> folders which hold the relevant files.</p>
<p>If this sounds a bit confusing then have a look at the GitHub repo linked at the top of this article to see what I&#39;m talking about.</p>
<h3><a name="handling-errors"class="anchor" href="#handling-errors"><span class="header-link"></span></a>Handling errors</h3>
<p>If the user tries to access a page that doesn&#39;t exist then you can direct them to your own <code>404 error</code> page by using the following route…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">not_found</span> <span class="k">do</span>
    <span class="n">erb</span> <span class="ss">:notfound</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>…as you can see I&#39;m loading a &#39;notfound.erb&#39; template for the content. This will get called anytime an unknown URL is specified by the user.</p>
<p>One thing you might not want to have happen is if someone types in <code>http://localhost:4567/projects/</code> instead of <code>http://localhost:4567/projects</code> (notice the extra forward-slash at the end of the first example) then that is considered a different &#39;route&#39; and wont be recognised by Sinatra and so the user is directed to the &#39;not found&#39; route. </p>
<p>To fix this you can do the following…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">before</span> <span class="k">do</span>
    <span class="n">request</span><span class="o">.</span><span class="n">path_info</span><span class="o">.</span><span class="n">sub!</span> <span class="sr">%r{/$}</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>…the above code block is referred to as a &#39;filter&#39; block and it is executed before every HTTP request. </p>
<p>So what this does is execute <code>request.path_info.sub! %r{/$}, &#39;&#39;</code> <em>before</em> every HTTP request. This code uses a Regular Expression to find the last forward-slash in the path and then removes it if it finds one. Which means it doesn&#39;t matter if the user puts an extra slash at the end of the URL.</p>
<p>Note: there is also a <code>after</code> filter block as well for doing tidy up work (although I&#39;ve not had any reason to use it - yet).</p>
<p>If there is an actual error then you can use…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">error</span> <span class="k">do</span>
    <span class="n">erb</span> <span class="ss">:error</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>In a development environment Sinatra tries to be helpful by displaying very detailed error messages. But you may find this overrides your custom error page which you would want to show to a user. So if you want to just test your error page is working correct before you &#39;go live&#39; then simply add <code>disable :show_exceptions</code> to some where near the top of your application file and this will mean the detailed error stack is no longer shown when you encounter an error during development and so you&#39;ll end up seeing what your users will see in the live environment.</p>
<p>Also, within your <code>error.erb</code> template file you can access the error using the environment variable <code>sinatra.error</code>…</p>
<pre><code class="lang-erb"><div class="highlight"><pre><span class="x">&lt;p&gt;Sorry there was the following error: &lt;strong class=&quot;error&quot;&gt;</span><span class="cp">&lt;%=</span> <span class="n">env</span><span class="o">[</span><span class="s2">&quot;sinatra.error&quot;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x">&lt;/strong&gt;&lt;/p&gt;</span>
</pre></div>
</code></pre>
<h3><a name="performance"class="anchor" href="#performance"><span class="header-link"></span></a>Performance</h3>
<p>The performance of your application is very important, and specifically for a web application you want to make sure that all resources are sent to the user as quickly as possible.</p>
<p>Here are some things you can do to help improve the performance of your web application...</p>
<ol>
<li>Cache static resources</li>
<li>Use the <code>Thin</code> Web Server</li>
<li>GZIP all content</li>
</ol>
<h3><a name="cache-static-resources"class="anchor" href="#cache-static-resources"><span class="header-link"></span></a>Cache static resources</h3>
<p>We set the cache control for static resources to approximately 1 month</p>
<p><code>set :static_cache_control, [:public, :max_age =&gt; 2678400]</code></p>
<h3><a name="use-the-thin-web-server"class="anchor" href="#use-the-thin-web-server"><span class="header-link"></span></a>Use the <code>Thin</code> Web Server</h3>
<p>You can also tell Sinatra to use the <code>Thin</code> server rather than the default <code>WEBrick</code> server if it&#39;s available (<code>Thin</code> is a supremely better performing web server so do please use it!)</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="c1"># We specify which server we want to use (Thin is tried first and then failing that WEBrick)</span>
<span class="n">set</span> <span class="ss">:server</span><span class="p">,</span> <span class="sx">%w[thin webrick]</span>
</pre></div>
</code></pre>
<h3><a name="gzip-all-content"class="anchor" href="#gzip-all-content"><span class="header-link"></span></a>GZIP all content</h3>
<p>We can also have the web server automatically GZIP all our static resources (which can reduce the file size of a resource by up to 70%!) such as HTML content, JavaScript files, CSS files by using one line of Ruby code…</p>
<p><code>use Rack::Deflater</code></p>
<p>…this uses the &#39;Rack&#39; middleware application (Rack is what sits behind Sinatra and is the actual HTTP web server interface), but Sinatra hides all of that behind the DSL syntax of <code>get</code> and <code>post</code> calls (nice huh).</p>
<h3><a name="hosting-our-application"class="anchor" href="#hosting-our-application"><span class="header-link"></span></a>Hosting our application</h3>
<p>Right. Let&#39;s get our application uploaded shall we.</p>
<p>This is going to be short and quick…</p>
<ol>
<li>Set-up account (<a href="http://www.heroku.com/" title="Cloud Application Platform">heroku.com</a>)</li>
<li>Install toolbelt (<a href="http://toolbelt.heroku.com/" title="Everything you need to get started using heroku">toolbelt.heroku.com</a>)</li>
<li>Open your Command Line Interface (CLI) and enter:<ul>
<li><code>heroku login</code> (follow on screen instructions)</li>
<li>You may want to add additional SSH keys, if you do use: <code>heroku keys:add</code></li>
<li>To create an app on heroku use: <code>heroku create --stack cedar</code> (you can also do: <code>heroku create yourappname --stack cedar</code>) - <code>cedar</code> will shortly be the <em>default</em> web stack on heroku but for the time being it&#39;s worth including it in the command <code>--stack cedar</code> otherwise your app will be created on an older web stack which isn&#39;t as good.</li>
</ul>
</li>
<li><p>Create a <code>config.ru</code> file and add the following content:  </p>
<pre><code><div class="highlight"><pre> <span class="nx">require</span> <span class="s1">&#39;app&#39;</span> <span class="err">#</span> <span class="nx">where</span> <span class="nx">app</span> <span class="nx">is</span> <span class="nx">the</span> <span class="nx">name</span> <span class="nx">of</span> <span class="nx">your</span> <span class="nx">main</span> <span class="nx">file</span> <span class="nx">that</span> <span class="nx">initializes</span> <span class="nx">your</span> <span class="nx">web</span> <span class="nx">application</span>
 <span class="nx">run</span> <span class="nx">Sinatra</span><span class="o">::</span><span class="nx">Application</span>
</pre></div>
</code></pre>
</li>
<li><p>Create a Gemfile file (no file extension) and add the content:  </p>
</li>
</ol>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;sinatra&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.2&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;thin&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.1&#39;</span>
</pre></div>
</code></pre>
<ol>
<li>Go back to your CLI and enter:<ul>
<li><code>bundle install</code> which will create a <code>Gemfile.lock</code> file specifying ALL the dependancies needed for your app to run (you shouldn&#39;t need to manually create your own Gemfile - as I&#39;ve told you to do in step 5. - but just in case <code>bundle install</code> doesn&#39;t work for you then you can at least do it manually).</li>
<li>Create a Procfile (no file extension) and add the content: <code>web: bundle exec ruby app.rb -p $PORT</code><br> e.g.<br> <code>touch Procfile</code>,<br> <code>echo web: bundle exec ruby app.rb -p $PORT &gt; Procfile</code></li>
<li>Commit your files using Git (if you don&#39;t know how to use Git then <a href="https://github.com/Integralist/Blog-Posts/blob/master/How-to-use-Git-and-GitHub.md" title="How to use Git and GitHub">read this introduction</a>)</li>
<li>If you&#39;ve not done this already then create a <code>remote</code> for heroku: <code>git remote add heroku git@heroku.com:xxxxx.git</code> (when you created your app earlier heroku would have generated a remote URL for you to use)</li>
<li><code>git push heroku master</code></li>
<li><code>heroku open</code> will open your default browser to the relevant app URL heroku has given you (they are normally pretty crazy looking URL&#39;s - but you can at some later stage - if you want - register a proper domain and point it to the app on heroku&#39;s server so you don&#39;t have to give out a dodgy long URL to your users)</li>
</ul>
</li>
</ol>
<p>Hopefully if you followed along, and had no errors, then you should see your new app online and hosted by heroku!</p>
<h2><a name="conclusions"class="anchor" href="#conclusions"><span class="header-link"></span></a>Conclusions</h2>
<p>Well, there you have it. Building a website using Sinatra and Ruby, and actually getting it hosted online.</p>
<p>It has been a bit of a whirlwind pace we&#39;ve set here, going through lots of different concepts such as performance tricks and handling errors, through to loading template files etc. But hopefully it wasn&#39;t too fast paced, and you managed to utilise this information to get you up and running. </p>
<p>I&#39;m actually writing this at record pace at home, late at night - feeling very tired, so if this article doesn&#39;t read right, or you think it needs improving then please get in contact and let me know what you think would help improve it (and thus help other people better understand the concepts)</p>
<p>Thanks.</p>
</div>

  <div class="comments">
    <a href="/posts/ruby-and-the-sinatra-framework/#comments">
      <span class="icon-bubbles"></span>
      Comments
    </a>
  </div>

  <div class="post-head group">
  <a href="/posts/building-a-game-with-html5-canvas/">
    <h1 class="post-title">Building a game with HTML5 Canvas</h1>
  </a>
  <span class="post-date">2012 &#183; 6 &#183; 18</span>
</div>

<div class="post-body"><h2><a name="what-we-ll-cover"class="anchor" href="#what-we-ll-cover"><span class="header-link"></span></a>What we&#39;ll cover</h2>
<p><em>reading time: approx. 39mins</em></p>
<ul>
<li>Introduction</li>
<li>HTML</li>
<li>CSS</li>
<li>JavaScript<ul>
<li>requestAnimationFrame</li>
<li>Variables</li>
<li>Events alias&#39;</li>
<li>Image loading</li>
<li>Clearing the Canvas</li>
<li>Load image onto Canvas</li>
<li>Initialise Game</li>
<li>User interaction</li>
<li>Automatic puzzle piece animation</li>
<li>Drag and Drop interaction</li>
<li>Determining the end of game</li>
</ul>
</li>
</ul>
<h2><a name="introduction"class="anchor" href="#introduction"><span class="header-link"></span></a>Introduction</h2>
<p>I&#39;ve been playing around with the <a href="https://developer.mozilla.org/en/HTML/Canvas">Canvas</a> element for a little bit now, using it for more realistic features such as manipulating user uploaded images (using <a href="http://dvcs.w3.org/hg/xhr/raw-file/tip/Overview.html">XHR2</a>). For example, within a custom Content Management System where the user controls the images that appear on their website we would normally let the server handle the manipulation of the uploaded image using an external library such as <a href="http://www.imagemagick.org/">ImageMagick</a>, but now we handle this all on the client-side using Canvas.</p>
<p>I&#39;ve also played with the raw pixel data in images to apply filters and effect the colours of an image, which is interesting (although I have no actual use for that sort of manipulation at the present time).</p>
<p>So I thought I would dive a little bit further into the Canvas element and use it for building a game (as that&#39;s what most people are using it for). Nothing fancy, just the classic &quot;sliding image puzzle&quot; game we have all played at some point.  If you&#39;ve never played this game: the idea is to take an image and to split it into pieces. You then jumble up the pieces and remove one piece so there is an empty space. You then have to re-assemble the original image by sliding the pieces around but only able to move one piece at a time via the empty space that is available to you.</p>
<p>The game works on both desktop and mobile devices (e.g. &#39;touch&#39; based devices).</p>
<p>To see an example of the game then go to my <a href="https://github.com/Integralist/HTML5-Image-Slider-Game/">GitHub repository here</a> and run the HTML file in a browser that supports the HTML5 Canvas element.</p>
<p>In this article we&#39;re going to discuss the process I went through to build this game in more detail. The first two sections (HTML, CSS) are brief because the main chunk of work is residing inside the JavaScript so for that section we&#39;re going to step through each section of the code and explain what&#39;s happening.</p>
<h2><a name="html"class="anchor" href="#html"><span class="header-link"></span></a>HTML</h2>
<p>The HTML is pretty straight forward, it consists of a <code>meta</code> tag which tells the device to set the width to be 760px wide (this is so the game fits the full width of the device) and also specifies that the user cannot resize the content - the reason being is we want to ensure the game is always fitting the screen. After this we have a link to our style sheet - note: there are some declarations in our CSS which are included specifically to help with &#39;touch&#39; based devices (e.g. devices such as smart phones which don&#39;t utilise a &#39;mouse&#39; to interact with the content) - along with a single <code>canvas</code> element (which we could have created via JavaScript but I decided I preferred to have the element coded into the HTML). We also have a checkbox on the page which lets the user make the game a little easier by allowing them to move certain &#39;illegal&#39; puzzle pieces, and finally we have the <code>script</code> element which obviously is pointing to our JavaScript file which creates the game… </p>
<pre><code class="lang-html"><div class="highlight"><pre><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span> <span class="na">dir=</span><span class="s">&quot;ltr&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=760, user-scalable=0&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>HTML5 Slider Image Game<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;Assets/Styles/base.css&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;canvas</span> <span class="na">id=</span><span class="s">&quot;game&quot;</span><span class="nt">&gt;&lt;/canvas&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">&quot;allow&quot;</span><span class="nt">&gt;</span>Make game easier by allowing &#39;drag and drop&#39; of invalid pieces: <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">name=</span><span class="s">&quot;allow&quot;</span> <span class="na">id=</span><span class="s">&quot;allow&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;Assets/Scripts/game.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</code></pre>
<h2><a name="css"class="anchor" href="#css"><span class="header-link"></span></a>CSS</h2>
<p>The CSS is also pretty straight forward - with the exception of one part we&#39;ll come to in a moment - the main chunk of this style sheet is simply setting generic styles and normalising certain elements. </p>
<p>You&#39;ll notice though a rule called <code>.drag-canvas</code> which will be applied to another <code>canvas</code> element which you haven&#39;t seen yet as it&#39;s not part of the HTML, it is instead created via JavaScript (I&#39;ll explain what this 2nd <code>canvas</code> is for later when we start discussing the JavaScript side of the project).</p>
<p>The <code>canvas</code> selector sets a rule which has some specific declarations (along with appropriate vendor prefixes) that are applied to any <code>canvas</code> element found in the page. The declaration we&#39;re applying is <a href="https://developer.mozilla.org/en/CSS/-moz-user-select"><code>user-select</code></a> which controls the selection a user makes on the content. You&#39;ll see we&#39;ve set this to <code>none</code>. What this does is it prevents any iOS devices (and potentially other devices - hence the use of the vendor prefixes) from showing an additional option which lets the user carry out an action (e.g. &#39;copy&#39;). The reason I want to prevent this is because in our game we also want users to be able to &#39;drag and drop&#39; puzzle pieces (rather than just letting them &#39;click&#39; or &#39;touch&#39; to move a puzzle piece) and the way we do this (again, we&#39;ll go into this in more detail later) is by checking how long the user holds their &#39;touch&#39; down on the puzzle piece. But if you have ever used an iOS device you&#39;ll know that if you hold your touch down for more than a second you&#39;ll see a context menu pop up asking you to either &#39;Select, Select All, Paste&#39; or &#39;Copy&#39; and it&#39;s these options we want to disable while the user is playing our game.</p>
<pre><code class="lang-css"><div class="highlight"><pre><span class="nt">body</span> <span class="p">{</span>
    <span class="k">font-family</span><span class="o">:</span> <span class="n">Helvetica</span><span class="o">,</span> <span class="n">Arial</span><span class="o">,</span> <span class="k">sans-serif</span><span class="p">;</span>
    <span class="k">font-size</span><span class="o">:</span> <span class="m">100</span><span class="o">%</span><span class="p">;</span> <span class="c">/* this sets 1em to equal approximately 16px */</span>
    <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">padding</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h1</span><span class="o">,</span> <span class="nt">h2</span><span class="o">,</span> <span class="nt">h3</span><span class="o">,</span> <span class="nt">h4</span><span class="o">,</span> <span class="nt">h5</span><span class="o">,</span> <span class="nt">h6</span><span class="o">,</span> <span class="nt">p</span> <span class="p">{</span>
    <span class="k">line-height</span><span class="o">:</span> <span class="m">1.3em</span><span class="p">;</span>
    <span class="k">margin</span><span class="o">:</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h1</span> <span class="p">{</span>
    <span class="k">font-size</span><span class="o">:</span> <span class="m">2em</span><span class="p">;</span>
    <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">0.5em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.drag-canvas</span> <span class="p">{</span>
    <span class="k">left</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
    <span class="k">top</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">canvas</span> <span class="p">{</span>
    <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">select</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span> <span class="c">/* prevents the &#39;copy&#39; option &gt; http://www.bernskiold.com/2011/02/02/tips-and-tricks-for-ios-web-development/ */</span>
       <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">select</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
            <span class="n">user</span><span class="o">-</span><span class="n">select</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.allow</span> <span class="p">{</span>
    <span class="k">margin-top</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span>
    <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
    <span class="k">width</span><span class="o">:</span> <span class="m">760px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<h2><a name="javascript"class="anchor" href="#javascript"><span class="header-link"></span></a>JavaScript</h2>
<p>Now the JavaScript is where it gets interesting…  </p>
<h3><a name="requestanimationframe"class="anchor" href="#requestanimationframe"><span class="header-link"></span></a>requestAnimationFrame</h3>
<p>The first thing you&#39;ll notice is a polyfill for <a href="https://developer.mozilla.org/en/DOM/window.requestAnimationFrame">requestAnimationFrame</a>. If you don&#39;t know what it is, <code>requestAnimationFrame</code> is a more efficient alternative for <code>setInterval</code>and <code>setTimeout</code>. It&#39;s actually based more on <code>setTimeout</code> than <code>setInterval</code>, and what I mean by this is your specified function to be executed must itself call <code>requestAnimationFrame</code> (unless you want the animation to stop).</p>
<p>The polyfill I&#39;m using I&#39;ve modified slightly so that it creates a property of the global object whose value is a boolean which indicates if it is supported by the user&#39;s browser or not. The reason I store this result is because later in the script when I specify a &#39;step amount&#39; (e.g. how far I want the puzzle piece to move on each iteration) I found that I got better performance setting a higher step amount for browsers that support <code>requestAnimationFrame</code> so I want to change the step amount depending on if I&#39;m using <code>setInterval</code> or not.</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Polyfill for requestAnimationFrame which I&#39;ve modified from Paul Irish&#39;s original</span>
<span class="c1">// See: http://paulirish.com/2011/requestanimationframe-for-smart-animating/</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">lastTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">vendors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;moz&#39;</span><span class="p">,</span> <span class="s1">&#39;webkit&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">vendors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">global</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">;</span> <span class="o">++</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">global</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">=</span> <span class="nx">global</span><span class="p">[</span><span class="nx">vendors</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;RequestAnimationFrame&#39;</span><span class="p">];</span>
        <span class="nx">global</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span> <span class="o">=</span> <span class="nx">global</span><span class="p">[</span><span class="nx">vendors</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;CancelAnimationFrame&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="nx">global</span><span class="p">[</span><span class="nx">vendors</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;CancelRequestAnimationFrame&#39;</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="nx">global</span><span class="p">.</span><span class="nx">nativeRAF</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">global</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">;</span> <span class="c1">// store reference to whether it was natively supported or not (later we need to change increment value depending on if setInterval or requestAnimationFrame is used)</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">global</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">global</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>

            <span class="kd">var</span> <span class="nx">currTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">(),</span>
                <span class="nx">timeToCall</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span> <span class="o">-</span> <span class="p">(</span><span class="nx">currTime</span> <span class="o">-</span> <span class="nx">lastTime</span><span class="p">)),</span>
                <span class="nx">id</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span> 
                    <span class="nx">callback</span><span class="p">(</span><span class="nx">currTime</span> <span class="o">+</span> <span class="nx">timeToCall</span><span class="p">);</span>
                <span class="p">},</span> <span class="nx">timeToCall</span><span class="p">);</span>

            <span class="nx">lastTime</span> <span class="o">=</span> <span class="nx">currTime</span> <span class="o">+</span> <span class="nx">timeToCall</span><span class="p">;</span>

            <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>

        <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">global</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">global</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}(</span><span class="k">this</span><span class="p">));</span>
</pre></div>
</code></pre>
<p>Following this is our main script which we&#39;ve wrapped in an &#39;immediately invoked function expression&#39; (or <a href="benalman.com/news/2010/11/immediately-invoked-function-expression/">IIFE</a> for short). You&#39;ll see that we&#39;re passing in the value <code>this</code> which in this context is the global object (i.e. <code>Window</code>)… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// REST OF OUR CODE</span>
<span class="p">}(</span><span class="k">this</span><span class="p">));</span>
</pre></div>
</code></pre>
<h3><a name="variables"class="anchor" href="#variables"><span class="header-link"></span></a>Variables</h3>
<p>Now, if you look at my <a href="https://github.com/Integralist/Style-Guides/blob/master/JavaScript%20Style%20Guide.md#javascript-style-guide">JavaScript Style Guide</a> you&#39;ll see that I like to set-up the structure of my code as follows… </p>
<ul>
<li>Variables</li>
<li>Supporting functions</li>
<li>Code</li>
</ul>
<p>…and this structure applies to all executing contexts (e.g. sub functions also have the same structure). So looking at our code you can see we&#39;ve got a whole ton of variables specified which are used throughout the program. The reason for this is because of how the JavaScript interpreter handles variables when the program starts, which is to invisibly move variable declarations to the top of their containing scope. So to avoid confusion I try (wherever possible) to keep my variable declarations at the top… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Following variables are related to the creation of the canvas&#39; and specific configuration</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nb">document</span><span class="p">,</span>
        <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;game&quot;</span><span class="p">),</span>
        <span class="nx">context</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">),</span>
        <span class="nx">dragCanvas</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;canvas&quot;</span><span class="p">),</span>
        <span class="nx">dragCanvasContext</span> <span class="o">=</span> <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">),</span>
        <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">(),</span>
        <span class="nx">canvas_height</span><span class="p">,</span>
        <span class="nx">canvas_width</span><span class="p">,</span>
        <span class="nx">canvas_grid</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="c1">// e.g. 4 cols x 4 rows</span>
        <span class="nx">piece_height</span><span class="p">,</span>
        <span class="nx">piece_width</span><span class="p">,</span>
        <span class="nx">opening_message</span> <span class="o">=</span> <span class="s2">&quot;Start Game&quot;</span><span class="p">,</span>
        <span class="nx">text_dimensions</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">opening_message</span><span class="p">),</span>
    <span class="c1">// Following variables are related to the puzzle pieces</span>
        <span class="nx">puzzle_squares</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">puzzle_randomised</span><span class="p">,</span>
        <span class="nx">empty_space</span><span class="p">,</span>
        <span class="nx">current_piece</span><span class="p">,</span>
        <span class="nx">removed_piece</span><span class="p">,</span>
        <span class="nx">random_number</span><span class="p">,</span>
    <span class="c1">// Following variables are related to moving puzzle pieces around</span>
        <span class="nx">drag</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">eventObject</span><span class="p">,</span>
        <span class="nx">eventsMap</span>  <span class="o">=</span> <span class="p">{</span>
            <span class="nx">select</span><span class="o">:</span> <span class="s2">&quot;click&quot;</span><span class="p">,</span>
            <span class="nx">down</span><span class="o">:</span> <span class="s2">&quot;mousedown&quot;</span><span class="p">,</span>
            <span class="nx">up</span><span class="o">:</span> <span class="s2">&quot;mouseup&quot;</span><span class="p">,</span>
            <span class="nx">move</span><span class="o">:</span> <span class="s2">&quot;mousemove&quot;</span>
        <span class="p">},</span>
        <span class="nx">touchSupported</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">upTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">wasJustDragging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">allow_input</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;allow&quot;</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>…looking at these variables you can see that we&#39;re not only getting a reference to the <code>canvas</code> element in the page but we&#39;re also creating another <code>canvas</code> element. The purpose of having two <code>canvas</code>&#39;es is that the one found inside the HTML will be used for holding the puzzle pieces. The second <code>canvas</code> (created via JavaScript) is used for handling event listeners and also handling the &#39;drag and drop&#39; of individual puzzle pieces.</p>
<h3><a name="events-alias-"class="anchor" href="#events-alias-"><span class="header-link"></span></a>Events alias&#39;</h3>
<p>You&#39;ll also see that we&#39;ve created an object called <code>eventsMap</code> which we&#39;re using to map our own events (such as &#39;select&#39;, &#39;down&#39;, &#39;up&#39;, &#39;move&#39;) to the relevant mouse events available. This is because it makes it easier for us to swap to using touch events if they are supported by the users browser. So for example, just after setting up these variables we do a check for whether touch events are supported and if they are we swap the mouse specific values for touch specific values… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="s2">&quot;ontouchstart&quot;</span> <span class="k">in</span> <span class="nx">global</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">touchSupported</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">eventsMap</span>  <span class="o">=</span> <span class="p">{</span>
        <span class="nx">select</span><span class="o">:</span> <span class="s2">&quot;touchstart&quot;</span><span class="p">,</span>
        <span class="nx">down</span><span class="o">:</span> <span class="s2">&quot;touchstart&quot;</span><span class="p">,</span>
        <span class="nx">up</span><span class="o">:</span> <span class="s2">&quot;touchend&quot;</span><span class="p">,</span>
        <span class="nx">move</span><span class="o">:</span> <span class="s2">&quot;touchmove&quot;</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<h3><a name="image-loading"class="anchor" href="#image-loading"><span class="header-link"></span></a>Image loading</h3>
<p>You&#39;ll also see that within the variable declarations we&#39;re creating an <code>Image</code> object and after the variables we now set a <code>src</code> value which points to the image we&#39;re going to use for our game. We then set an <code>onload</code> event listener to be triggered when the image has loaded. </p>
<p>Once the image is loaded we know we can set-up the dimensions of the <code>canvas</code> and the puzzle pieces and also get the &#39;drag&#39; <code>canvas</code> placed on top of the main <code>canvas</code>. You&#39;ll notice that we&#39;ve set the &#39;drag&#39; <code>canvas</code> to have <code>globalAlpha = .9;</code> which basically makes the top <code>canvas</code> slightly opaque/transparent (e.g. if a puzzle piece was drawn on the &#39;drag&#39; <code>canvas</code> then you would be able to see through the puzzle piece to the bottom <code>canvas</code>).</p>
<p>We then finally call <code>loadImageOntoCanvas</code> to load the image on to the main <code>canvas</code>… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;Assets/Images/photo.jpg&quot;</span><span class="p">;</span>    
<span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">piece_height</span> <span class="o">=</span> <span class="o">~~</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="nx">canvas_grid</span><span class="p">);</span>
    <span class="nx">piece_width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="nx">canvas_grid</span><span class="p">;</span>
    <span class="nx">canvas_height</span> <span class="o">=</span> <span class="nx">piece_height</span> <span class="o">*</span> <span class="nx">canvas_grid</span><span class="p">;</span>
    <span class="nx">canvas_width</span> <span class="o">=</span> <span class="nx">piece_width</span> <span class="o">*</span> <span class="nx">canvas_grid</span><span class="p">;</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">canvas_height</span><span class="p">;</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">canvas_width</span><span class="p">;</span>

    <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s2">&quot;drag-canvas&quot;</span><span class="p">;</span>
    <span class="nx">dragCanvasContext</span><span class="p">.</span><span class="nx">globalAlpha</span> <span class="o">=</span> <span class="p">.</span><span class="mi">9</span><span class="p">;</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">dragCanvas</span><span class="p">);</span>

    <span class="nx">loadImageOntoCanvas</span><span class="p">();</span>
<span class="p">};</span>
</pre></div>
</code></pre>
<p>…one other small note is the use of the bitwise operator <code>~~</code> which you can see I&#39;ve used inside the <code>onload</code> listener: <code>piece_height = ~~(this.height / canvas_grid);</code>. What this does is functionally equivalent to <code>Math.floor</code> and is a technique I discovered from <a href="http://james.padolsey.com/javascript/double-bitwise-not/">James Padolsey</a>.</p>
<h3><a name="clearing-the-canvas"class="anchor" href="#clearing-the-canvas"><span class="header-link"></span></a>Clearing the Canvas</h3>
<p>Next we see a function called <code>clearCanvas</code>… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">clearCanvas</span> <span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>This does exactly what you think it does. But instead of using the API method <code>clearRect</code> to clear the <code>canvas</code> it uses a trick where by if you set the width and height of the <code>canvas</code> to the same dimensions as the <code>canvas</code> itself then the <code>canvas</code> will clear. <strong>BUT BE WARNED:</strong> this will also erase all state from the <code>canvas</code>! (for more information on &#39;state&#39; <a href="http://html5.litten.com/understanding-save-and-restore-for-the-canvas-context/">see here</a>)</p>
<h3><a name="load-image-onto-canvas"class="anchor" href="#load-image-onto-canvas"><span class="header-link"></span></a>Load image onto Canvas</h3>
<p>Now we move onto the function <code>loadImageOntoCanvas</code>… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">loadImageOntoCanvas</span><span class="p">(){</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">canvas_width</span><span class="p">,</span> <span class="nx">canvas_height</span><span class="p">);</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>

    <span class="nx">context</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&quot;#FFF&quot;</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">shadowColor</span> <span class="o">=</span> <span class="s2">&quot;#000&quot;</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">shadowOffsetX</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">shadowOffsetY</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">shadowBlur</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="s2">&quot;bold 25px Helvetica&quot;</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="nx">opening_message</span><span class="p">,</span> <span class="p">(</span><span class="nx">canvas_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nx">text_dimensions</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="p">(</span><span class="nx">canvas_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>

    <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">select</span><span class="p">,</span> <span class="nx">init</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…which first draws the image onto the <code>canvas</code>, then writes some text onto the <code>canvas</code> which says &quot;Start Game&quot;. We position the text centrally to the <code>canvas</code> by using the API method <code>measureText</code> which gives us the dimensions of the text. Remember up in the variable declarations we had… </p>
<pre><code><div class="highlight"><pre><span class="nx">text_dimensions</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">opening_message</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>…well now we can use that to write the text centrally onto the <code>canvas</code>… </p>
<pre><code><div class="highlight"><pre><span class="nx">context</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="nx">opening_message</span><span class="p">,</span> <span class="p">(</span><span class="nx">canvas_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nx">text_dimensions</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="p">(</span><span class="nx">canvas_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
</pre></div>
</code></pre>
<p>The last part of that function is an event listener for the <code>click</code>/<code>touchstart</code> event (depending on the browser support) which will call the <code>init</code> function when the user clicks on the <code>canvas</code> (to start the game)… </p>
<pre><code><div class="highlight"><pre><span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">select</span><span class="p">,</span> <span class="nx">init</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</pre></div>
</code></pre>
<h3><a name="initialise-game"class="anchor" href="#initialise-game"><span class="header-link"></span></a>Initialise Game</h3>
<p>In short: the <code>init</code> function clears the <code>canvas</code> and splits up the image into individual pieces and then displays them in a jumbled order. From there it sets up further event listeners for &#39;down&#39; and &#39;up&#39; events (which map to <code>mousedown</code>/<code>mouseup</code> and <code>touchstart</code>/<code>touchend</code>).</p>
<p>Lets look at this function in more detail… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">select</span><span class="p">,</span> <span class="nx">init</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="nx">clearCanvas</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>

<span class="c1">// Remove shadow (otherwise all puzzle pieces would get shadow applied to them)</span>
<span class="nx">context</span><span class="p">.</span><span class="nx">shadowOffsetX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">context</span><span class="p">.</span><span class="nx">shadowOffsetY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</code></pre>
<p>…so we first remove the event listener we previously set. We then clear the <code>canvas</code> (don&#39;t worry, the rest of the function executes in a fraction of a second so the user wont see the <code>canvas</code> go white, they&#39;ll just see the end result which is the jumbled up puzzle pieces).</p>
<p>We then set the <code>shadowOffsetX</code> and <code>shadowOffsetY</code> to zero. The reason for doing this is that when I originally wrote the text &quot;Start Game&quot; onto the <code>canvas</code> I had set the shadow properties to help make the text stand out more. But if I don&#39;t reset the values back to zero then all items will have a shadow (so when I was originally building this game I noticed that the puzzle pieces all had a shadow on them which made the game look broken!)</p>
<p>We&#39;ll ignore the variable declarations and the two functions at the beginning of <code>init</code> and move down to the executing code within this function.</p>
<p>So first thing we see is we call the <code>loop</code> function. Now this function is actually called twice within <code>init</code> and the reason for that is because the main chunk of the <code>loop</code> function is (as you would expect) a loop and that loop has to happen twice: once for splitting the image into pieces and the second time is for actually drawing those pieces (after they&#39;ve been jumbled up) back onto the <code>canvas</code>. But some extra things need to happen when the loop runs a second time, so we pass in a parameter so the <code>loop</code> function knows that this time it will need to draw the puzzle pieces onto the <code>canvas</code>…</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Build map of co-ordinates</span>
<span class="nx">loop</span><span class="p">();</span>

<span class="c1">// Randomise puzzle pices</span>
<span class="nx">puzzle_randomised</span> <span class="o">=</span> <span class="nx">shuffle</span><span class="p">(</span><span class="nx">puzzle_squares</span><span class="p">);</span>

<span class="c1">// Draw puzzle pieces</span>
<span class="nx">loop</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>…you can see we are using a <code>shuffle</code> function to mix up the puzzle pieces. This function I modified from the <a href="http://documentcloud.github.com/underscore/">Underscore</a> JavaScript library.</p>
<p>From here we randomly select a puzzle piece to remove (remember we need to have one empty space for the other pieces to move into) and then we set the initial empty space values (which we use throughout the rest of the game as a way to tell which part of the <code>canvas</code> is empty and can have a puzzle piece moved into it)… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">random_number</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">puzzle_randomised</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">random_number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">random_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">random_piece</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">random_number</span><span class="p">];</span>

<span class="nx">removed_piece</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">random_number</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">random_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span> <span class="nx">random_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

<span class="nx">empty_space</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">x</span><span class="o">:</span> <span class="nx">random_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
    <span class="nx">y</span><span class="o">:</span> <span class="nx">random_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
<span class="p">};</span>
</pre></div>
</code></pre>
<p>And the last part of the <code>init</code> function is to set-up the event listeners for the &#39;down&#39;/&#39;up&#39; events (which as we&#39;ve mentioned already are just alias&#39; to the relevant mouse and touch events)… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">down</span><span class="p">,</span> <span class="nx">checkDrag</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">up</span><span class="p">,</span> <span class="nx">toggleDragCheck</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>…these event listeners are going to help us detect when the user wants to move a puzzle piece.</p>
<h3><a name="user-interaction"class="anchor" href="#user-interaction"><span class="header-link"></span></a>User interaction</h3>
<p>So we can see that the &#39;down&#39; event will call the <code>checkDrag</code> function, so lets start from there… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">down</span><span class="p">,</span> <span class="nx">checkDrag</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

<span class="nx">global</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">drag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">startDrag</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">movePiece</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="mi">150</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>You see we&#39;re first removing the event listener for the &#39;down&#39; event. We do this so the user can&#39;t accidentally (or purposely) try to move another puzzle piece while we&#39;re still in the process of moving the previous one.</p>
<p>We then use a short timer which when executed checks to see if the variable <code>drag</code> is true or false. If <code>drag</code> is true then we know the user wants to actually &#39;drag and drop&#39; the puzzle piece rather than have it move automatically for them. If <code>drag</code> is false then we just start animating the selected puzzle piece for them.</p>
<p>The reason we use a timer here is because we only have one &#39;down&#39; event, but that one event needs to do two things. So the timer delays the JavaScript engine just long enough for us to tell whether the user has released their click/touch. Remember we also set an &#39;up&#39; event which calls <code>toggleDragCheck</code> - well that function sets <code>drag</code> to false - so if the user just clicks/taps the puzzle piece then the &#39;up&#39; event will trigger and we&#39;ll set <code>drag</code> to false and so the timer will then know the user wants to have the piece moved for them. If the user keeps their click/touch down then when the timer runs <code>drag</code> will still equal true and so we know they want to &#39;drag and drop&#39; the selected piece.</p>
<p>Now as far as user interaction is concerned, there are a number of different scenarios that can play out during this game (e.g. user presses on illegal piece, user drops piece over non-empty space, the order of functions called changes when the user &#39;drag and drops&#39; and so the value of the variable <code>drag</code> can be changed incorrectly) and so we have to add in extra checks inside the <code>toggleDragCheck</code> function which work around these different scenarios.</p>
<p>For example, I had a problem where if the user did a &#39;drag and drop&#39; movement then the <code>toggleDragCheck</code> function would get called in a different order. So if the user then tried to perform another &#39;drag and drop&#39; movement they couldn&#39;t. So I had to put in checks that determined if the user was just in a &#39;drag and drop&#39; motion or not and reset specific variables to make sure the user could perform the actions they wanted… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">toggleDragCheck</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">upTriggered</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="c1">// If the user releases while piece is moving but the piece hasn&#39;t yet been placed then stop the drag</span>
    <span class="c1">// And move the piece back into the empty space it came from</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">upTriggered</span> <span class="o">&amp;&amp;</span> <span class="nx">event_moving</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">upTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">stopDrag</span><span class="p">();</span>
        <span class="nx">putPieceBack</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">drag</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>UPDATE: I have since realised another way I could have implemented &#39;drag &amp; drop&#39; which is to check the &#39;move&#39; event (remember this is an alias for <code>mousemove</code> and <code>touchmove</code>) while the &#39;down&#39; event was triggered and to set a threshold of let&#39;s say 4px in any direction before triggering the drag and drop mechanism. I don&#39;t know how much this would have simplified things but maybe that could be an exercise for the reader to investigate. </p>
<h3><a name="automatic-puzzle-piece-animation"class="anchor" href="#automatic-puzzle-piece-animation"><span class="header-link"></span></a>Automatic puzzle piece animation</h3>
<p>We have two routes to go down now: <code>startDrag</code> or <code>movePiece</code>.</p>
<p>We&#39;re going to start with <code>movePiece</code> as that&#39;s the simpler of the two routes at the moment.</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
    <span class="nx">j</span> <span class="o">=</span> <span class="nx">canvas_grid</span><span class="p">,</span>
    <span class="nx">selected_piece</span><span class="p">,</span>
    <span class="nx">potential_spaces</span><span class="p">,</span>
    <span class="c1">// Firefox only recognised properties pageX/Y</span>
    <span class="nx">eventX</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetX</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> 
    <span class="nx">eventY</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetY</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">,</span>
    <span class="nx">pieceMovedX</span><span class="p">,</span>
    <span class="nx">pieceMovedY</span><span class="p">,</span>
    <span class="nx">moveAmount</span> <span class="o">=</span> <span class="p">(</span><span class="nx">nativeRAF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">20</span> <span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="c1">// setInterval worked fine when moving by 10 but rAF could do with up&#39;ing the number of pixels per movement</span>
    <span class="nx">interval</span><span class="p">,</span>
    <span class="nx">coord</span><span class="p">,</span>
    <span class="nx">direction</span><span class="p">,</span> 
    <span class="nx">storeSelectedX</span><span class="p">,</span> 
    <span class="nx">storeSelectedY</span><span class="p">,</span>
    <span class="nx">foundPieceForAnimation</span><span class="p">;</span>
</pre></div>
</code></pre>
<p>OK, so the first thing we find inside of the <code>movePiece</code> function are the variable declarations. We can see that the only variables that are actually defined are <code>i</code>, <code>eventX</code>, <code>eventY</code> and <code>moveAmount</code>. For <code>moveAmount</code> you can see what we were referring to earlier when we were talking about the <code>requestAnimationFrame</code> polyfill…</p>
<p><code>moveAmount = (nativeRAF) ? 20 : 10</code></p>
<p>…we&#39;re checking if <code>requestAnimationFrame</code> is natively supported (rather than just a <code>setInterval</code>) and then we change the amount the puzzle piece should move depending on that result (we find moving by 20 on every iteration is a lot smoother using <code>requestAnimationFrame</code>, whereas moving by 20 using <code>setInterval</code> is just too fast).</p>
<p>Our first requirement from here is to find out which puzzle piece was clicked on. When we find out what piece was selected we can then decide whether we want to continue within the function to actually animate the piece into the empty space or not (I say &quot;<em>we can decide</em>&quot; because at this stage we don&#39;t know if the selected puzzle piece is a valid piece that has been clicked on - e.g. there is no empty space immediately next to it)… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Find the piece that was clicked on</span>
<span class="nx">selected_piece</span> <span class="o">=</span> <span class="nx">findSelectedPuzzlePiece</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">eventX</span><span class="p">,</span> <span class="nx">eventY</span><span class="p">);</span>

<span class="c1">// We&#39;re resetting &#39;wasJustDragging&#39; variable to false as we&#39;re now attempting to move the puzzle piece &#39;automatically&#39;</span>
<span class="c1">// So even if we don&#39;t actual move the puzzle piece, our program knows we haven&#39;t just tried to &#39;drag and drop&#39;</span>
<span class="nx">wasJustDragging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="c1">// If no piece found (or user clicked on &#39;empty space&#39;) then don&#39;t continue</span>
<span class="c1">// But we need to reset some settings ready for next user interaction</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">selected_piece</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">resetOptions</span><span class="p">();</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…so the above code is making sense so far (e.g. we need to get the selected puzzle piece and then check if it&#39;s valid). But lets take a closer look at the two functions mentioned in the above snippet: <code>findSelectedPuzzlePiece</code> and <code>resetOptions</code>.</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">findSelectedPuzzlePiece</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">eventX</span><span class="p">,</span> <span class="nx">eventY</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Make sure we haven&#39;t selected the current empty space</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">eventX</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">eventX</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">eventY</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">eventY</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">piece_height</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">eventX</span> <span class="o">&gt;=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasX</span> <span class="o">&amp;&amp;</span> <span class="nx">eventX</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasX</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">eventY</span> <span class="o">&gt;=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasY</span> <span class="o">&amp;&amp;</span> <span class="nx">eventY</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasY</span> <span class="o">+</span> <span class="nx">piece_height</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>As you can see the <code>findSelectedPuzzlePiece</code> is just a simple loop through the Array (<code>puzzle_randomised</code>) which holds the jumbled up puzzle pieces <code>puzzle_randomised</code> and it checks the current X and Y co-ordinates to see if they match any of the items in the Array (while at the same is also checking if the X and Y co-ordinates have matched the currently empty space in the puzzle).</p>
<p>The <code>resetOptions</code> function is a little bit more complicated in that it needs to delay resetting some values. This is because of how the different functions are used to configure the &#39;drag and drop&#39; settings. For example, if the user clicked too quickly after just &#39;dragging and dropping&#39; their puzzle piece then they wouldn&#39;t be able to move another piece (which was fixed by setting a fraction of a second delay before re-applying the event listeners).</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">resetOptions</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">wasJustDragging</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">global</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">down</span><span class="p">,</span> <span class="nx">checkDrag</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">up</span><span class="p">,</span> <span class="nx">toggleDragCheck</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">down</span><span class="p">,</span> <span class="nx">checkDrag</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Make sure drag is reset to true so we can check whether the user wants to &quot;drag &amp; drop&quot;</span>
    <span class="nx">drag</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>OK, now we&#39;ve taken a look at those two functions, lets continue on with the next step of the <code>movePiece</code> function which is to create an object with the four potential empty spaces that could be around the selected puzzle piece… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">potential_spaces</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">-</span> <span class="nx">piece_height</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">-</span> <span class="nx">piece_width</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">+</span> <span class="nx">piece_height</span>
    <span class="p">}</span>
<span class="p">];</span>
</pre></div>
</code></pre>
<p>…now we move onto actually looping through the <code>potential_spaces</code> Array to see if we can find a match of the potential empty spaces and the <em>actual</em> empty space… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Check if we can move the selected piece into the empty space (e.g. can only move selected piece up, down, left and right, not diagonally)</span>
<span class="k">while</span> <span class="p">(</span><span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">x</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">y</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// NOW WE NEED TO LOOP THROUGH &#39;puzzle_randomised&#39;          </span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…once we&#39;ve found a match we can start looping through the Array that holds the jumbled puzzle pieces (i.e. <code>puzzle_randomised</code>) and see if we can find a match between the selected puzzle piece and the pieces in the Array… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasX</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">&amp;&amp;</span> 
        <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasY</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// We&#39;ll keep track of how far the piece has moved</span>
        <span class="nx">pieceMovedX</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">;</span>
        <span class="nx">pieceMovedY</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">;</span>

        <span class="c1">// We&#39;ll also keep track of the original selected piece as we&#39;ll need these co-ordinates for resetting the empty space</span>
        <span class="nx">storeSelectedX</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">;</span>
        <span class="nx">storeSelectedY</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">;</span>

        <span class="c1">// Animate the piece into place</span>
        <span class="nx">foundPieceForAnimation</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="c1">// had to store in var rather than pass as an argument as requestAnimationFrame doesn&#39;t have any way to pass an argument :-(</span>
        <span class="nx">raf</span><span class="p">();</span>

        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>At the end of that loop we put in a quick conditional check that calls the <code>resetOptions</code> function only when no matches from the previous loops were found… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// User must have clicked on an item that couldn&#39;t have been moved</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">resetOptions</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>So the entire chunk of code (two loops and conditional statement) looks like this… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Check if we can move the selected piece into the empty space (e.g. can only move selected piece up, down, left and right, not diagonally)</span>
<span class="k">while</span> <span class="p">(</span><span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">x</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">y</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// We then loop through the shuffled puzzle order looking for the piece that was selected by the user</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasX</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">&amp;&amp;</span> 
                <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasY</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">)</span> <span class="p">{</span>

                <span class="c1">// We&#39;ll keep track of how far the piece has moved</span>
                <span class="nx">pieceMovedX</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">;</span>
                <span class="nx">pieceMovedY</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">;</span>

                <span class="c1">// We&#39;ll also keep track of the original selected piece as we&#39;ll need these co-ordinates for resetting the empty space</span>
                <span class="nx">storeSelectedX</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">;</span>
                <span class="nx">storeSelectedY</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">;</span>

                <span class="c1">// Animate the piece into place</span>
                <span class="nx">foundPieceForAnimation</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="c1">// had to store in var rather than pass as an argument as requestAnimationFrame doesn&#39;t have any way to pass an argument :-(</span>
                <span class="nx">raf</span><span class="p">();</span>

                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// User must have clicked on an item that couldn&#39;t have been moved</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">resetOptions</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>Within the second loop (once we&#39;ve made a match) we now need to begin the actual process of animating the selected puzzle piece into the empty space.</p>
<p>We do this by calling the <code>raf</code> function which itself sets-up the <code>requestAnimationFrame</code> and then calls the <code>animate</code> function… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">raf</span><span class="p">(){</span>
    <span class="nx">interval</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">raf</span><span class="p">);</span>
    <span class="nx">animate</span><span class="p">(</span><span class="nx">foundPieceForAnimation</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…when <code>animate</code> is called we pass through the relevant puzzle piece. The <code>animate</code> function first clears the space where the selected piece last was found and then checks to see if we need to update the &#39;x&#39; or &#39;y&#39; co-ordinates… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Clear the space where the selected piece is currently</span>
<span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">pieceMovedX</span><span class="p">,</span> <span class="nx">pieceMovedY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

<span class="c1">// We don&#39;t want to move the x/y co-ordinates if they&#39;re already the same</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">pieceMovedX</span> <span class="o">!==</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">coord</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">;</span>
    <span class="c1">// Check which direction the piece needs to move in</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pieceMovedX</span> <span class="o">&gt;</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">pieceMovedX</span> <span class="o">-=</span> <span class="nx">moveAmount</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">pieceMovedX</span> <span class="o">+=</span> <span class="nx">moveAmount</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pieceMovedY</span> <span class="o">!==</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">coord</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span><span class="p">;</span>
    <span class="c1">// Check which direction the piece needs to move in</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pieceMovedY</span> <span class="o">&gt;</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">pieceMovedY</span> <span class="o">-=</span> <span class="nx">moveAmount</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">pieceMovedY</span> <span class="o">+=</span> <span class="nx">moveAmount</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…once the co-ordinates are updated we then re-draw the puzzle piece into the next position and keep going until we reach the end of the animation. </p>
<p>We check for the end of the animation by looking at the current co-ordinates of the puzzle piece compared to the final co-ordinates and if there is a match we stop the animation by clearing the time out and drawing the image one last time into it&#39;s final position. </p>
<p>We then update the co-ordinates for that now moved puzzle piece so it thinks it was last drawn in the same position as what once was an empty space. We then update the empty space co-ordinates so they point to where the selected puzzle piece just came from (confused yet?!)</p>
<p>Lastly, we call <code>resetOptions</code> and do one final check to see if all the pieces are now in the end position and thus the end of the game…</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">direction</span> <span class="o">&amp;&amp;</span> <span class="nx">coord</span> <span class="o">===</span> <span class="s2">&quot;x&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">pieceMovedX</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">||</span> 
    <span class="nx">direction</span> <span class="o">&amp;&amp;</span> <span class="nx">coord</span> <span class="o">===</span> <span class="s2">&quot;y&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">pieceMovedY</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">||</span> 
    <span class="o">!</span><span class="nx">direction</span> <span class="o">&amp;&amp;</span> <span class="nx">coord</span> <span class="o">===</span> <span class="s2">&quot;x&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">pieceMovedX</span> <span class="o">&lt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">||</span> 
    <span class="o">!</span><span class="nx">direction</span> <span class="o">&amp;&amp;</span> <span class="nx">coord</span> <span class="o">===</span> <span class="s2">&quot;y&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">pieceMovedY</span> <span class="o">&lt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">global</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span><span class="p">(</span><span class="nx">interval</span><span class="p">);</span>

    <span class="c1">// Draw one last time directly into the empty space</span>
    <span class="c1">// Note: I was finding that because of the loop interation sometimes the y position would be -2 or 2+ but I decided that near enough the position drawing directly into the empty space the user wont even notice</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">piece_to_move</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">piece_to_move</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

    <span class="c1">// Also update the drawnOnCanvasX/Y properties so they reflect the last place on the canvas they were drawn</span>
    <span class="nx">piece_to_move</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
    <span class="nx">piece_to_move</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

    <span class="c1">// Reset the empty space co-ordinates to be where the image we&#39;ve just moved was.</span>
    <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">storeSelectedX</span><span class="p">;</span>
    <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">storeSelectedY</span><span class="p">;</span>

    <span class="nx">resetOptions</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">checkIfGameFinished</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">drawBackMissingPiece</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Then redraw it into the empty space</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">piece_to_move</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">piece_to_move</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">pieceMovedX</span><span class="p">,</span> <span class="nx">pieceMovedY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<h3><a name="drag-and-drop-interaction"class="anchor" href="#drag-and-drop-interaction"><span class="header-link"></span></a>Drag and Drop interaction</h3>
<p>So now we&#39;ve been through the automatic moving of puzzle pieces lets start looking at how the &#39;drag and drop&#39; route works.</p>
<p>So if you remember we had a conditional that was checking if the variable <code>drag</code> was true or false. But it would check the value after a few milliseconds (which was long enough for our program to change the value of <code>drag</code> to true if the user had kept their click/touch down - signifying they intended to drag the puzzle piece).</p>
<p>If the user intended to drag the piece we would call the appropriately named function <code>startDrag</code>… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">selected_piece</span><span class="p">,</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
    <span class="nx">j</span> <span class="o">=</span> <span class="nx">canvas_grid</span><span class="p">,</span>
    <span class="nx">potential_spaces</span><span class="p">,</span>
    <span class="nx">eventX</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetX</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> 
    <span class="nx">eventY</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetY</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">setUp</span><span class="p">(){</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

    <span class="nx">dragCanvasContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

    <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">move</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

    <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">=</span> <span class="nx">eventX</span> <span class="o">-</span> <span class="p">(</span><span class="nx">piece_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">=</span> <span class="nx">eventY</span> <span class="o">-</span> <span class="p">(</span><span class="nx">piece_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

<span class="nx">eventObject</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">handleEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">dragPiece</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">current_piece</span> <span class="o">=</span> <span class="nx">selected_piece</span> <span class="o">=</span> <span class="nx">findSelectedPuzzlePiece</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">eventX</span><span class="p">,</span> <span class="nx">eventY</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">allow_input</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">potential_spaces</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">-</span> <span class="nx">piece_height</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">-</span> <span class="nx">piece_width</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">+</span> <span class="nx">piece_height</span>
        <span class="p">}</span>
    <span class="p">];</span>

    <span class="nx">outer_loop</span><span class="o">:</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">x</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">y</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasX</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">&amp;&amp;</span> 
                    <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasY</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">)</span> <span class="p">{</span>

                     <span class="nx">selected_piece</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                     <span class="nx">setUp</span><span class="p">();</span>
                     <span class="k">break</span> <span class="nx">outer_loop</span><span class="p">;</span>

                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">resetOptions</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>            
    <span class="nx">setUp</span><span class="p">();</span>            
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…OK so there is a fair bit going on here so lets analyse what&#39;s happening. </p>
<p>First we see the varible declarations, we expect this now and know that they relate to things used throughout this function.</p>
<p>Next we have a function called <code>setUp</code> which we&#39;ll ignore for now as this is what actually starts the &#39;drag and drop&#39;. </p>
<p>The rest of this function is actually a repeat of code from the <code>movePiece</code> function! So although it looks a lot you&#39;ve already seen most of it any way. But before we discuss this further lets quickly look at the code after the <code>setUp</code> function… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">=</span> <span class="nx">eventX</span> <span class="o">-</span> <span class="p">(</span><span class="nx">piece_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">=</span> <span class="nx">eventY</span> <span class="o">-</span> <span class="p">(</span><span class="nx">piece_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

<span class="nx">eventObject</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">handleEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">dragPiece</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">current_piece</span> <span class="o">=</span> <span class="nx">selected_piece</span> <span class="o">=</span> <span class="nx">findSelectedPuzzlePiece</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">eventX</span><span class="p">,</span> <span class="nx">eventY</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>…so here we&#39;re setting some global properties (they need to be global because we want to be able to change them from outside of this function) to store the users selected co-ordinates. You&#39;ll notice that I&#39;ve named them quite generically. The reason I did that was because this game works for mouse and touch based devices I didn&#39;t want to call them <code>click_positionX</code> because then on a touch device that wouldn&#39;t have strictly been true (anal I know).</p>
<p>The <code>eventObject</code> is the listener for the &#39;move&#39; event (which as you already know is an alias for either <code>mousemove</code> or <code>touchmove</code> depending on device support). It&#39;s called by the listener within the <code>setUp</code> function. I&#39;ll come back to this later when I start discussing the <code>setUp</code> function.</p>
<p>And finally we store a reference to the currently selected puzzle piece.</p>
<p>OK, now we come to the conditional statement… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">allow_input</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Move piece into available empty space.</span>
    <span class="c1">// There are 4 potential spaces around the selected piece which it can move in (diagonal doesn&#39;t count - as we&#39;re not worrying about the &#39;drag and drop&#39; yet)</span>
    <span class="c1">// So loop through each of them checking to see if any of their co-ordinates match the empty space</span>
    <span class="c1">// If they do match then move the selected piece into that space and set the selected piece to be the new empty space</span>
    <span class="nx">potential_spaces</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">-</span> <span class="nx">piece_height</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">-</span> <span class="nx">piece_width</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">+</span> <span class="nx">piece_height</span>
        <span class="p">}</span>
    <span class="p">];</span>

    <span class="c1">// Check if we can move the selected piece into the empty space (e.g. can only move selected piece up, down, left and right, not diagonally)</span>
    <span class="c1">// We use a labelled statement to break out of the outer loop once a match is found within the inner loop</span>
    <span class="nx">outer_loop</span><span class="o">:</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">x</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">y</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// We then loop through the shuffled puzzle order looking for the piece that was selected by the user</span>
            <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasX</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">&amp;&amp;</span> 
                    <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasY</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">)</span> <span class="p">{</span>

                     <span class="nx">selected_piece</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                     <span class="nx">setUp</span><span class="p">();</span>
                     <span class="k">break</span> <span class="nx">outer_loop</span><span class="p">;</span>

                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// User must have clicked on an item that couldn&#39;t have been moved</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// this is so when the mouseup/touchend event is triggered we can catch this error out inside toggleDragCheck() which otherwise would reset drag=false and cause problems with the user&#39;s next interaction</span>
        <span class="nx">resetOptions</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>            
    <span class="nx">setUp</span><span class="p">();</span>            
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…the purpose of this is to see if we&#39;re allowed to move &#39;illegal&#39; puzzle pieces. If we aren&#39;t allowed to move them then we have a whole load of code which is repeated from the <code>movePiece</code> function and as you now already know it just works out if the puzzle piece selected is illegal or not. Now the reason I didn&#39;t just abstract this code into a separate function is because it has some slight tweaks to it (but mainly the code is the same). The tweaks are things like providing a &#39;labelled statement&#39; for the outer while loop <code>outer_loop: while (j--)</code> (which makes it easer for us to break out of both loops, otherwise we&#39;d have to set a variable in the inner loop for the outer loop to check against to see if it needed to break).</p>
<p>The <code>else</code> statement just calls the <code>setUp</code> function as it doesn&#39;t have to worry about checking if the puzzle piece is legal or not, it knows whatever was selected can be moved.</p>
<p>Now we get to the <code>setUp</code> function itself… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">setUp</span><span class="p">(){</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

    <span class="nx">dragCanvasContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

    <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">move</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

    <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…so the first line removes the puzzle piece from the canvas now we know which piece it is.</p>
<p>Next we draw the puzzle piece onto the top canvas which handles the user interaction.</p>
<p>Then we set-up the event listener so that we call the <code>dragPiece</code> function (which is specified within the <code>eventObject</code>) every time the user moves either their mouse cursor or their finger.</p>
<p>Lastly we set <code>event_moving</code> to true which is useful for doing some checks later on to make sure the user&#39;s next interaction isn&#39;t broken.</p>
<p>But lets just quickly review the <code>eventObject</code>. Most people don&#39;t realise that with <code>addEventListener</code> you don&#39;t have to specify a function to be the listener and that you can specify an object, but that object must have a <code>handler</code> property with a function assigned to it which acts as the listener. The reason I&#39;ve used an object rather than a straight function is because I wanted to pass some additional parameters but couldn&#39;t of done that otherwise without using an anonymous function and if you don&#39;t know: it&#39;s best to avoid using anonymous functions for an event listener because if you do then you wont be able to remove the event listener (without maybe building your own abstraction of the events API to workaround the issue - I wont go into the details of why you can&#39;t remove an anonymous function referenced event listener as that&#39;s outside the scope of this post, but suffice to say it&#39;s similar to checking if <code>{} == {}</code>).</p>
<p>We&#39;ve now reached the <code>dragPiece</code> function… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">eventX</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetX</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> 
    <span class="nx">eventY</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetY</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">,</span>
    <span class="nx">storeSelectedX</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
    <span class="nx">storeSelectedY</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">,</span>
    <span class="nx">halfWidth</span> <span class="o">=</span> <span class="nx">piece_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nx">halfHeight</span> <span class="o">=</span> <span class="nx">piece_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

<span class="nx">dragCanvasContext</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

<span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">=</span> <span class="nx">eventX</span> <span class="o">-</span> <span class="nx">halfWidth</span><span class="p">;</span>
<span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">=</span> <span class="nx">eventY</span> <span class="o">-</span> <span class="nx">halfHeight</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">&lt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">piece_width</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">&lt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">piece_height</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">+</span> <span class="nx">piece_height</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">+</span> <span class="nx">piece_width</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">highlightEmptySpace</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Check if mouse is over the empty space or not</span>
<span class="k">if</span> <span class="p">((</span><span class="nx">eventX</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">eventX</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">eventY</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">eventY</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">piece_height</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">move</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
    <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
    <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
    <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">storeSelectedX</span><span class="p">;</span>
    <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">storeSelectedY</span><span class="p">;</span>
    <span class="nx">stopDrag</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>    
    <span class="nx">dragCanvasContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…so again lets look through what&#39;s happening.</p>
<p>The <code>halfWidth</code> and <code>halfHeight</code> variables are there because when we draw the puzzle piece onto the top canvas we want the puzzle piece to be centered to the mouse cursor/user&#39;s touch.</p>
<p>The line:</p>
<p><code>dragCanvasContext.clearRect(global.user_positionX, global.user_positionY, piece_width, piece_height);</code></p>
<p>…clears where the puzzle piece was last drawn. We then update the co-ordinates for mouse/touch position…</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">=</span> <span class="nx">eventX</span> <span class="o">-</span> <span class="nx">halfWidth</span><span class="p">;</span>
<span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">=</span> <span class="nx">eventY</span> <span class="o">-</span> <span class="nx">halfHeight</span><span class="p">;</span>
</pre></div>
</code></pre>
<p>…the next step is to see if the user has moved the puzzle piece &#39;near&#39; the empty space. The way we do this is we highlight the empty space so it has a red background whenever the user moves 20px within it. This is so they are aware that at any point soon the puzzle piece will be dropped into this empty space… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">&lt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">piece_width</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">&lt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">piece_height</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">+</span> <span class="nx">piece_height</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">+</span> <span class="nx">piece_width</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">highlightEmptySpace</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…the <code>else</code> statement is there for when the user moves the puzzle piece to a position that is again outside of the puzzle piece (e.g. we remove the red background).</p>
<p>Now we just have one more conditional statement before we reach the end of the function… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">if</span> <span class="p">((</span><span class="nx">eventX</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">eventX</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">eventY</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">eventY</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">piece_height</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">move</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
    <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
    <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
    <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">storeSelectedX</span><span class="p">;</span>
    <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">storeSelectedY</span><span class="p">;</span>
    <span class="nx">stopDrag</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>    
    <span class="nx">dragCanvasContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…here we check to see if the mouse/touch is over the empty space and if it is we then remove the <code>move</code> event (as there is no point calling it again now we&#39;ve placed the puzzle piece in the empty space). After that we update some of the properties such as <code>event_moving</code>, <code>empty_space</code> object and the <code>drawnOnCanvas</code> properties and then we call the <code>stopDrag</code> function which we&#39;ll get to in a few moments.</p>
<p>If the user isn&#39;t over the empty space then the <code>else</code> statement kicks in and we simply draw the puzzle piece onto the canvas in the current mouse/touch position.</p>
<p>So now lets look at the contents of the <code>stopDrag</code> function… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">move</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">up</span><span class="p">,</span> <span class="nx">toggleDragCheck</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="nx">wasJustDragging</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">resetOptions</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">checkIfGameFinished</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">drawBackMissingPiece</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…the first thing we do is remove the &#39;move&#39; event - <em>now to be honest, as I&#39;m writing this post a few weeks after completing the game, I&#39;m not sure why I&#39;m removing the event again in that section as it should have already been removed? I&#39;ll leave this in for now and re-evaluate the code at a later date to see if it is indeed as redundant as it appears to be now</em> - then we update <code>wasJustDragging</code> so we know that we just completed a drag and drop motion. Then we call the <code>resetOptions</code> function (which we went over earlier) and finally we call the function <code>checkIfGameFinished</code> which nicely leads us into our final section… </p>
<h3><a name="determining-the-end-of-game"class="anchor" href="#determining-the-end-of-game"><span class="header-link"></span></a>Determining the end of game</h3>
<p>The <code>checkIfGameFinished</code> function simply loops through all puzzle pieces to see if they match the correct order… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">checkIfGameFinished</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">copied_puzzle_randomised</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="nx">copied_puzzle_randomised</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">random_number</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">removed_piece</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">complete</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="nx">complete</span> <span class="o">=</span> <span class="nx">copied_puzzle_randomised</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">===</span> <span class="nx">item</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">===</span> <span class="nx">item</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> 
        <span class="c1">// The final piece is actually the missing piece so we check the x/y against the empty_space x/y</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">x</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">y</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">complete</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…some other things to note about the <code>checkIfGameFinished</code> function is that we copy the <code>puzzle_randomised</code> Array and add back in the missing piece before we then check all the co-ordinates are correct and match (you&#39;ll see we&#39;re setting the variable <code>complete</code> to be the return value of the Array method <code>every</code> and then the function returns <code>complete</code> which will be either true or false (see: <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/every"><a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/every">https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/every</a></a> for details).</p>
<p>Quickly now we&#39;ll jump back to the <code>stopDrag</code> function where we&#39;ll see that if <code>checkIfGameFinished</code> returns true then we&#39;ll call <code>drawBackMissingPiece</code> which (as you would expect by the name of the function) draws the missing puzzle piece back onto the canvas as we know the game is complete and then displays an <code>alert</code> which tells the user the game is complete (this part you can change to suit your needs).</p>
<p>And now! finally! we have reached the end of this post :-)</p>
<p>Hopefully this has made <em>some</em> sense? I would say &quot;go through the code and see how everything works&quot; - and you can do that obviously - but with things of this nature they can get quite complex and there are problems the developer goes through and works around which might not be clear in the code itself (I&#39;ve tried to document the reasoning behind most of the code so hopefully that will help).</p>
<p>But any questions then just let me know.</p>
</div>

  <div class="comments">
    <a href="/posts/building-a-game-with-html5-canvas/#comments">
      <span class="icon-bubbles"></span>
      Comments
    </a>
  </div>


<div class="pagination group">
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
      <a href="/page/9/" class="newer"> Newer &#8594;</a>
    
  
    
    
  
    
    
      <a href="/page/11/" class="older"> &#8592; Older</a>
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
</div>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js" type="text/javascript"></script>
    <script src="/scripts/main.js" type="text/javascript"></script>
    <script src="/scripts/Imager.js" type="text/javascript"></script>
    <script>
        var _gaq=[['_setAccount','UA-33159515-1'],['_trackPageview']];
        (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
        g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>
  </body>
</html>

