<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/images/cabin.png" >
    <link href="/styles/main.css" rel="stylesheet">
    
    <title>Integralist -> BBC News Engineer</title>
    
    
    <link rel="alternate" type="application/atom+xml" title="Integralist" href="http://feeds.feedburner.com/Integralist">
  </head>
  <body>
    <nav>
      <h1 class="name">
          <a href="/">Integralist</a> <span class="role">BBC News Engineer</span>
      </h1>
      <div class="menu icon-menu"></div>
      <ul class="nav-links">
        <li class="text-link">
          <a href="/about.html">about</a>
        </li>
        <li class="text-link">
          <a href="/projects.html">projects</a>
        </li>
        <li class="text-link">
          <a href="/archives.html">archives</a>
        </li>
      </ul>
      <div class="social-media">
        <a href="https://github.com/integralist" class="icon-github"></a>
        <a href="https://twitter.com/integralist" class="icon-twitter"></a>
      </div>
    </nav>
    <div class="content">


  <div class="post-head group">
  <a href="/posts/introduction-to-ruby/">
    <h1 class="post-title">Introduction to Ruby</h1>
  </a>
  <span class="post-date">2012 &#183; 6 &#183; 18</span>
</div>

<div class="post-body"><h2><a name="what-well-cover" class="anchor" href="#what-well-cover"><span class="header-link"></span></a>What we&#39;ll cover</h2>
<p><em>reading time: approx. 27mins</em></p>
<ul>
<li>Introduction</li>
<li>Installing Ruby</li>
<li>The Interactive Ruby Console</li>
<li>How to execute Ruby scripts</li>
<li>Comments</li>
<li>Variables</li>
<li>Magic Variables</li>
<li>Constants</li>
<li>Symbols</li>
<li>Functions/Methods</li>
<li>Blocks</li>
<li>Lambdas/Procs</li>
<li>Classes</li>
<li>Loops</li>
<li>Conditionals</li>
<li>Strings</li>
<li>Arrays</li>
<li>Hashes</li>
<li>Numbers (and how &#39;everything is an object&#39; - similar to JavaScript)</li>
<li>Conclusion</li>
</ul>
<h2><a name="introduction" class="anchor" href="#introduction"><span class="header-link"></span></a>Introduction</h2>
<p>I&#39;ve not had much experience with the Ruby programming language, but with the arrival of JavaScript pre-processors such as CoffeeScript and the new features being added to ES5 (even more so in ES6), these new additions are pushing the JavaScript language to be more &#39;functional&#39; and thus similar in syntax to Ruby. </p>
<p>Looking at CoffeeScript I wasn&#39;t convinced. I like the JavaScript syntax, I think it&#39;s actually quite a beautiful language (when written correctly). But I decided that the future is just around the corner so why wait to see what all the fuss is about. In my mind, the best way to get involved with the new JavaScript/CoffeeScript style syntax is to investigate some of its inspirations which (seem to) stem from Ruby.</p>
<p>What I found though was that Ruby is itself an amazingly flexible and beautiful language. Very expressive and a joy to write and use (and to look at). </p>
<p>Warning: this introduction assumes you have prior programming knowledge (doesn&#39;t matter really whether it&#39;s JavaScript or C# as long as you&#39;ve had some programming experience). I&#39;m not going to be explaining the basics of what are &#39;expressions&#39;, &#39;block statements&#39;, &#39;variables&#39;, &#39;arrays&#39;, &#39;functions/methods&#39; etc.</p>
<p>So without further ado, here we go…</p>
<p><em>Ps, <a href="http://rubymonk.com/"><a href="http://rubymonk.com/toc">http://rubymonk.com/toc</a></a> looks like a pretty good learning resource - I&#39;ve only taken a quick peek at it so far but it looks interesting</em></p>
<h2><a name="installing-ruby" class="anchor" href="#installing-ruby"><span class="header-link"></span></a>Installing Ruby</h2>
<p>UPDATE: I&#39;ve found a super sweet way to get multiple versions of Ruby installed onto your Mac (notice I said Mac, not PC - so if you&#39;re on Windows then I&#39;m afraid I can&#39;t help you).</p>
<p>First install <a href="https://github.com/sstephenson/ruby-build">Ruby-Build</a> - preferable via the Mac package manager <a href="http://mxcl.github.com/homebrew/">Homebrew</a> using the command <code>brew install ruby-build</code>.</p>
<p>Then install the Ruby switcher <a href="https://github.com/hmans/rbfu">rbfu</a> using the command <code>brew install http://git.io/rbfu.rb</code> - make sure you update your shell startup script (<code>~/.zshrc</code> if your&#39;re using Zsh or <code>~/.bashrc</code>/<code>~/.bash_profile</code> etc if you&#39;re using Bash) to include the line <code>eval &quot;$(rbfu --init --auto)&quot;</code> (this information is documented on the rbfu github README so go there for more info, if you need it).</p>
<p>Then once those two items are installed you can start installing different Ruby versions using ruby-build and switching Ruby versions using rbfu.</p>
<p>To install a new Ruby version, first check which ones are available by running the command: <code>ruby-build --definitions</code> - this will list all Ruby versions available to install.</p>
<p>Pick a version (for example <code>2.0.0-preview2</code>) and run the command:  </p>
<p><code>ruby-build 2.0.0-preview2 $HOME/.rbfu/rubies/2.0.0-preview2</code></p>
<p>That takes care of installing that particular version of Ruby, but now for you to switch to using that version you need to create a <code>.ruby-version</code> file and place it inside the directory of your Ruby application. The content of that file should be <code>2.0.0-preview2</code> or whatever version of Ruby you have installed (via Ruby Build) that you want to run for that application.</p>
<p>Now when you <code>cd</code> into that directory where your <code>.ruby-version</code> file is located you&#39;ll noticed the Terminal will state that it has activated the specific Ruby version requested.</p>
<p>If for some reason you create a <code>.ruby-version</code> file but forget to run the Ruby Build install for the requested version then the Terminal will display a message to let you know that you need to install the requested version of Ruby.</p>
<p>Below are my original notes, but you can ignore these now.</p>
<hr>
<p><del>~OK, this was an absolute bitch to get set-up. Luckily for you, I&#39;ve suffered so you don&#39;t have to (hopefully).</del>~</p>
<p><del>~I&#39;m running Mac OSX so your mileage may vary.</del>~</p>
<p><del>~If you can get away with it, use the package manager homebrew to install: <code>brew install ruby</code>.</del>~</p>
<p><del>~But homebrew didn&#39;t work for me. It said it installed, but I couldn&#39;t get it to switch from the default Ruby 1.8 the Mac has pre-installed. So the next step was to install what is called &#39;rvm&#39; which lets you install and manage multiple versions of Ruby.</del>~</p>
<p><del>~The process is as follows (open the Terminal and start typing):</del>~</p>
<p><del>~1. <code>bash -s stable &lt; &lt;(curl -s https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer)</code>. After rvm is installed you&#39;ll see a message asking you to to run the following...</del>~</p>
<p><del>~2. <code>source /Users/&lt;username&gt;/.rvm/scripts/rvm</code>. Remember to replace <code>&lt;username&gt;</code> with the name of your computer.</del>~</p>
<p><del>~3. <code>rvm install 1.9.3 --with-gcc=clang</code>. The <code>--with-gcc=clang</code> was suggested on Stack Overflow to fix issues Mac OSX Lion users were having trying to upgrade to the latest Ruby version 1.9.3. This worked fine at home, but at work it failed so instead I executed… <code>rvm install ruby-1.9.3-p125</code></del>~</p>
<p><del>~4. <code>rvm use 1.9.3 --default</code>. We&#39;re now telling rvm to use version 1.9.3 as the default version of Ruby</del>~</p>
<p><del>~5. <code>ruby -v</code> - just check the version quickly to be sure</del>~</p>
<h2><a name="the-interactive-ruby-console" class="anchor" href="#the-interactive-ruby-console"><span class="header-link"></span></a>The Interactive Ruby Console</h2>
<p>Beginners are advised to use the interactive Ruby console to get to know the language. So to start it up, in your Terminal type: <code>irb</code> (and if you want to quit use: <code>Ctrl+D</code>).</p>
<p>From irb you can start typing out code and seeing what the results are.</p>
<p>For example to display something you would use <code>puts</code> (this is similar to <code>Reponse.Write</code> in ASP or <code>echo</code> in PHP, or even <code>document.write</code> - <em>never use that!</em> - in JavaScript) like so <code>puts &quot;Hello World&quot;</code>. There is also <code>print</code> but be warned that although it looks similar it&#39;s not the same as <code>puts</code>.</p>
<p>Take the following example…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="mi">5</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span>
    <span class="nb">print</span> <span class="s2">&quot;This gets written five times&quot;</span>
    <span class="nb">sleep</span> <span class="mi">2</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…which every two seconds displays the sentence &quot;This gets written five times&quot;…</p>
<p><code>This gets written five timesThis gets written five timesThis gets written five timesThis gets written five timesThis gets written five times</code></p>
<p>…and returns <code>=&gt; 5</code>. Notice the sentence is printed on one line. If you were to change <code>print</code> to <code>puts</code> it would automatically generate a newline for you making it easier to read. </p>
<p>As far as I understand it, the other more subtle difference is that <code>print</code> buffers the output, so rather than displaying the sentence every two seconds it waits until ten seconds (2 seconds * 5 times) before printing the sentence five times. Now, I tried this myself both via <code>irb</code> and via a standard Ruby script but <code>print</code> definitely was executing every two seconds, so this may only occur under certain environments - but it&#39;s still worth being aware of. See <a href="http://mattberther.com/2009/02/11/puts-vs-print-in-ruby">this article</a> which is where I first heard about this subtle difference.</p>
<h2><a name="how-to-execute-ruby-scripts" class="anchor" href="#how-to-execute-ruby-scripts"><span class="header-link"></span></a>How to execute Ruby scripts</h2>
<p>Simply create a file with an extension of <code>.rb</code> and at the top of that file include the following line… </p>
<p><code>#!/usr/bin/env ruby</code></p>
<p>…this tells the operating system how to handle the file (e.g. tell it to use the Ruby parser to execute the file).</p>
<p>Then within the Terminal application, <code>cd</code> to the directory where that file is located and execute the command <code>ruby name_of_file.rb</code></p>
<h2><a name="comments" class="anchor" href="#comments"><span class="header-link"></span></a>Comments</h2>
<p>In Ruby you have single line comments <code># this is a comment</code> and multi-line comments:</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="cm">=begin</span>
<span class="cm">    Lots and lots of</span>
<span class="cm">    code that I want</span>
<span class="cm">    to comment out all at once</span>
<span class="cm">=end</span>
</pre></div>
</code></pre>
<p>With multi-line comments there must be no whitespace before the <code>=begin</code> and <code>=end</code> statements otherwise your script will throw an error.</p>
<h2><a name="variables" class="anchor" href="#variables"><span class="header-link"></span></a>Variables</h2>
<p>Variables do not have to be declared. So you can literally write <code>a = 123</code>.</p>
<p>You can assign multiple variables at once like so…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>     <span class="c1"># which is effectively the same as x = 1, y = 2</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>     <span class="c1"># which switches the values of each variable</span>
<span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">]</span> <span class="c1"># assign each array item value to a variable, so x = 1, y = 2, z = 3</span>
</pre></div>
</code></pre>
<p>Variables in JavaScript typically come in two flavours: Global and Local. In JavaScript if you declare a variable with the <code>var</code> syntax then the variable is added as a property to the global object (which depending on the environment JavaScript is running in) most of the time will be the <code>window</code> object. If you declare a variable inside of a function in JavaScript using the <code>var</code> syntax then that variable is only available within that function (unless it&#39;s accessible via some priviledged object).</p>
<p>In Ruby, if you declare a variable inside a function with no prefix then it is only available within that function. If you prefix it with a dollar sign (e.g. <code>$my_var = 123</code>) then that declares it as a global variable and is accessible from any where in the program.</p>
<p>When using Classes, if you declare a variable within the class using an <code>@</code> prefix (e.g. <code>@my_var = 123</code>) then that variable is available to the object created by that class only (also known as an &#39;instance variable&#39;). Where as a double <code>@@</code> (e.g. <code>@@my_var = 123</code>) is known as a &#39;class variable&#39; which means it is available to all objects created by that particular class and any changes to this class variable is reflected in all objects created from that class. </p>
<p>So for example, if I have a class called &quot;MyClass&quot; and inside of it I set <code>@@my_var</code> to equal 456 instead of 123 then every object created from &quot;MyClass&quot; will have <code>my_var</code> set to 456. Whereas if &quot;MyClass&quot; had <code>@my_var</code> set to 123 and I create a new object from that class and set <code>@my_var</code> to 456 - an &#39;instance variable&#39; - then only that object would see the value of <code>@my_var</code> as 456, all other objects created from the class would still see the value as 123. It sounds tricky but it&#39;s not that bad really. Here is an example of what the above was trying to explain… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="c1"># Following classes &#39;MyClass&#39; and &#39;MyClass2&#39; demonstrate difference between &#39;class variable&#39; and &#39;instance variable&#39;</span>
<span class="k">class</span> <span class="nc">MyClass</span>
    <span class="k">def</span> <span class="nf">initialize</span>
        <span class="vc">@@class_var</span> <span class="o">=</span> <span class="mi">123</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">showValue</span>
        <span class="nb">puts</span> <span class="vc">@@class_var</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">setValue</span>
        <span class="vc">@@class_var</span> <span class="o">=</span> <span class="mi">456</span><span class="p">;</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">MyClass2</span>
    <span class="k">def</span> <span class="nf">initialize</span>
        <span class="vi">@class_var</span> <span class="o">=</span> <span class="mi">123</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">showValue</span>
        <span class="nb">puts</span> <span class="vi">@class_var</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">setValue</span>
        <span class="vi">@class_var</span> <span class="o">=</span> <span class="mi">456</span><span class="p">;</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="c1">#############################</span>

<span class="c1"># This is the &#39;class variable&#39;</span>

<span class="n">objA</span> <span class="o">=</span> <span class="no">MyClass</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">objB</span> <span class="o">=</span> <span class="no">MyClass</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="n">objA</span><span class="o">.</span><span class="n">showValue</span> <span class="c1"># =&gt; 123</span>
<span class="n">objB</span><span class="o">.</span><span class="n">showValue</span> <span class="c1"># =&gt; 123</span>

<span class="n">objA</span><span class="o">.</span><span class="n">setValue</span>

<span class="n">objA</span><span class="o">.</span><span class="n">showValue</span> <span class="c1"># =&gt; 456</span>
<span class="n">objB</span><span class="o">.</span><span class="n">showValue</span> <span class="c1"># =&gt; 456</span>

<span class="c1">#############################</span>

<span class="c1"># This is the &#39;instance variable&#39;</span>

<span class="n">objC</span> <span class="o">=</span> <span class="no">MyClass2</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">objD</span> <span class="o">=</span> <span class="no">MyClass2</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="n">objC</span><span class="o">.</span><span class="n">showValue</span> <span class="c1"># =&gt; 123</span>
<span class="n">objD</span><span class="o">.</span><span class="n">showValue</span> <span class="c1"># =&gt; 123</span>

<span class="n">objC</span><span class="o">.</span><span class="n">setValue</span>

<span class="n">objC</span><span class="o">.</span><span class="n">showValue</span> <span class="c1"># =&gt; 456</span>
<span class="n">objD</span><span class="o">.</span><span class="n">showValue</span> <span class="c1"># =&gt; 123</span>
</pre></div>
</code></pre>
<h2><a name="magic-variables" class="anchor" href="#magic-variables"><span class="header-link"></span></a>Magic Variables</h2>
<p>There are &#39;magic&#39; variables (like predefined variables in PHP).</p>
<p>For example you have <code>__FILE__</code> which refers to the current file being executed and there is also <code>$0</code> which refers to the file used to start the program. I mention these two specifically because these are used in the getting started examples on the <a href="http://www.ruby-lang.org/">Ruby website</a>.</p>
<h2><a name="constants" class="anchor" href="#constants"><span class="header-link"></span></a>Constants</h2>
<p>Constants are variables that cannot be changed once they are set. Any variable that is capitalised (e.g. <code>Myconstant</code>) is made into a constant. </p>
<p>In other languages a constant is normally either prefixed with the keyword <code>constant Myconstant</code> or is all caps <code>MYCONSTANT</code>.</p>
<p>If you try to overwrite a constant you&#39;ll get the following message: <code>warning: already initialized constant</code> - although as far as I can tell by testing this in irb it seems to change the constant and only warns you rather than actually preventing you from changing the value? <strong><em>Maybe a Rubyist reading this can clarify if this is expected behaviour.</em></strong> </p>
<h2><a name="symbols" class="anchor" href="#symbols"><span class="header-link"></span></a>Symbols</h2>
<p>Symbols are like static variables (or constants). They are used as identifiers, as a way to keep code cleaner.</p>
<p>If you had lots of hashes (which we&#39;ll come to later) and you have a key/property called &quot;name&quot; then you could write your hash like so…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">hash1</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Mark&quot;</span> <span class="p">}</span>
<span class="n">hash2</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Brad&quot;</span> <span class="p">}</span>
<span class="n">hash3</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ash&quot;</span> <span class="p">}</span>
<span class="n">hash4</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Neil&quot;</span> <span class="p">}</span>
</pre></div>
</code></pre>
<p>…but <code>&quot;name&quot;</code> is being re-created in memory every time it&#39;s referenced. It&#39;s much more energy efficient to use a Symbol which looks like a variable but is prefixed with a colon <code>:name</code>…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">hash1</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Mark&quot;</span> <span class="p">}</span>
<span class="n">hash2</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Brad&quot;</span> <span class="p">}</span>
<span class="n">hash3</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ash&quot;</span> <span class="p">}</span>
<span class="n">hash4</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Neil&quot;</span> <span class="p">}</span>
</pre></div>
</code></pre>
<p>…as you can see, Symbols don&#39;t have values like variables, they are literally just used as efficient identifiers.</p>
<h2><a name="functionsmethods" class="anchor" href="#functionsmethods"><span class="header-link"></span></a>Functions/Methods</h2>
<p>In Ruby everything is an Object (even Strings and Integers) so when you&#39;re defining a function you&#39;re really defining a method (methods are the same as functions but you normally call a function a method when it&#39;s attached to an object).</p>
<p>To define a method the syntax is:</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nf">method_name</span> <span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
    <span class="sr">//</span> <span class="n">function</span> <span class="n">code</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>In JavaScript, if a method doesn&#39;t explicitly specify a return value then it returns <code>undefined</code>. In Ruby a method will return the last expression evaluated in its body, and if there isn&#39;t one then it will return <code>nil</code> (<code>nil</code> is equivalent to <code>null</code> in PHP).</p>
<p>As was noted in the above &#39;Variables&#39; section about variables being able to assigned multiple values, this can come in handy with method returning multiple values as well (which is quite interesting as I&#39;m only used to functions in JavaScript returning a single value)… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nf">myMethod</span> 
    <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span> <span class="c1"># this being the last expression, this is what&#39;s returned</span>
<span class="k">end</span>

<span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">myMethod</span><span class="p">;</span> <span class="c1"># =&gt; a = 1, b = 2</span>
</pre></div>
</code></pre>
<p>You can call a method without parenthesis, e.g. <code>myMethod</code> apposed to <code>myMethod()</code>. The choice is yours whether you use parenthesis or not - personally there are times where I can see myself not needing them and other times using them so it&#39;s crystal clear that what I&#39;m doing is calling a method (time will tell - but I understand a good practice is to use parenthesis whenever a method expects arguments to be passed otherwise there is no point in using them).</p>
<p>But note that with multiple arguments the caller must not have a space between the parenthesis and the function name.</p>
<p>So for example, these work…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">welcome</span><span class="p">(</span><span class="s2">&quot;Mark&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">welcome</span><span class="s2">&quot;Mark&quot;</span><span class="p">,</span> <span class="mi">30</span>
<span class="n">welcome</span> <span class="s2">&quot;Mark&quot;</span><span class="p">,</span> <span class="mi">30</span>
</pre></div>
</code></pre>
<p>…but this doesn&#39;t <code>welcome (&quot;Mark&quot;, 30)</code>.</p>
<p>And calling a method which takes no arguments will also cause an error when called using a space between the method name and the parenthesis.</p>
<p>e.g. <code>Person.speak ()</code> =&gt; error but <code>Person.speak()</code> or <code>Person.speak</code> is fine.</p>
<p>You can specify default values for arguments…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nf">welcome</span> <span class="p">(</span><span class="nb">name</span> <span class="o">=</span> <span class="s2">&quot;World&quot;</span><span class="p">,</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">&quot;Hello </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">!, I see you&#39;re </span><span class="si">#{</span><span class="n">age</span><span class="si">}</span><span class="s2"> years old.&quot;</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>…which can be used as follows…</p>
<p><code>welcome</code> =&gt; Hello World! Looks like you&#39;re 1 today<br><code>welcome &quot;Mark&quot;</code> =&gt; Hello Mark! Looks like you&#39;re 1 today<br><code>welcome &quot;Mark&quot;, 30</code> =&gt; Hello Mark! Looks like you&#39;re 30 today</p>
<p>You can also add new methods to an existing object just by prefixing the name of the method with the relevant object… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nc">Math</span><span class="o">.</span><span class="nf">someNewThing</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> 
    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2"> was here&quot;</span>
<span class="k">end</span>

<span class="no">Math</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="s2">&quot;someNewThing&quot;</span><span class="p">)</span> <span class="c1"># =&gt; true</span>

<span class="no">Math</span><span class="o">.</span><span class="n">someNewThing</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span> <span class="c1"># =&gt; 123 was here</span>
<span class="no">Math</span><span class="o">.</span><span class="n">someNewThing</span><span class="p">(</span><span class="s2">&quot;abc&quot;</span><span class="p">)</span> <span class="c1"># =&gt; abc was here</span>
</pre></div>
</code></pre>
<p>…in Ruby these types of method declarations are referred to as &#39;class methods&#39; (or &#39;singleton methods&#39;)</p>
<p>In a similar example of extending already defined Classes:</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Fixnum</span>
    <span class="k">def</span> <span class="nf">seconds</span>
        <span class="nb">self</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">minutes</span>
        <span class="nb">self</span> <span class="o">*</span> <span class="mi">60</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">hours</span>
        <span class="nb">self</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">days</span>
        <span class="nb">self</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span>
    <span class="k">end</span> 
<span class="k">end</span>

<span class="nb">puts</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
<span class="nb">puts</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="mi">10</span><span class="o">.</span><span class="n">minutes</span>
<span class="nb">puts</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="mi">16</span><span class="o">.</span><span class="n">hours</span>
<span class="nb">puts</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">7</span><span class="o">.</span><span class="n">days</span>
</pre></div>
</code></pre>
<p>Note: you might see methods that are called using a ? at the end, these indicate that the method will return a Boolean value (e.g. <code>respond_to?</code> which you&#39;ll see below in the &#39;Classes&#39; section)… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="o">[]</span>
<span class="n">x</span><span class="o">.</span><span class="n">empty?</span> <span class="c1"># =&gt; true (…or x.empty?() if you prefer the use of parenthesis)</span>

<span class="n">x</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="n">x</span><span class="o">.</span><span class="n">empty?</span> <span class="c1"># =&gt; false</span>
</pre></div>
</code></pre>
<p>If you want to know what methods are available to an object/class then look at the <code>class</code> of the object and then inspect the methods available… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">my_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Mark&quot;</span> <span class="p">}</span>
<span class="n">my_hash</span><span class="o">.</span><span class="n">class</span> <span class="c1"># =&gt; Hash</span>
<span class="no">Hash</span><span class="o">.</span><span class="n">instance_methods</span> <span class="c1"># =&gt; [:rehash, :to_hash, :to_a, :inspect, :to_s, :==, :[], :hash, :eql?, :fetch, :[]=, :store, :default, :default=, :default_proc, :default_proc=, :key, :index, :size, :length, :empty?, :each_value, :each_key, :each_pair, :each, :keys, :values, :values_at, :shift, :delete, :delete_if, :keep_if, :select, :select!, :reject, :reject!, :clear, :invert, :update, :replace, :merge!, :merge, :assoc, :rassoc, :flatten, :include?, :member?, :has_key?, :has_value?, :key?, :value?, :compare_by_identity, :compare_by_identity?, :entries, :sort, :sort_by, :grep, :count, :find, :detect, :find_index, :find_all, :collect, :map, :flat_map, :collect_concat, :inject, :reduce, :partition, :group_by, :first, :all?, :any?, :one?, :none?, :min, :max, :minmax, :min_by, :max_by, :minmax_by, :each_with_index, :reverse_each, :each_entry, :each_slice, :each_cons, :each_with_object, :zip, :take, :take_while, :drop, :drop_while, :cycle, :chunk, :slice_before, :nil?, :===, :=~, :!~, :&lt;=&gt;, :class, :singleton_class, :clone, :dup, :initialize_dup, :initialize_clone, :taint, :tainted?, :untaint, :untrust, :untrusted?, :trust, :freeze, :frozen?, :methods, :singleton_methods, :protected_methods, :private_methods, :public_methods, :instance_variables, :instance_variable_get, :instance_variable_set, :instance_variable_defined?, :instance_of?, :kind_of?, :is_a?, :tap, :send, :public_send, :respond_to?, :respond_to_missing?, :extend, :display, :method, :public_method, :define_singleton_method, :object_id, :to_enum, :enum_for, :equal?, :!, :!=, :instance_eval, :instance_exec, :__send__, :__id__]</span>
</pre></div>
</code></pre>
<h2><a name="blocks" class="anchor" href="#blocks"><span class="header-link"></span></a>Blocks</h2>
<p>In Ruby a <code>code block</code> is any piece of code within either <code>do..end</code> or curly brackets <code>{}</code>. </p>
<p>When creating a method, if you want to pass a code block in as an argument, you need to prefix the argument name with an ampersand <code>&amp;</code> like so…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nf">myfn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">code_block</span><span class="p">)</span>
    <span class="sx">%w(a e I o u)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">vowel</span><span class="o">|</span>
        <span class="n">code_block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">vowel</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">myfn</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">x</span> <span class="p">}</span>
</pre></div>
</code></pre>
<p>…what the above code does is create an Array and then iterates over it. Every item in the Array is passed to the code block (the code block which is passed in as an argument to the method).</p>
<p>But the above can be simplified...</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nf">myfn</span>
    <span class="sx">%w(a e I o u)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">vowel</span><span class="o">|</span>
        <span class="k">yield</span> <span class="n">vowel</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">myfn</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">x</span> <span class="p">}</span>
</pre></div>
</code></pre>
<p>...this isn&#39;t as obvious but is less verbose (the <code>yield</code> keyword automatically detects the code block and passes control to it rather than us having to pass through the code block and executing the <code>call</code> method on the code block).</p>
<h2><a name="lambdasprocs" class="anchor" href="#lambdasprocs"><span class="header-link"></span></a>Lambdas/Procs</h2>
<p>Ruby also has Lambdas and Proc objects. These are similar to Blocks but have some differences worth mentioning.</p>
<h3><a name="procs" class="anchor" href="#procs"><span class="header-link"></span></a>Procs</h3>
<p>Procs are the same as blocks but can be saved into a variable so they are easily reusable. A block on the other hand can&#39;t be reused. It can only be retyped for every method that you want to use it on. </p>
<p>The following is an example of how to use a Proc object instead of Block...</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">my_proc</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">x</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">myfn</span> <span class="n">proc_obj</span>
    <span class="sx">%w(a e I o u)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">vowel</span><span class="o">|</span>
        <span class="n">proc_obj</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">vowel</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">myfn</span> <span class="n">my_proc</span>
</pre></div>
</code></pre>
<p>Notice we use a <code>call</code> method on the Proc object rather than the <code>yield</code> keyword which we use for a Block.</p>
<p>So if you have a one time piece of code you want to pass to a method then a block would make sense, but if you have a piece of code that you want to reuse across multiple methods then best to make it into a Proc object.</p>
<h3><a name="lambdas" class="anchor" href="#lambdas"><span class="header-link"></span></a>Lambdas</h3>
<p>Lambdas are the same as Proc objects but with two slight differences.</p>
<ol>
<li>If you pass in the wrong number of arguments then the lambda will throw <code>ArgumentError</code></li>
<li>If they have a <code>return</code> statement then the whole method wont suddenly return from that point (Proc objects cause the rest of the method to halt)</li>
</ol>
<p>The following is an example of how to use a Proc object instead of Block...</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">my_lambda</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">x</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">myfn</span> <span class="n">lambda_obj</span>
    <span class="sx">%w(a e I o u)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">vowel</span><span class="o">|</span>
        <span class="n">lambda_obj</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">vowel</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">myfn</span> <span class="n">my_lambda</span>
</pre></div>
</code></pre>
<p>Lambdas are very popular in other languages hence it&#39;s inclusion in Ruby (it&#39;s just a nice way to pass around code blocks). </p>
<p>The following example is modified from a test on RubyMonk but is a good example of using lambdas…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nf">with_names</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
  <span class="n">result</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="o">[</span> <span class="o">[</span><span class="s2">&quot;Christopher&quot;</span><span class="p">,</span> <span class="s2">&quot;Alexander&quot;</span><span class="o">]</span><span class="p">,</span>
    <span class="o">[</span><span class="s2">&quot;John&quot;</span><span class="p">,</span> <span class="s2">&quot;McCarthy&quot;</span><span class="o">]</span><span class="p">,</span>
    <span class="o">[</span><span class="s2">&quot;Joshua&quot;</span><span class="p">,</span> <span class="s2">&quot;Norton&quot;</span><span class="o">]</span> <span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pair</span><span class="o">|</span>
      <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="n">fn</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">result</span>
<span class="k">end</span>

<span class="n">l</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">name1</span><span class="p">,</span> <span class="n">name2</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">name1</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">name2</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span> 

<span class="n">with_names</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
</pre></div>
</code></pre>
<h2><a name="classes" class="anchor" href="#classes"><span class="header-link"></span></a>Classes</h2>
<p>The Classes syntax is as follows…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ClassName</span>
    <span class="k">def</span> <span class="nf">initialize</span> <span class="p">()</span>
        <span class="sr">//</span> <span class="n">code</span>
    <span class="k">end</span>
    <span class="sr">//</span> <span class="n">code</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>Instance variables for classes are defined using <code>@variable_name</code> and are available to all methods of the class.</p>
<p>For example…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span>
    <span class="k">def</span> <span class="nf">initialize</span> <span class="p">(</span><span class="nb">name</span> <span class="o">=</span> <span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
        <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">speak</span>
        <span class="nb">puts</span> <span class="s2">&quot;Hello, my name is </span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">employee</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Mark&quot;</span><span class="p">)</span>
</pre></div>
</code></pre>
<p>…executing this via irb returns <code>#&lt;Person:0x007feb988ce048 @name=&quot;Mark&quot;&gt;</code></p>
<p>Now executing <code>employee.speak</code> returns &quot;Hi, my name is Mark&quot;.</p>
<p>To check what methods exist for an object/class we can use <code>instance_methods</code> (e.g. using above example Class: <code>Person.instance_methods</code>) which shows ALL methods, even those you&#39;ve not defined yourself.</p>
<p>We can ignore ancestor methods by setting the <code>instance_methods</code> argument to false: <code>Person.instance_methods(false)</code> which then just shows us the one method we defined (you could use no parenthesis <code>Person.instance_methods false</code> but I don&#39;t think that is as clear in this instance).</p>
<p>A quick note about the use of parenthesis: I think there is no right or wrong choice but rather it depends on the tastes of the invidual user. I personally find no-parenthesis cleaner, but in some places it is just too confusing without them, so I like to mix and match wherever I feel it&#39;s appropriate.</p>
<p>We can do a check to see if our object/class has a certain method available by checking if it <code>responds</code> to it…</p>
<p><code>employee.respond_to?(&quot;speak&quot;)</code> =&gt; true<br><code>employee.respond_to? &quot;speak&quot;</code> =&gt; true</p>
<p>To create privileged methods, within the class we need to specify <code>attr_accessor :variable_name</code> (where by <code>variable_name</code> is replaced with the appropriate value). This then defines two additional methods onto the class which provides access to the specified variable. The two methods added are <code>variable_name</code> (which &#39;gets&#39; the value) and <code>variable_name=</code> (which &#39;sets&#39; the value).</p>
<p>For example…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Test</span>
    <span class="kp">attr_accessor</span> <span class="ss">:user_name</span>
    <span class="k">def</span> <span class="nf">initialize</span> <span class="p">(</span><span class="nb">name</span><span class="p">)</span>
        <span class="vi">@user_name</span> <span class="o">=</span> <span class="nb">name</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">speak</span>
        <span class="nb">puts</span> <span class="s2">&quot;hello </span><span class="si">#{</span><span class="vi">@user_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">tester</span> <span class="o">=</span> <span class="no">Test</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Mark&quot;</span><span class="p">)</span>
</pre></div>
</code></pre>
<p><code>tester.speak</code> =&gt; hello Mark<br><code>tester.user_name</code> =&gt; &quot;Mark&quot;<br><code>tester.user_name= &quot;Bob&quot;</code> =&gt; &quot;Bob&quot;<br><code>tester.user_name</code> =&gt; &quot;Bob&quot;</p>
<p>Note: as well as <code>:attr_accessor</code> which creates getter and setter methods, there is <code>:attr_reader</code> which only creates a getter method, and <code>:attr_writer</code> which only creates a setter method.</p>
<h2><a name="loops" class="anchor" href="#loops"><span class="header-link"></span></a>Loops</h2>
<p>Loops in Ruby are straight forward…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">list</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="o">]</span>

<span class="n">list</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="n">item</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>The <code>each</code> method executes a block of code for each item in the Array. The <code>do…end</code> section is such a block. The pipes <code>||</code> denotes the parameter <code>|name|</code> and that parameter is bound to each list item.</p>
<p>One thing to be aware of (and you&#39;ll see this later under the &#39;Numbers&#39; section), you can swap out <code>do…end</code> for normal curly brackets… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">list</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="o">]</span>

<span class="n">list</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="n">item</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…but for an <code>each</code> loop it doesn&#39;t look as nice as <code>do…end</code> so I keep with that style instead. But as you&#39;ll see I still like using curly brackets for other types of loops that don&#39;t have parameters.</p>
<p>There is a standard <code>while</code> loop as well within Ruby… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span>
    <span class="nb">puts</span> <span class="s2">&quot;count = </span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># Ruby has neither ++ or -- to increment/decrement a value</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>Also with a <code>while</code> loop (if you&#39;re using a &#39;switch..case&#39; style statement - like you would see in JavaScript) you can explicitly return a value… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nf">myFunction</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="s2">&quot;def&quot;</span>
    <span class="k">while</span> <span class="kp">true</span>
        <span class="k">case</span> <span class="n">xyz</span>
            <span class="k">when</span> <span class="s2">&quot;abc&quot;</span>
                <span class="k">return</span> <span class="kp">true</span>
            <span class="k">when</span> <span class="s2">&quot;def&quot;</span>
                <span class="k">return</span> <span class="kp">false</span>
            <span class="k">else</span>
                <span class="k">return</span> <span class="kp">nil</span> <span class="c1"># in case xyz doesn&#39;t equal what we expect</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>There are other types of iterator methods such as <code>map</code>… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">myArray</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">]</span>
<span class="n">newArray</span> <span class="o">=</span> <span class="n">myArray</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
    <span class="n">x</span><span class="o">*</span><span class="n">x</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>…which returns <code>[1, 4, 9, 16]</code></p>
<h2><a name="conditionals" class="anchor" href="#conditionals"><span class="header-link"></span></a>Conditionals</h2>
<p>Ruby is slightly different to other programming languages in that even its syntax is very expression-oriented. So where a control structure like <code>if</code> would be called a &#39;statement&#39; in other languages, in Ruby it is actually an expression which means it can be assigned to a variable like so…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">result</span> <span class="o">=</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="k">then</span> 
    <span class="n">x</span>
<span class="k">else</span> 
    <span class="n">y</span>
<span class="k">end</span>

<span class="c1"># depending on how complicated your condition is you could put it all on one line like so… </span>
<span class="n">result</span> <span class="o">=</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="k">then</span> <span class="n">x</span> <span class="k">else</span> <span class="n">y</span> <span class="k">end</span>
</pre></div>
</code></pre>
<p>…and so, as we&#39;ve mentioned before with <code>functions</code>, these types of blocks return the last expression evalutated inside the block, so in the above example the last expression is returned and stored in the <code>result</code> variable.</p>
<h2><a name="strings" class="anchor" href="#strings"><span class="header-link"></span></a>Strings</h2>
<p>Building up string values can be a bit of a nightmare in other languages. I know in PHP and JavaScript it&#39;s a real pain without including some kind of templating rendering (such as <code>Mustache</code>). But in Ruby they provide a technique called Interpolation which is where method arguments and variables can be inserted into a string (must be a double quoted string, not single quotes) using: <code>#{variable_name}</code>. </p>
<p>For example… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nf">welcome</span> <span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">&quot;Hello </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">!&quot;</span>
<span class="k">end</span>

<span class="n">welcome</span><span class="p">(</span><span class="s2">&quot;Mark&quot;</span><span class="p">)</span>
</pre></div>
</code></pre>
<p>Multiple arguments work the same way…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nf">welcome</span> <span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">age</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">&quot;Hello </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">!, I see you&#39;re </span><span class="si">#{</span><span class="n">age</span><span class="si">}</span><span class="s2"> years old.&quot;</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>You could do the same with simple string concatenation… </p>
<pre><code><div class="highlight"><pre><span class="nx">puts</span> <span class="s2">&quot;Hello&quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;!, I see you&#39;re &quot;</span> <span class="o">+</span> <span class="nx">age</span> <span class="o">+</span> <span class="s2">&quot; years old.&quot;</span>
</pre></div>
</code></pre>
<p>…but as you can see it&#39;s not as nice to look at or easy to read and definitely isn&#39;t as maintainable.</p>
<p>As mentioned earlier, as everything in Ruby is an object (even Strings) there are methods available to strings such as:</p>
<ul>
<li><code>sub</code> (basic find/replace)</li>
<li><code>gsub</code> (basic &#39;global&#39; find/replace)</li>
<li><code>scan</code> (regex based search which executes code block for each match)</li>
<li><code>match</code> (regex based search with Array of results returned)</li>
</ul>
<p>For example…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="s2">&quot;foobarfoobar&quot;</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; foofoofoobar</span>

<span class="s2">&quot;foobarfoobar&quot;</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; foofoofoofoo</span>

<span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;This is a test&quot;</span>
<span class="n">x</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sr">/^[a-zA-Z]{4}/</span><span class="p">,</span> <span class="s1">&#39;Hello&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; &quot;Hello is a test&quot;</span>

<span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;The car cost £2000 in 2012&quot;</span>
<span class="n">x</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\d+/</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">match</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">match</span> <span class="p">}</span>
<span class="c1"># =&gt; 2000</span>
<span class="c1"># =&gt; 2012</span>
<span class="c1"># scan() without the code block returns an array of matches</span>

<span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;This is a test&quot;</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/(\w+) (\w+)/</span><span class="p">)</span>
<span class="nb">puts</span> <span class="n">x</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="c1"># =&gt; This is</span>
<span class="nb">puts</span> <span class="n">x</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="c1"># =&gt; This</span>
<span class="nb">puts</span> <span class="n">x</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="c1"># =&gt; is</span>
</pre></div>
</code></pre>
<h2><a name="arrays" class="anchor" href="#arrays"><span class="header-link"></span></a>Arrays</h2>
<p>We&#39;ve seen Arrays used quite a bit already, but lets look at some additional methods and operators available… </p>
<p>The bitwise operator <code>&lt;&lt;</code> is used to add a new item to an array:</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="o">[]</span>
<span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;abc&quot;</span>
</pre></div>
</code></pre>
<p>…which is equivalent to <code>x.push(&quot;abc&quot;)</code></p>
<p>Note: Strings also use the <code>&lt;&lt;</code> operator to add content to them:</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">testString</span> <span class="o">=</span> <span class="s2">&quot;this is my string&quot;</span>
<span class="n">testString</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot; that has extra stuff added to it&quot;</span>
<span class="n">testString</span> <span class="c1"># =&gt; &quot;this is my string that has extra stuff added to it&quot;</span>
</pre></div>
</code></pre>
<p>There are methods for removing the last item in the Array <code>x.pop()</code> as well as joining an array items into a string using the specified character(s) as a separator <code>x.join(&quot;, &quot;)</code>.</p>
<p>With Strings you can use the <code>split</code> method to convert a string into an Array: <code>&quot;this is my string&quot;.split(&quot; &quot;)</code> which returns <code>=&gt; [&quot;this&quot;, &quot;is&quot;, &quot;my&quot;, &quot;string&quot;]</code>.</p>
<p>If you need to concatenate two Arrays you can use the <code>concat</code> method… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">arr</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="o">]</span>
<span class="n">arr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="o">[</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="o">]</span><span class="p">)</span>
<span class="n">arr</span> <span class="c1"># =&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;]</span>
</pre></div>
</code></pre>
<p>…there is also more basic concatenation using the <code>+</code> operator <code>arr + [&quot;d&quot;, &quot;e&quot;]</code> which returns <code>[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;]</code> but one caveat is that you must remember to set the array to be overwritten. For example, the previous code will return an Array which is a combination of <code>arr</code> and <code>[&quot;d&quot;, &quot;e&quot;]</code> but it doesn&#39;t actually overwrite the original Array (<code>arr</code> will still return <code>[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</code>). If you were expecting <code>arr</code> to be changed to <code>[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;]</code> then you would need to explicitly overwrite <code>arr</code> using: <code>arr += [&quot;d&quot;, &quot;e&quot;]</code> instead.</p>
<p>There are two other useful Array methods <code>arr.first</code> and <code>arr.last</code>. Can you guess what they do? That&#39;s right, they return the first and last items in the Array.</p>
<p>Some other interesting features of Ruby is the ability to write Arrays more quickly using the <code>%w()</code> method. So instead of writing <code>[&quot;a&quot;, &quot;e&quot;, &quot;i&quot;, &quot;o&quot;, &quot;u&quot;]</code> you would write <code>%w(a e i o u)</code> which generates the same Array.</p>
<p>There are many Array methods for inserting new items into an Array, but you can also use Ranges (which normally work like <code>(&#39;A&#39;..&#39;Z&#39;)</code>):</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">arr</span> <span class="o">=</span> <span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="o">]</span>
<span class="n">arr</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">3</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="o">]</span>
<span class="n">arr</span> <span class="c1"># =&gt; [0, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, 4, 5, 6]</span>
</pre></div>
</code></pre>
<h2><a name="hashes" class="anchor" href="#hashes"><span class="header-link"></span></a>Hashes</h2>
<p>Hashes are like &#39;objects&#39; in JavaScript and &#39;associative arrays&#39; in other languages. Like Arrays they have an iterator method called <code>each</code> which works the same way, the only difference being is that is doesn&#39;t just pass the value through but the &#39;key&#39; as well.</p>
<p>So for example to create a hash you would use… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">h</span> <span class="o">=</span> <span class="p">{</span> 
    <span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> 
    <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="mi">2</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…then you can access the relevant key/values (and add new key/values) like so… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">h</span><span class="o">[</span><span class="s2">&quot;a&quot;</span><span class="o">]</span>     <span class="c1"># =&gt; 1</span>
<span class="n">h</span><span class="o">[</span><span class="s2">&quot;b&quot;</span><span class="o">]</span>     <span class="c1"># =&gt; 2</span>
<span class="n">h</span><span class="o">[</span><span class="s2">&quot;c&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># create a new key/value</span>
<span class="n">h</span><span class="o">[</span><span class="s2">&quot;c&quot;</span><span class="o">]</span>     <span class="c1"># =&gt; 3</span>
</pre></div>
</code></pre>
<p>…and finally you can loop through the hash…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">h</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">&quot;The value: </span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2"> belongs to the key </span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>You don&#39;t have to use a String as a hash <code>key</code>. You can use any object or Symbol.</p>
<p>In Ruby 1.9 the keys of a hash are returned in the order they were added when looping properties (unlike JavaScript where the order are not guaranteed).</p>
<p>To see what keys are available in an object use the <code>keys</code> property:</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Mark&quot;</span><span class="p">,</span> <span class="ss">:age</span> <span class="o">=&gt;</span> <span class="mi">30</span> <span class="p">}</span>
<span class="nb">hash</span><span class="o">.</span><span class="n">keys</span> <span class="c1"># =&gt; [:name, :age]</span>
</pre></div>
</code></pre>
<p>You can delete a key/value from the hash using <code>hash.delete(key)</code></p>
<p>Hashes also have shortcut for deleting properties depending on their value: <code>hash.delete_if { |key, value| value &lt;= 30 }</code></p>
<h2><a name="numbers-and-how-everything-is-an-object-similar-to-javascript" class="anchor" href="#numbers-and-how-everything-is-an-object-similar-to-javascript"><span class="header-link"></span></a>Numbers (and how &#39;everything is an object&#39; - similar to JavaScript)</h2>
<p>In Ruby, all values are objects. This includes even simple things like numeric literals. So for example you can use a number to help carry out a certain action &#39;x&#39; amount of times…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span>
    <span class="nb">puts</span> <span class="s2">&quot;This gets written three times&quot;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>And as explained earlier you can swap curly brackets for <code>do…end</code>…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s2">&quot;This gets written three times&quot;</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>But you can also do…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="mi">1</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="p">{</span> 
    <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">x</span> 
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…which can be interchanged with… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="mi">1</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> 
    <span class="nb">puts</span> <span class="n">x</span> 
<span class="k">end</span>
</pre></div>
</code></pre>
<p>I normally find anything that takes parameters <code>|x|</code> looks better with <code>do…end</code> style syntax.</p>
<h2><a name="conclusion" class="anchor" href="#conclusion"><span class="header-link"></span></a>Conclusion</h2>
<p>Well, this is just an &#39;introduction&#39; so as you can see although we&#39;ve covered a lot of ground already we&#39;re still literally just scratching the surface. As I start learning more about Ruby I&#39;ll create new blog posts to follow on from here.</p>
</div>

  <div class="comments">
    <a href="/posts/introduction-to-ruby/#comments">
      <span class="icon-bubbles"></span>
      Comments
    </a>
  </div>

  <div class="post-head group">
  <a href="/posts/building-a-game-with-html5-canvas/">
    <h1 class="post-title">Building a game with HTML5 Canvas</h1>
  </a>
  <span class="post-date">2012 &#183; 6 &#183; 18</span>
</div>

<div class="post-body"><h2><a name="what-well-cover" class="anchor" href="#what-well-cover"><span class="header-link"></span></a>What we&#39;ll cover</h2>
<p><em>reading time: approx. 39mins</em></p>
<ul>
<li>Introduction</li>
<li>HTML</li>
<li>CSS</li>
<li>JavaScript<ul>
<li>requestAnimationFrame</li>
<li>Variables</li>
<li>Events alias&#39;</li>
<li>Image loading</li>
<li>Clearing the Canvas</li>
<li>Load image onto Canvas</li>
<li>Initialise Game</li>
<li>User interaction</li>
<li>Automatic puzzle piece animation</li>
<li>Drag and Drop interaction</li>
<li>Determining the end of game</li>
</ul>
</li>
</ul>
<h2><a name="introduction" class="anchor" href="#introduction"><span class="header-link"></span></a>Introduction</h2>
<p>I&#39;ve been playing around with the <a href="https://developer.mozilla.org/en/HTML/Canvas">Canvas</a> element for a little bit now, using it for more realistic features such as manipulating user uploaded images (using <a href="http://dvcs.w3.org/hg/xhr/raw-file/tip/Overview.html">XHR2</a>). For example, within a custom Content Management System where the user controls the images that appear on their website we would normally let the server handle the manipulation of the uploaded image using an external library such as <a href="http://www.imagemagick.org/">ImageMagick</a>, but now we handle this all on the client-side using Canvas.</p>
<p>I&#39;ve also played with the raw pixel data in images to apply filters and effect the colours of an image, which is interesting (although I have no actual use for that sort of manipulation at the present time).</p>
<p>So I thought I would dive a little bit further into the Canvas element and use it for building a game (as that&#39;s what most people are using it for). Nothing fancy, just the classic &quot;sliding image puzzle&quot; game we have all played at some point.  If you&#39;ve never played this game: the idea is to take an image and to split it into pieces. You then jumble up the pieces and remove one piece so there is an empty space. You then have to re-assemble the original image by sliding the pieces around but only able to move one piece at a time via the empty space that is available to you.</p>
<p>The game works on both desktop and mobile devices (e.g. &#39;touch&#39; based devices).</p>
<p>To see an example of the game then go to my <a href="https://github.com/Integralist/HTML5-Image-Slider-Game/">GitHub repository here</a> and run the HTML file in a browser that supports the HTML5 Canvas element.</p>
<p>In this article we&#39;re going to discuss the process I went through to build this game in more detail. The first two sections (HTML, CSS) are brief because the main chunk of work is residing inside the JavaScript so for that section we&#39;re going to step through each section of the code and explain what&#39;s happening.</p>
<h2><a name="html" class="anchor" href="#html"><span class="header-link"></span></a>HTML</h2>
<p>The HTML is pretty straight forward, it consists of a <code>meta</code> tag which tells the device to set the width to be 760px wide (this is so the game fits the full width of the device) and also specifies that the user cannot resize the content - the reason being is we want to ensure the game is always fitting the screen. After this we have a link to our style sheet - note: there are some declarations in our CSS which are included specifically to help with &#39;touch&#39; based devices (e.g. devices such as smart phones which don&#39;t utilise a &#39;mouse&#39; to interact with the content) - along with a single <code>canvas</code> element (which we could have created via JavaScript but I decided I preferred to have the element coded into the HTML). We also have a checkbox on the page which lets the user make the game a little easier by allowing them to move certain &#39;illegal&#39; puzzle pieces, and finally we have the <code>script</code> element which obviously is pointing to our JavaScript file which creates the game… </p>
<pre><code class="lang-html"><div class="highlight"><pre><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span> <span class="na">dir=</span><span class="s">&quot;ltr&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=760, user-scalable=0&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>HTML5 Slider Image Game<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;Assets/Styles/base.css&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;canvas</span> <span class="na">id=</span><span class="s">&quot;game&quot;</span><span class="nt">&gt;&lt;/canvas&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">&quot;allow&quot;</span><span class="nt">&gt;</span>Make game easier by allowing &#39;drag and drop&#39; of invalid pieces: <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">name=</span><span class="s">&quot;allow&quot;</span> <span class="na">id=</span><span class="s">&quot;allow&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;Assets/Scripts/game.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</code></pre>
<h2><a name="css" class="anchor" href="#css"><span class="header-link"></span></a>CSS</h2>
<p>The CSS is also pretty straight forward - with the exception of one part we&#39;ll come to in a moment - the main chunk of this style sheet is simply setting generic styles and normalising certain elements. </p>
<p>You&#39;ll notice though a rule called <code>.drag-canvas</code> which will be applied to another <code>canvas</code> element which you haven&#39;t seen yet as it&#39;s not part of the HTML, it is instead created via JavaScript (I&#39;ll explain what this 2nd <code>canvas</code> is for later when we start discussing the JavaScript side of the project).</p>
<p>The <code>canvas</code> selector sets a rule which has some specific declarations (along with appropriate vendor prefixes) that are applied to any <code>canvas</code> element found in the page. The declaration we&#39;re applying is <a href="https://developer.mozilla.org/en/CSS/-moz-user-select"><code>user-select</code></a> which controls the selection a user makes on the content. You&#39;ll see we&#39;ve set this to <code>none</code>. What this does is it prevents any iOS devices (and potentially other devices - hence the use of the vendor prefixes) from showing an additional option which lets the user carry out an action (e.g. &#39;copy&#39;). The reason I want to prevent this is because in our game we also want users to be able to &#39;drag and drop&#39; puzzle pieces (rather than just letting them &#39;click&#39; or &#39;touch&#39; to move a puzzle piece) and the way we do this (again, we&#39;ll go into this in more detail later) is by checking how long the user holds their &#39;touch&#39; down on the puzzle piece. But if you have ever used an iOS device you&#39;ll know that if you hold your touch down for more than a second you&#39;ll see a context menu pop up asking you to either &#39;Select, Select All, Paste&#39; or &#39;Copy&#39; and it&#39;s these options we want to disable while the user is playing our game.</p>
<pre><code class="lang-css"><div class="highlight"><pre><span class="nt">body</span> <span class="p">{</span>
    <span class="k">font-family</span><span class="o">:</span> <span class="n">Helvetica</span><span class="o">,</span> <span class="n">Arial</span><span class="o">,</span> <span class="k">sans-serif</span><span class="p">;</span>
    <span class="k">font-size</span><span class="o">:</span> <span class="m">100</span><span class="o">%</span><span class="p">;</span> <span class="c">/* this sets 1em to equal approximately 16px */</span>
    <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">padding</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h1</span><span class="o">,</span> <span class="nt">h2</span><span class="o">,</span> <span class="nt">h3</span><span class="o">,</span> <span class="nt">h4</span><span class="o">,</span> <span class="nt">h5</span><span class="o">,</span> <span class="nt">h6</span><span class="o">,</span> <span class="nt">p</span> <span class="p">{</span>
    <span class="k">line-height</span><span class="o">:</span> <span class="m">1.3em</span><span class="p">;</span>
    <span class="k">margin</span><span class="o">:</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h1</span> <span class="p">{</span>
    <span class="k">font-size</span><span class="o">:</span> <span class="m">2em</span><span class="p">;</span>
    <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">0.5em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.drag-canvas</span> <span class="p">{</span>
    <span class="k">left</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
    <span class="k">top</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">canvas</span> <span class="p">{</span>
    <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">select</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span> <span class="c">/* prevents the &#39;copy&#39; option &gt; http://www.bernskiold.com/2011/02/02/tips-and-tricks-for-ios-web-development/ */</span>
       <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">select</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
            <span class="n">user</span><span class="o">-</span><span class="n">select</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.allow</span> <span class="p">{</span>
    <span class="k">margin-top</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span>
    <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
    <span class="k">width</span><span class="o">:</span> <span class="m">760px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<h2><a name="javascript" class="anchor" href="#javascript"><span class="header-link"></span></a>JavaScript</h2>
<p>Now the JavaScript is where it gets interesting…  </p>
<h3><a name="requestanimationframe" class="anchor" href="#requestanimationframe"><span class="header-link"></span></a>requestAnimationFrame</h3>
<p>The first thing you&#39;ll notice is a polyfill for <a href="https://developer.mozilla.org/en/DOM/window.requestAnimationFrame">requestAnimationFrame</a>. If you don&#39;t know what it is, <code>requestAnimationFrame</code> is a more efficient alternative for <code>setInterval</code>and <code>setTimeout</code>. It&#39;s actually based more on <code>setTimeout</code> than <code>setInterval</code>, and what I mean by this is your specified function to be executed must itself call <code>requestAnimationFrame</code> (unless you want the animation to stop).</p>
<p>The polyfill I&#39;m using I&#39;ve modified slightly so that it creates a property of the global object whose value is a boolean which indicates if it is supported by the user&#39;s browser or not. The reason I store this result is because later in the script when I specify a &#39;step amount&#39; (e.g. how far I want the puzzle piece to move on each iteration) I found that I got better performance setting a higher step amount for browsers that support <code>requestAnimationFrame</code> so I want to change the step amount depending on if I&#39;m using <code>setInterval</code> or not.</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Polyfill for requestAnimationFrame which I&#39;ve modified from Paul Irish&#39;s original</span>
<span class="c1">// See: http://paulirish.com/2011/requestanimationframe-for-smart-animating/</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">lastTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">vendors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;moz&#39;</span><span class="p">,</span> <span class="s1">&#39;webkit&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">vendors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">global</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">;</span> <span class="o">++</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">global</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">=</span> <span class="nx">global</span><span class="p">[</span><span class="nx">vendors</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;RequestAnimationFrame&#39;</span><span class="p">];</span>
        <span class="nx">global</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span> <span class="o">=</span> <span class="nx">global</span><span class="p">[</span><span class="nx">vendors</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;CancelAnimationFrame&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="nx">global</span><span class="p">[</span><span class="nx">vendors</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;CancelRequestAnimationFrame&#39;</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="nx">global</span><span class="p">.</span><span class="nx">nativeRAF</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">global</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">;</span> <span class="c1">// store reference to whether it was natively supported or not (later we need to change increment value depending on if setInterval or requestAnimationFrame is used)</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">global</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">global</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>

            <span class="kd">var</span> <span class="nx">currTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">(),</span>
                <span class="nx">timeToCall</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span> <span class="o">-</span> <span class="p">(</span><span class="nx">currTime</span> <span class="o">-</span> <span class="nx">lastTime</span><span class="p">)),</span>
                <span class="nx">id</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span> 
                    <span class="nx">callback</span><span class="p">(</span><span class="nx">currTime</span> <span class="o">+</span> <span class="nx">timeToCall</span><span class="p">);</span>
                <span class="p">},</span> <span class="nx">timeToCall</span><span class="p">);</span>

            <span class="nx">lastTime</span> <span class="o">=</span> <span class="nx">currTime</span> <span class="o">+</span> <span class="nx">timeToCall</span><span class="p">;</span>

            <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>

        <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">global</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">global</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}(</span><span class="k">this</span><span class="p">));</span>
</pre></div>
</code></pre>
<p>Following this is our main script which we&#39;ve wrapped in an &#39;immediately invoked function expression&#39; (or <a href="benalman.com/news/2010/11/immediately-invoked-function-expression/">IIFE</a> for short). You&#39;ll see that we&#39;re passing in the value <code>this</code> which in this context is the global object (i.e. <code>Window</code>)… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// REST OF OUR CODE</span>
<span class="p">}(</span><span class="k">this</span><span class="p">));</span>
</pre></div>
</code></pre>
<h3><a name="variables" class="anchor" href="#variables"><span class="header-link"></span></a>Variables</h3>
<p>Now, if you look at my <a href="https://github.com/Integralist/Style-Guides/blob/master/JavaScript%20Style%20Guide.md#javascript-style-guide">JavaScript Style Guide</a> you&#39;ll see that I like to set-up the structure of my code as follows… </p>
<ul>
<li>Variables</li>
<li>Supporting functions</li>
<li>Code</li>
</ul>
<p>…and this structure applies to all executing contexts (e.g. sub functions also have the same structure). So looking at our code you can see we&#39;ve got a whole ton of variables specified which are used throughout the program. The reason for this is because of how the JavaScript interpreter handles variables when the program starts, which is to invisibly move variable declarations to the top of their containing scope. So to avoid confusion I try (wherever possible) to keep my variable declarations at the top… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Following variables are related to the creation of the canvas&#39; and specific configuration</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nb">document</span><span class="p">,</span>
        <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;game&quot;</span><span class="p">),</span>
        <span class="nx">context</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">),</span>
        <span class="nx">dragCanvas</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;canvas&quot;</span><span class="p">),</span>
        <span class="nx">dragCanvasContext</span> <span class="o">=</span> <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">),</span>
        <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">(),</span>
        <span class="nx">canvas_height</span><span class="p">,</span>
        <span class="nx">canvas_width</span><span class="p">,</span>
        <span class="nx">canvas_grid</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="c1">// e.g. 4 cols x 4 rows</span>
        <span class="nx">piece_height</span><span class="p">,</span>
        <span class="nx">piece_width</span><span class="p">,</span>
        <span class="nx">opening_message</span> <span class="o">=</span> <span class="s2">&quot;Start Game&quot;</span><span class="p">,</span>
        <span class="nx">text_dimensions</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">opening_message</span><span class="p">),</span>
    <span class="c1">// Following variables are related to the puzzle pieces</span>
        <span class="nx">puzzle_squares</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">puzzle_randomised</span><span class="p">,</span>
        <span class="nx">empty_space</span><span class="p">,</span>
        <span class="nx">current_piece</span><span class="p">,</span>
        <span class="nx">removed_piece</span><span class="p">,</span>
        <span class="nx">random_number</span><span class="p">,</span>
    <span class="c1">// Following variables are related to moving puzzle pieces around</span>
        <span class="nx">drag</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">eventObject</span><span class="p">,</span>
        <span class="nx">eventsMap</span>  <span class="o">=</span> <span class="p">{</span>
            <span class="nx">select</span><span class="o">:</span> <span class="s2">&quot;click&quot;</span><span class="p">,</span>
            <span class="nx">down</span><span class="o">:</span> <span class="s2">&quot;mousedown&quot;</span><span class="p">,</span>
            <span class="nx">up</span><span class="o">:</span> <span class="s2">&quot;mouseup&quot;</span><span class="p">,</span>
            <span class="nx">move</span><span class="o">:</span> <span class="s2">&quot;mousemove&quot;</span>
        <span class="p">},</span>
        <span class="nx">touchSupported</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">upTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">wasJustDragging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">allow_input</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;allow&quot;</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>…looking at these variables you can see that we&#39;re not only getting a reference to the <code>canvas</code> element in the page but we&#39;re also creating another <code>canvas</code> element. The purpose of having two <code>canvas</code>&#39;es is that the one found inside the HTML will be used for holding the puzzle pieces. The second <code>canvas</code> (created via JavaScript) is used for handling event listeners and also handling the &#39;drag and drop&#39; of individual puzzle pieces.</p>
<h3><a name="events-alias" class="anchor" href="#events-alias"><span class="header-link"></span></a>Events alias&#39;</h3>
<p>You&#39;ll also see that we&#39;ve created an object called <code>eventsMap</code> which we&#39;re using to map our own events (such as &#39;select&#39;, &#39;down&#39;, &#39;up&#39;, &#39;move&#39;) to the relevant mouse events available. This is because it makes it easier for us to swap to using touch events if they are supported by the users browser. So for example, just after setting up these variables we do a check for whether touch events are supported and if they are we swap the mouse specific values for touch specific values… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="s2">&quot;ontouchstart&quot;</span> <span class="k">in</span> <span class="nx">global</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">touchSupported</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">eventsMap</span>  <span class="o">=</span> <span class="p">{</span>
        <span class="nx">select</span><span class="o">:</span> <span class="s2">&quot;touchstart&quot;</span><span class="p">,</span>
        <span class="nx">down</span><span class="o">:</span> <span class="s2">&quot;touchstart&quot;</span><span class="p">,</span>
        <span class="nx">up</span><span class="o">:</span> <span class="s2">&quot;touchend&quot;</span><span class="p">,</span>
        <span class="nx">move</span><span class="o">:</span> <span class="s2">&quot;touchmove&quot;</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<h3><a name="image-loading" class="anchor" href="#image-loading"><span class="header-link"></span></a>Image loading</h3>
<p>You&#39;ll also see that within the variable declarations we&#39;re creating an <code>Image</code> object and after the variables we now set a <code>src</code> value which points to the image we&#39;re going to use for our game. We then set an <code>onload</code> event listener to be triggered when the image has loaded. </p>
<p>Once the image is loaded we know we can set-up the dimensions of the <code>canvas</code> and the puzzle pieces and also get the &#39;drag&#39; <code>canvas</code> placed on top of the main <code>canvas</code>. You&#39;ll notice that we&#39;ve set the &#39;drag&#39; <code>canvas</code> to have <code>globalAlpha = .9;</code> which basically makes the top <code>canvas</code> slightly opaque/transparent (e.g. if a puzzle piece was drawn on the &#39;drag&#39; <code>canvas</code> then you would be able to see through the puzzle piece to the bottom <code>canvas</code>).</p>
<p>We then finally call <code>loadImageOntoCanvas</code> to load the image on to the main <code>canvas</code>… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;Assets/Images/photo.jpg&quot;</span><span class="p">;</span>    
<span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">piece_height</span> <span class="o">=</span> <span class="o">~~</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="nx">canvas_grid</span><span class="p">);</span>
    <span class="nx">piece_width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="nx">canvas_grid</span><span class="p">;</span>
    <span class="nx">canvas_height</span> <span class="o">=</span> <span class="nx">piece_height</span> <span class="o">*</span> <span class="nx">canvas_grid</span><span class="p">;</span>
    <span class="nx">canvas_width</span> <span class="o">=</span> <span class="nx">piece_width</span> <span class="o">*</span> <span class="nx">canvas_grid</span><span class="p">;</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">canvas_height</span><span class="p">;</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">canvas_width</span><span class="p">;</span>

    <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s2">&quot;drag-canvas&quot;</span><span class="p">;</span>
    <span class="nx">dragCanvasContext</span><span class="p">.</span><span class="nx">globalAlpha</span> <span class="o">=</span> <span class="p">.</span><span class="mi">9</span><span class="p">;</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">dragCanvas</span><span class="p">);</span>

    <span class="nx">loadImageOntoCanvas</span><span class="p">();</span>
<span class="p">};</span>
</pre></div>
</code></pre>
<p>…one other small note is the use of the bitwise operator <code>~~</code> which you can see I&#39;ve used inside the <code>onload</code> listener: <code>piece_height = ~~(this.height / canvas_grid);</code>. What this does is functionally equivalent to <code>Math.floor</code> and is a technique I discovered from <a href="http://james.padolsey.com/javascript/double-bitwise-not/">James Padolsey</a>.</p>
<h3><a name="clearing-the-canvas" class="anchor" href="#clearing-the-canvas"><span class="header-link"></span></a>Clearing the Canvas</h3>
<p>Next we see a function called <code>clearCanvas</code>… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">clearCanvas</span> <span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>This does exactly what you think it does. But instead of using the API method <code>clearRect</code> to clear the <code>canvas</code> it uses a trick where by if you set the width and height of the <code>canvas</code> to the same dimensions as the <code>canvas</code> itself then the <code>canvas</code> will clear. <strong>BUT BE WARNED:</strong> this will also erase all state from the <code>canvas</code>! (for more information on &#39;state&#39; <a href="http://html5.litten.com/understanding-save-and-restore-for-the-canvas-context/">see here</a>)</p>
<h3><a name="load-image-onto-canvas" class="anchor" href="#load-image-onto-canvas"><span class="header-link"></span></a>Load image onto Canvas</h3>
<p>Now we move onto the function <code>loadImageOntoCanvas</code>… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">loadImageOntoCanvas</span><span class="p">(){</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">canvas_width</span><span class="p">,</span> <span class="nx">canvas_height</span><span class="p">);</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>

    <span class="nx">context</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&quot;#FFF&quot;</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">shadowColor</span> <span class="o">=</span> <span class="s2">&quot;#000&quot;</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">shadowOffsetX</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">shadowOffsetY</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">shadowBlur</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="s2">&quot;bold 25px Helvetica&quot;</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="nx">opening_message</span><span class="p">,</span> <span class="p">(</span><span class="nx">canvas_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nx">text_dimensions</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="p">(</span><span class="nx">canvas_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>

    <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">select</span><span class="p">,</span> <span class="nx">init</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…which first draws the image onto the <code>canvas</code>, then writes some text onto the <code>canvas</code> which says &quot;Start Game&quot;. We position the text centrally to the <code>canvas</code> by using the API method <code>measureText</code> which gives us the dimensions of the text. Remember up in the variable declarations we had… </p>
<pre><code><div class="highlight"><pre><span class="nx">text_dimensions</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">opening_message</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>…well now we can use that to write the text centrally onto the <code>canvas</code>… </p>
<pre><code><div class="highlight"><pre><span class="nx">context</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="nx">opening_message</span><span class="p">,</span> <span class="p">(</span><span class="nx">canvas_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nx">text_dimensions</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="p">(</span><span class="nx">canvas_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
</pre></div>
</code></pre>
<p>The last part of that function is an event listener for the <code>click</code>/<code>touchstart</code> event (depending on the browser support) which will call the <code>init</code> function when the user clicks on the <code>canvas</code> (to start the game)… </p>
<pre><code><div class="highlight"><pre><span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">select</span><span class="p">,</span> <span class="nx">init</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</pre></div>
</code></pre>
<h3><a name="initialise-game" class="anchor" href="#initialise-game"><span class="header-link"></span></a>Initialise Game</h3>
<p>In short: the <code>init</code> function clears the <code>canvas</code> and splits up the image into individual pieces and then displays them in a jumbled order. From there it sets up further event listeners for &#39;down&#39; and &#39;up&#39; events (which map to <code>mousedown</code>/<code>mouseup</code> and <code>touchstart</code>/<code>touchend</code>).</p>
<p>Lets look at this function in more detail… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">select</span><span class="p">,</span> <span class="nx">init</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="nx">clearCanvas</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>

<span class="c1">// Remove shadow (otherwise all puzzle pieces would get shadow applied to them)</span>
<span class="nx">context</span><span class="p">.</span><span class="nx">shadowOffsetX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">context</span><span class="p">.</span><span class="nx">shadowOffsetY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</code></pre>
<p>…so we first remove the event listener we previously set. We then clear the <code>canvas</code> (don&#39;t worry, the rest of the function executes in a fraction of a second so the user wont see the <code>canvas</code> go white, they&#39;ll just see the end result which is the jumbled up puzzle pieces).</p>
<p>We then set the <code>shadowOffsetX</code> and <code>shadowOffsetY</code> to zero. The reason for doing this is that when I originally wrote the text &quot;Start Game&quot; onto the <code>canvas</code> I had set the shadow properties to help make the text stand out more. But if I don&#39;t reset the values back to zero then all items will have a shadow (so when I was originally building this game I noticed that the puzzle pieces all had a shadow on them which made the game look broken!)</p>
<p>We&#39;ll ignore the variable declarations and the two functions at the beginning of <code>init</code> and move down to the executing code within this function.</p>
<p>So first thing we see is we call the <code>loop</code> function. Now this function is actually called twice within <code>init</code> and the reason for that is because the main chunk of the <code>loop</code> function is (as you would expect) a loop and that loop has to happen twice: once for splitting the image into pieces and the second time is for actually drawing those pieces (after they&#39;ve been jumbled up) back onto the <code>canvas</code>. But some extra things need to happen when the loop runs a second time, so we pass in a parameter so the <code>loop</code> function knows that this time it will need to draw the puzzle pieces onto the <code>canvas</code>…</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Build map of co-ordinates</span>
<span class="nx">loop</span><span class="p">();</span>

<span class="c1">// Randomise puzzle pices</span>
<span class="nx">puzzle_randomised</span> <span class="o">=</span> <span class="nx">shuffle</span><span class="p">(</span><span class="nx">puzzle_squares</span><span class="p">);</span>

<span class="c1">// Draw puzzle pieces</span>
<span class="nx">loop</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>…you can see we are using a <code>shuffle</code> function to mix up the puzzle pieces. This function I modified from the <a href="http://documentcloud.github.com/underscore/">Underscore</a> JavaScript library.</p>
<p>From here we randomly select a puzzle piece to remove (remember we need to have one empty space for the other pieces to move into) and then we set the initial empty space values (which we use throughout the rest of the game as a way to tell which part of the <code>canvas</code> is empty and can have a puzzle piece moved into it)… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">random_number</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">puzzle_randomised</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">random_number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">random_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">random_piece</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">random_number</span><span class="p">];</span>

<span class="nx">removed_piece</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">random_number</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">random_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span> <span class="nx">random_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

<span class="nx">empty_space</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">x</span><span class="o">:</span> <span class="nx">random_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
    <span class="nx">y</span><span class="o">:</span> <span class="nx">random_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
<span class="p">};</span>
</pre></div>
</code></pre>
<p>And the last part of the <code>init</code> function is to set-up the event listeners for the &#39;down&#39;/&#39;up&#39; events (which as we&#39;ve mentioned already are just alias&#39; to the relevant mouse and touch events)… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">down</span><span class="p">,</span> <span class="nx">checkDrag</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">up</span><span class="p">,</span> <span class="nx">toggleDragCheck</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>…these event listeners are going to help us detect when the user wants to move a puzzle piece.</p>
<h3><a name="user-interaction" class="anchor" href="#user-interaction"><span class="header-link"></span></a>User interaction</h3>
<p>So we can see that the &#39;down&#39; event will call the <code>checkDrag</code> function, so lets start from there… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">down</span><span class="p">,</span> <span class="nx">checkDrag</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

<span class="nx">global</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">drag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">startDrag</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">movePiece</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="mi">150</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>You see we&#39;re first removing the event listener for the &#39;down&#39; event. We do this so the user can&#39;t accidentally (or purposely) try to move another puzzle piece while we&#39;re still in the process of moving the previous one.</p>
<p>We then use a short timer which when executed checks to see if the variable <code>drag</code> is true or false. If <code>drag</code> is true then we know the user wants to actually &#39;drag and drop&#39; the puzzle piece rather than have it move automatically for them. If <code>drag</code> is false then we just start animating the selected puzzle piece for them.</p>
<p>The reason we use a timer here is because we only have one &#39;down&#39; event, but that one event needs to do two things. So the timer delays the JavaScript engine just long enough for us to tell whether the user has released their click/touch. Remember we also set an &#39;up&#39; event which calls <code>toggleDragCheck</code> - well that function sets <code>drag</code> to false - so if the user just clicks/taps the puzzle piece then the &#39;up&#39; event will trigger and we&#39;ll set <code>drag</code> to false and so the timer will then know the user wants to have the piece moved for them. If the user keeps their click/touch down then when the timer runs <code>drag</code> will still equal true and so we know they want to &#39;drag and drop&#39; the selected piece.</p>
<p>Now as far as user interaction is concerned, there are a number of different scenarios that can play out during this game (e.g. user presses on illegal piece, user drops piece over non-empty space, the order of functions called changes when the user &#39;drag and drops&#39; and so the value of the variable <code>drag</code> can be changed incorrectly) and so we have to add in extra checks inside the <code>toggleDragCheck</code> function which work around these different scenarios.</p>
<p>For example, I had a problem where if the user did a &#39;drag and drop&#39; movement then the <code>toggleDragCheck</code> function would get called in a different order. So if the user then tried to perform another &#39;drag and drop&#39; movement they couldn&#39;t. So I had to put in checks that determined if the user was just in a &#39;drag and drop&#39; motion or not and reset specific variables to make sure the user could perform the actions they wanted… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">toggleDragCheck</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">upTriggered</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="c1">// If the user releases while piece is moving but the piece hasn&#39;t yet been placed then stop the drag</span>
    <span class="c1">// And move the piece back into the empty space it came from</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">upTriggered</span> <span class="o">&amp;&amp;</span> <span class="nx">event_moving</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">upTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">stopDrag</span><span class="p">();</span>
        <span class="nx">putPieceBack</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">drag</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>UPDATE: I have since realised another way I could have implemented &#39;drag &amp; drop&#39; which is to check the &#39;move&#39; event (remember this is an alias for <code>mousemove</code> and <code>touchmove</code>) while the &#39;down&#39; event was triggered and to set a threshold of let&#39;s say 4px in any direction before triggering the drag and drop mechanism. I don&#39;t know how much this would have simplified things but maybe that could be an exercise for the reader to investigate. </p>
<h3><a name="automatic-puzzle-piece-animation" class="anchor" href="#automatic-puzzle-piece-animation"><span class="header-link"></span></a>Automatic puzzle piece animation</h3>
<p>We have two routes to go down now: <code>startDrag</code> or <code>movePiece</code>.</p>
<p>We&#39;re going to start with <code>movePiece</code> as that&#39;s the simpler of the two routes at the moment.</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
    <span class="nx">j</span> <span class="o">=</span> <span class="nx">canvas_grid</span><span class="p">,</span>
    <span class="nx">selected_piece</span><span class="p">,</span>
    <span class="nx">potential_spaces</span><span class="p">,</span>
    <span class="c1">// Firefox only recognised properties pageX/Y</span>
    <span class="nx">eventX</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetX</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> 
    <span class="nx">eventY</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetY</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">,</span>
    <span class="nx">pieceMovedX</span><span class="p">,</span>
    <span class="nx">pieceMovedY</span><span class="p">,</span>
    <span class="nx">moveAmount</span> <span class="o">=</span> <span class="p">(</span><span class="nx">nativeRAF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">20</span> <span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="c1">// setInterval worked fine when moving by 10 but rAF could do with up&#39;ing the number of pixels per movement</span>
    <span class="nx">interval</span><span class="p">,</span>
    <span class="nx">coord</span><span class="p">,</span>
    <span class="nx">direction</span><span class="p">,</span> 
    <span class="nx">storeSelectedX</span><span class="p">,</span> 
    <span class="nx">storeSelectedY</span><span class="p">,</span>
    <span class="nx">foundPieceForAnimation</span><span class="p">;</span>
</pre></div>
</code></pre>
<p>OK, so the first thing we find inside of the <code>movePiece</code> function are the variable declarations. We can see that the only variables that are actually defined are <code>i</code>, <code>eventX</code>, <code>eventY</code> and <code>moveAmount</code>. For <code>moveAmount</code> you can see what we were referring to earlier when we were talking about the <code>requestAnimationFrame</code> polyfill…</p>
<p><code>moveAmount = (nativeRAF) ? 20 : 10</code></p>
<p>…we&#39;re checking if <code>requestAnimationFrame</code> is natively supported (rather than just a <code>setInterval</code>) and then we change the amount the puzzle piece should move depending on that result (we find moving by 20 on every iteration is a lot smoother using <code>requestAnimationFrame</code>, whereas moving by 20 using <code>setInterval</code> is just too fast).</p>
<p>Our first requirement from here is to find out which puzzle piece was clicked on. When we find out what piece was selected we can then decide whether we want to continue within the function to actually animate the piece into the empty space or not (I say &quot;<em>we can decide</em>&quot; because at this stage we don&#39;t know if the selected puzzle piece is a valid piece that has been clicked on - e.g. there is no empty space immediately next to it)… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Find the piece that was clicked on</span>
<span class="nx">selected_piece</span> <span class="o">=</span> <span class="nx">findSelectedPuzzlePiece</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">eventX</span><span class="p">,</span> <span class="nx">eventY</span><span class="p">);</span>

<span class="c1">// We&#39;re resetting &#39;wasJustDragging&#39; variable to false as we&#39;re now attempting to move the puzzle piece &#39;automatically&#39;</span>
<span class="c1">// So even if we don&#39;t actual move the puzzle piece, our program knows we haven&#39;t just tried to &#39;drag and drop&#39;</span>
<span class="nx">wasJustDragging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="c1">// If no piece found (or user clicked on &#39;empty space&#39;) then don&#39;t continue</span>
<span class="c1">// But we need to reset some settings ready for next user interaction</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">selected_piece</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">resetOptions</span><span class="p">();</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…so the above code is making sense so far (e.g. we need to get the selected puzzle piece and then check if it&#39;s valid). But lets take a closer look at the two functions mentioned in the above snippet: <code>findSelectedPuzzlePiece</code> and <code>resetOptions</code>.</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">findSelectedPuzzlePiece</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">eventX</span><span class="p">,</span> <span class="nx">eventY</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Make sure we haven&#39;t selected the current empty space</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">eventX</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">eventX</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">eventY</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">eventY</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">piece_height</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">eventX</span> <span class="o">&gt;=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasX</span> <span class="o">&amp;&amp;</span> <span class="nx">eventX</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasX</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">eventY</span> <span class="o">&gt;=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasY</span> <span class="o">&amp;&amp;</span> <span class="nx">eventY</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasY</span> <span class="o">+</span> <span class="nx">piece_height</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>As you can see the <code>findSelectedPuzzlePiece</code> is just a simple loop through the Array (<code>puzzle_randomised</code>) which holds the jumbled up puzzle pieces <code>puzzle_randomised</code> and it checks the current X and Y co-ordinates to see if they match any of the items in the Array (while at the same is also checking if the X and Y co-ordinates have matched the currently empty space in the puzzle).</p>
<p>The <code>resetOptions</code> function is a little bit more complicated in that it needs to delay resetting some values. This is because of how the different functions are used to configure the &#39;drag and drop&#39; settings. For example, if the user clicked too quickly after just &#39;dragging and dropping&#39; their puzzle piece then they wouldn&#39;t be able to move another piece (which was fixed by setting a fraction of a second delay before re-applying the event listeners).</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">resetOptions</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">wasJustDragging</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">global</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">down</span><span class="p">,</span> <span class="nx">checkDrag</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">up</span><span class="p">,</span> <span class="nx">toggleDragCheck</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">down</span><span class="p">,</span> <span class="nx">checkDrag</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Make sure drag is reset to true so we can check whether the user wants to &quot;drag &amp; drop&quot;</span>
    <span class="nx">drag</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>OK, now we&#39;ve taken a look at those two functions, lets continue on with the next step of the <code>movePiece</code> function which is to create an object with the four potential empty spaces that could be around the selected puzzle piece… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">potential_spaces</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">-</span> <span class="nx">piece_height</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">-</span> <span class="nx">piece_width</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">+</span> <span class="nx">piece_height</span>
    <span class="p">}</span>
<span class="p">];</span>
</pre></div>
</code></pre>
<p>…now we move onto actually looping through the <code>potential_spaces</code> Array to see if we can find a match of the potential empty spaces and the <em>actual</em> empty space… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Check if we can move the selected piece into the empty space (e.g. can only move selected piece up, down, left and right, not diagonally)</span>
<span class="k">while</span> <span class="p">(</span><span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">x</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">y</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// NOW WE NEED TO LOOP THROUGH &#39;puzzle_randomised&#39;          </span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…once we&#39;ve found a match we can start looping through the Array that holds the jumbled puzzle pieces (i.e. <code>puzzle_randomised</code>) and see if we can find a match between the selected puzzle piece and the pieces in the Array… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasX</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">&amp;&amp;</span> 
        <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasY</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// We&#39;ll keep track of how far the piece has moved</span>
        <span class="nx">pieceMovedX</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">;</span>
        <span class="nx">pieceMovedY</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">;</span>

        <span class="c1">// We&#39;ll also keep track of the original selected piece as we&#39;ll need these co-ordinates for resetting the empty space</span>
        <span class="nx">storeSelectedX</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">;</span>
        <span class="nx">storeSelectedY</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">;</span>

        <span class="c1">// Animate the piece into place</span>
        <span class="nx">foundPieceForAnimation</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="c1">// had to store in var rather than pass as an argument as requestAnimationFrame doesn&#39;t have any way to pass an argument :-(</span>
        <span class="nx">raf</span><span class="p">();</span>

        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>At the end of that loop we put in a quick conditional check that calls the <code>resetOptions</code> function only when no matches from the previous loops were found… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// User must have clicked on an item that couldn&#39;t have been moved</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">resetOptions</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>So the entire chunk of code (two loops and conditional statement) looks like this… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Check if we can move the selected piece into the empty space (e.g. can only move selected piece up, down, left and right, not diagonally)</span>
<span class="k">while</span> <span class="p">(</span><span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">x</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">y</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// We then loop through the shuffled puzzle order looking for the piece that was selected by the user</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasX</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">&amp;&amp;</span> 
                <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasY</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">)</span> <span class="p">{</span>

                <span class="c1">// We&#39;ll keep track of how far the piece has moved</span>
                <span class="nx">pieceMovedX</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">;</span>
                <span class="nx">pieceMovedY</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">;</span>

                <span class="c1">// We&#39;ll also keep track of the original selected piece as we&#39;ll need these co-ordinates for resetting the empty space</span>
                <span class="nx">storeSelectedX</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">;</span>
                <span class="nx">storeSelectedY</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">;</span>

                <span class="c1">// Animate the piece into place</span>
                <span class="nx">foundPieceForAnimation</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="c1">// had to store in var rather than pass as an argument as requestAnimationFrame doesn&#39;t have any way to pass an argument :-(</span>
                <span class="nx">raf</span><span class="p">();</span>

                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// User must have clicked on an item that couldn&#39;t have been moved</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">resetOptions</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>Within the second loop (once we&#39;ve made a match) we now need to begin the actual process of animating the selected puzzle piece into the empty space.</p>
<p>We do this by calling the <code>raf</code> function which itself sets-up the <code>requestAnimationFrame</code> and then calls the <code>animate</code> function… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">raf</span><span class="p">(){</span>
    <span class="nx">interval</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">raf</span><span class="p">);</span>
    <span class="nx">animate</span><span class="p">(</span><span class="nx">foundPieceForAnimation</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…when <code>animate</code> is called we pass through the relevant puzzle piece. The <code>animate</code> function first clears the space where the selected piece last was found and then checks to see if we need to update the &#39;x&#39; or &#39;y&#39; co-ordinates… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Clear the space where the selected piece is currently</span>
<span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">pieceMovedX</span><span class="p">,</span> <span class="nx">pieceMovedY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

<span class="c1">// We don&#39;t want to move the x/y co-ordinates if they&#39;re already the same</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">pieceMovedX</span> <span class="o">!==</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">coord</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">;</span>
    <span class="c1">// Check which direction the piece needs to move in</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pieceMovedX</span> <span class="o">&gt;</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">pieceMovedX</span> <span class="o">-=</span> <span class="nx">moveAmount</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">pieceMovedX</span> <span class="o">+=</span> <span class="nx">moveAmount</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pieceMovedY</span> <span class="o">!==</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">coord</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span><span class="p">;</span>
    <span class="c1">// Check which direction the piece needs to move in</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pieceMovedY</span> <span class="o">&gt;</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">pieceMovedY</span> <span class="o">-=</span> <span class="nx">moveAmount</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">pieceMovedY</span> <span class="o">+=</span> <span class="nx">moveAmount</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…once the co-ordinates are updated we then re-draw the puzzle piece into the next position and keep going until we reach the end of the animation. </p>
<p>We check for the end of the animation by looking at the current co-ordinates of the puzzle piece compared to the final co-ordinates and if there is a match we stop the animation by clearing the time out and drawing the image one last time into it&#39;s final position. </p>
<p>We then update the co-ordinates for that now moved puzzle piece so it thinks it was last drawn in the same position as what once was an empty space. We then update the empty space co-ordinates so they point to where the selected puzzle piece just came from (confused yet?!)</p>
<p>Lastly, we call <code>resetOptions</code> and do one final check to see if all the pieces are now in the end position and thus the end of the game…</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">direction</span> <span class="o">&amp;&amp;</span> <span class="nx">coord</span> <span class="o">===</span> <span class="s2">&quot;x&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">pieceMovedX</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">||</span> 
    <span class="nx">direction</span> <span class="o">&amp;&amp;</span> <span class="nx">coord</span> <span class="o">===</span> <span class="s2">&quot;y&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">pieceMovedY</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">||</span> 
    <span class="o">!</span><span class="nx">direction</span> <span class="o">&amp;&amp;</span> <span class="nx">coord</span> <span class="o">===</span> <span class="s2">&quot;x&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">pieceMovedX</span> <span class="o">&lt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">||</span> 
    <span class="o">!</span><span class="nx">direction</span> <span class="o">&amp;&amp;</span> <span class="nx">coord</span> <span class="o">===</span> <span class="s2">&quot;y&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">pieceMovedY</span> <span class="o">&lt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">global</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span><span class="p">(</span><span class="nx">interval</span><span class="p">);</span>

    <span class="c1">// Draw one last time directly into the empty space</span>
    <span class="c1">// Note: I was finding that because of the loop interation sometimes the y position would be -2 or 2+ but I decided that near enough the position drawing directly into the empty space the user wont even notice</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">piece_to_move</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">piece_to_move</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

    <span class="c1">// Also update the drawnOnCanvasX/Y properties so they reflect the last place on the canvas they were drawn</span>
    <span class="nx">piece_to_move</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
    <span class="nx">piece_to_move</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

    <span class="c1">// Reset the empty space co-ordinates to be where the image we&#39;ve just moved was.</span>
    <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">storeSelectedX</span><span class="p">;</span>
    <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">storeSelectedY</span><span class="p">;</span>

    <span class="nx">resetOptions</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">checkIfGameFinished</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">drawBackMissingPiece</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Then redraw it into the empty space</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">piece_to_move</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">piece_to_move</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">pieceMovedX</span><span class="p">,</span> <span class="nx">pieceMovedY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<h3><a name="drag-and-drop-interaction" class="anchor" href="#drag-and-drop-interaction"><span class="header-link"></span></a>Drag and Drop interaction</h3>
<p>So now we&#39;ve been through the automatic moving of puzzle pieces lets start looking at how the &#39;drag and drop&#39; route works.</p>
<p>So if you remember we had a conditional that was checking if the variable <code>drag</code> was true or false. But it would check the value after a few milliseconds (which was long enough for our program to change the value of <code>drag</code> to true if the user had kept their click/touch down - signifying they intended to drag the puzzle piece).</p>
<p>If the user intended to drag the piece we would call the appropriately named function <code>startDrag</code>… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">selected_piece</span><span class="p">,</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
    <span class="nx">j</span> <span class="o">=</span> <span class="nx">canvas_grid</span><span class="p">,</span>
    <span class="nx">potential_spaces</span><span class="p">,</span>
    <span class="nx">eventX</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetX</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> 
    <span class="nx">eventY</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetY</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">setUp</span><span class="p">(){</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

    <span class="nx">dragCanvasContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

    <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">move</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

    <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">=</span> <span class="nx">eventX</span> <span class="o">-</span> <span class="p">(</span><span class="nx">piece_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">=</span> <span class="nx">eventY</span> <span class="o">-</span> <span class="p">(</span><span class="nx">piece_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

<span class="nx">eventObject</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">handleEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">dragPiece</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">current_piece</span> <span class="o">=</span> <span class="nx">selected_piece</span> <span class="o">=</span> <span class="nx">findSelectedPuzzlePiece</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">eventX</span><span class="p">,</span> <span class="nx">eventY</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">allow_input</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">potential_spaces</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">-</span> <span class="nx">piece_height</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">-</span> <span class="nx">piece_width</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">+</span> <span class="nx">piece_height</span>
        <span class="p">}</span>
    <span class="p">];</span>

    <span class="nx">outer_loop</span><span class="o">:</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">x</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">y</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasX</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">&amp;&amp;</span> 
                    <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasY</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">)</span> <span class="p">{</span>

                     <span class="nx">selected_piece</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                     <span class="nx">setUp</span><span class="p">();</span>
                     <span class="k">break</span> <span class="nx">outer_loop</span><span class="p">;</span>

                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">resetOptions</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>            
    <span class="nx">setUp</span><span class="p">();</span>            
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…OK so there is a fair bit going on here so lets analyse what&#39;s happening. </p>
<p>First we see the varible declarations, we expect this now and know that they relate to things used throughout this function.</p>
<p>Next we have a function called <code>setUp</code> which we&#39;ll ignore for now as this is what actually starts the &#39;drag and drop&#39;. </p>
<p>The rest of this function is actually a repeat of code from the <code>movePiece</code> function! So although it looks a lot you&#39;ve already seen most of it any way. But before we discuss this further lets quickly look at the code after the <code>setUp</code> function… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">=</span> <span class="nx">eventX</span> <span class="o">-</span> <span class="p">(</span><span class="nx">piece_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">=</span> <span class="nx">eventY</span> <span class="o">-</span> <span class="p">(</span><span class="nx">piece_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

<span class="nx">eventObject</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">handleEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">dragPiece</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">current_piece</span> <span class="o">=</span> <span class="nx">selected_piece</span> <span class="o">=</span> <span class="nx">findSelectedPuzzlePiece</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">eventX</span><span class="p">,</span> <span class="nx">eventY</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>…so here we&#39;re setting some global properties (they need to be global because we want to be able to change them from outside of this function) to store the users selected co-ordinates. You&#39;ll notice that I&#39;ve named them quite generically. The reason I did that was because this game works for mouse and touch based devices I didn&#39;t want to call them <code>click_positionX</code> because then on a touch device that wouldn&#39;t have strictly been true (anal I know).</p>
<p>The <code>eventObject</code> is the listener for the &#39;move&#39; event (which as you already know is an alias for either <code>mousemove</code> or <code>touchmove</code> depending on device support). It&#39;s called by the listener within the <code>setUp</code> function. I&#39;ll come back to this later when I start discussing the <code>setUp</code> function.</p>
<p>And finally we store a reference to the currently selected puzzle piece.</p>
<p>OK, now we come to the conditional statement… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">allow_input</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Move piece into available empty space.</span>
    <span class="c1">// There are 4 potential spaces around the selected piece which it can move in (diagonal doesn&#39;t count - as we&#39;re not worrying about the &#39;drag and drop&#39; yet)</span>
    <span class="c1">// So loop through each of them checking to see if any of their co-ordinates match the empty space</span>
    <span class="c1">// If they do match then move the selected piece into that space and set the selected piece to be the new empty space</span>
    <span class="nx">potential_spaces</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">-</span> <span class="nx">piece_height</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">-</span> <span class="nx">piece_width</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">+</span> <span class="nx">piece_height</span>
        <span class="p">}</span>
    <span class="p">];</span>

    <span class="c1">// Check if we can move the selected piece into the empty space (e.g. can only move selected piece up, down, left and right, not diagonally)</span>
    <span class="c1">// We use a labelled statement to break out of the outer loop once a match is found within the inner loop</span>
    <span class="nx">outer_loop</span><span class="o">:</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">x</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">potential_spaces</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">y</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// We then loop through the shuffled puzzle order looking for the piece that was selected by the user</span>
            <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasX</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">&amp;&amp;</span> 
                    <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">drawnOnCanvasY</span> <span class="o">===</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">)</span> <span class="p">{</span>

                     <span class="nx">selected_piece</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                     <span class="nx">setUp</span><span class="p">();</span>
                     <span class="k">break</span> <span class="nx">outer_loop</span><span class="p">;</span>

                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// User must have clicked on an item that couldn&#39;t have been moved</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// this is so when the mouseup/touchend event is triggered we can catch this error out inside toggleDragCheck() which otherwise would reset drag=false and cause problems with the user&#39;s next interaction</span>
        <span class="nx">resetOptions</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>            
    <span class="nx">setUp</span><span class="p">();</span>            
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…the purpose of this is to see if we&#39;re allowed to move &#39;illegal&#39; puzzle pieces. If we aren&#39;t allowed to move them then we have a whole load of code which is repeated from the <code>movePiece</code> function and as you now already know it just works out if the puzzle piece selected is illegal or not. Now the reason I didn&#39;t just abstract this code into a separate function is because it has some slight tweaks to it (but mainly the code is the same). The tweaks are things like providing a &#39;labelled statement&#39; for the outer while loop <code>outer_loop: while (j--)</code> (which makes it easer for us to break out of both loops, otherwise we&#39;d have to set a variable in the inner loop for the outer loop to check against to see if it needed to break).</p>
<p>The <code>else</code> statement just calls the <code>setUp</code> function as it doesn&#39;t have to worry about checking if the puzzle piece is legal or not, it knows whatever was selected can be moved.</p>
<p>Now we get to the <code>setUp</code> function itself… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">setUp</span><span class="p">(){</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

    <span class="nx">dragCanvasContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

    <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">move</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

    <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…so the first line removes the puzzle piece from the canvas now we know which piece it is.</p>
<p>Next we draw the puzzle piece onto the top canvas which handles the user interaction.</p>
<p>Then we set-up the event listener so that we call the <code>dragPiece</code> function (which is specified within the <code>eventObject</code>) every time the user moves either their mouse cursor or their finger.</p>
<p>Lastly we set <code>event_moving</code> to true which is useful for doing some checks later on to make sure the user&#39;s next interaction isn&#39;t broken.</p>
<p>But lets just quickly review the <code>eventObject</code>. Most people don&#39;t realise that with <code>addEventListener</code> you don&#39;t have to specify a function to be the listener and that you can specify an object, but that object must have a <code>handler</code> property with a function assigned to it which acts as the listener. The reason I&#39;ve used an object rather than a straight function is because I wanted to pass some additional parameters but couldn&#39;t of done that otherwise without using an anonymous function and if you don&#39;t know: it&#39;s best to avoid using anonymous functions for an event listener because if you do then you wont be able to remove the event listener (without maybe building your own abstraction of the events API to workaround the issue - I wont go into the details of why you can&#39;t remove an anonymous function referenced event listener as that&#39;s outside the scope of this post, but suffice to say it&#39;s similar to checking if <code>{} == {}</code>).</p>
<p>We&#39;ve now reached the <code>dragPiece</code> function… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">eventX</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetX</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> 
    <span class="nx">eventY</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetY</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">,</span>
    <span class="nx">storeSelectedX</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span><span class="p">,</span>
    <span class="nx">storeSelectedY</span> <span class="o">=</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span><span class="p">,</span>
    <span class="nx">halfWidth</span> <span class="o">=</span> <span class="nx">piece_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nx">halfHeight</span> <span class="o">=</span> <span class="nx">piece_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

<span class="nx">dragCanvasContext</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>

<span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">=</span> <span class="nx">eventX</span> <span class="o">-</span> <span class="nx">halfWidth</span><span class="p">;</span>
<span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">=</span> <span class="nx">eventY</span> <span class="o">-</span> <span class="nx">halfHeight</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">&lt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">piece_width</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">&lt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">piece_height</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">+</span> <span class="nx">piece_height</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">+</span> <span class="nx">piece_width</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">highlightEmptySpace</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Check if mouse is over the empty space or not</span>
<span class="k">if</span> <span class="p">((</span><span class="nx">eventX</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">eventX</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">eventY</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">eventY</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">piece_height</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">move</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
    <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
    <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
    <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">storeSelectedX</span><span class="p">;</span>
    <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">storeSelectedY</span><span class="p">;</span>
    <span class="nx">stopDrag</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>    
    <span class="nx">dragCanvasContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…so again lets look through what&#39;s happening.</p>
<p>The <code>halfWidth</code> and <code>halfHeight</code> variables are there because when we draw the puzzle piece onto the top canvas we want the puzzle piece to be centered to the mouse cursor/user&#39;s touch.</p>
<p>The line:</p>
<p><code>dragCanvasContext.clearRect(global.user_positionX, global.user_positionY, piece_width, piece_height);</code></p>
<p>…clears where the puzzle piece was last drawn. We then update the co-ordinates for mouse/touch position…</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">=</span> <span class="nx">eventX</span> <span class="o">-</span> <span class="nx">halfWidth</span><span class="p">;</span>
<span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">=</span> <span class="nx">eventY</span> <span class="o">-</span> <span class="nx">halfHeight</span><span class="p">;</span>
</pre></div>
</code></pre>
<p>…the next step is to see if the user has moved the puzzle piece &#39;near&#39; the empty space. The way we do this is we highlight the empty space so it has a red background whenever the user moves 20px within it. This is so they are aware that at any point soon the puzzle piece will be dropped into this empty space… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">&lt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">piece_width</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">&lt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">piece_height</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span> <span class="o">+</span> <span class="nx">piece_height</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span> <span class="o">+</span> <span class="nx">piece_width</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">highlightEmptySpace</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…the <code>else</code> statement is there for when the user moves the puzzle piece to a position that is again outside of the puzzle piece (e.g. we remove the red background).</p>
<p>Now we just have one more conditional statement before we reach the end of the function… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">if</span> <span class="p">((</span><span class="nx">eventX</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">eventX</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">piece_width</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">eventY</span> <span class="o">&gt;=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">eventY</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">piece_height</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">move</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">event_moving</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
    <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
    <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">=</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
    <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">storeSelectedX</span><span class="p">;</span>
    <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">storeSelectedY</span><span class="p">;</span>
    <span class="nx">stopDrag</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>    
    <span class="nx">dragCanvasContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">selected_piece</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionX</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">user_positionY</span><span class="p">,</span> <span class="nx">piece_width</span><span class="p">,</span> <span class="nx">piece_height</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…here we check to see if the mouse/touch is over the empty space and if it is we then remove the <code>move</code> event (as there is no point calling it again now we&#39;ve placed the puzzle piece in the empty space). After that we update some of the properties such as <code>event_moving</code>, <code>empty_space</code> object and the <code>drawnOnCanvas</code> properties and then we call the <code>stopDrag</code> function which we&#39;ll get to in a few moments.</p>
<p>If the user isn&#39;t over the empty space then the <code>else</code> statement kicks in and we simply draw the puzzle piece onto the canvas in the current mouse/touch position.</p>
<p>So now lets look at the contents of the <code>stopDrag</code> function… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">move</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="nx">dragCanvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventsMap</span><span class="p">.</span><span class="nx">up</span><span class="p">,</span> <span class="nx">toggleDragCheck</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="nx">wasJustDragging</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">resetOptions</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">checkIfGameFinished</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">drawBackMissingPiece</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…the first thing we do is remove the &#39;move&#39; event - <em>now to be honest, as I&#39;m writing this post a few weeks after completing the game, I&#39;m not sure why I&#39;m removing the event again in that section as it should have already been removed? I&#39;ll leave this in for now and re-evaluate the code at a later date to see if it is indeed as redundant as it appears to be now</em> - then we update <code>wasJustDragging</code> so we know that we just completed a drag and drop motion. Then we call the <code>resetOptions</code> function (which we went over earlier) and finally we call the function <code>checkIfGameFinished</code> which nicely leads us into our final section… </p>
<h3><a name="determining-the-end-of-game" class="anchor" href="#determining-the-end-of-game"><span class="header-link"></span></a>Determining the end of game</h3>
<p>The <code>checkIfGameFinished</code> function simply loops through all puzzle pieces to see if they match the correct order… </p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">checkIfGameFinished</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">copied_puzzle_randomised</span> <span class="o">=</span> <span class="nx">puzzle_randomised</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="nx">copied_puzzle_randomised</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">random_number</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">removed_piece</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">complete</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="nx">complete</span> <span class="o">=</span> <span class="nx">copied_puzzle_randomised</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">drawnOnCanvasX</span> <span class="o">===</span> <span class="nx">item</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">drawnOnCanvasY</span> <span class="o">===</span> <span class="nx">item</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> 
        <span class="c1">// The final piece is actually the missing piece so we check the x/y against the empty_space x/y</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">x</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">y</span> <span class="o">===</span> <span class="nx">empty_space</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">complete</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>…some other things to note about the <code>checkIfGameFinished</code> function is that we copy the <code>puzzle_randomised</code> Array and add back in the missing piece before we then check all the co-ordinates are correct and match (you&#39;ll see we&#39;re setting the variable <code>complete</code> to be the return value of the Array method <code>every</code> and then the function returns <code>complete</code> which will be either true or false (see: <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/every"><a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/every">https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/every</a></a> for details).</p>
<p>Quickly now we&#39;ll jump back to the <code>stopDrag</code> function where we&#39;ll see that if <code>checkIfGameFinished</code> returns true then we&#39;ll call <code>drawBackMissingPiece</code> which (as you would expect by the name of the function) draws the missing puzzle piece back onto the canvas as we know the game is complete and then displays an <code>alert</code> which tells the user the game is complete (this part you can change to suit your needs).</p>
<p>And now! finally! we have reached the end of this post :-)</p>
<p>Hopefully this has made <em>some</em> sense? I would say &quot;go through the code and see how everything works&quot; - and you can do that obviously - but with things of this nature they can get quite complex and there are problems the developer goes through and works around which might not be clear in the code itself (I&#39;ve tried to document the reasoning behind most of the code so hopefully that will help).</p>
<p>But any questions then just let me know.</p>
</div>

  <div class="comments">
    <a href="/posts/building-a-game-with-html5-canvas/#comments">
      <span class="icon-bubbles"></span>
      Comments
    </a>
  </div>


<div class="pagination group">
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
      <a href="/page/12/" class="newer"> Newer &#8594;</a>
    
  
    
    
  
    
    
      <a href="/page/14/" class="older"> &#8592; Older</a>
    
  
    
    
  
    
    
  
    
    
  
    
    
  
</div>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js" type="text/javascript"></script>
    <script src="/scripts/main.js" type="text/javascript"></script>
    <script src="/scripts/Imager.js" type="text/javascript"></script>
    <script>
        var _gaq=[['_setAccount','UA-33159515-1'],['_trackPageview']];
        (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
        g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>
  </body>
</html>

