<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/images/cabin.png" >
    <link href="/styles/main.css" rel="stylesheet">
    
    <title>Integralist -> BBC News Engineer</title>
    
    
    <link rel="alternate" type="application/atom+xml" title="Integralist" href="http://feeds.feedburner.com/Integralist">
  </head>
  <body>
    <nav>
      <h1 class="name">
          <a href="/">Integralist</a> <span class="role">BBC News Engineer</span>
      </h1>
      <div class="menu icon-menu"></div>
      <ul class="nav-links">
        <li class="text-link">
          <a href="/about.html">about</a>
        </li>
        <li class="text-link">
          <a href="/projects.html">projects</a>
        </li>
        <li class="text-link">
          <a href="/archives.html">archives</a>
        </li>
      </ul>
      <div class="social-media">
        <a href="https://github.com/integralist" class="icon-github"></a>
        <a href="https://twitter.com/integralist" class="icon-twitter"></a>
      </div>
    </nav>
    <div class="content">


  <div class="post-head group">
  <a href="/posts/sqlite-and-activerecord/">
    <h1 class="post-title">SQLite and ActiveRecord</h1>
  </a>
  <span class="post-date">2013 &#183; 10 &#183; 7</span>
</div>

<div class="post-body"><h2><a name="what-we-ll-cover"class="anchor" href="#what-we-ll-cover"><span class="header-link"></span></a>What we&#39;ll cover</h2>
<p><em>reading time: approx. 14mins</em></p>
<ul>
<li>Introduction</li>
<li>SQLite</li>
<li>ActiveRecord</li>
<li>Installation</li>
<li>Set-up</li>
<li>Schema</li>
<li>Creating<ul>
<li>Association</li>
<li>Record Creation</li>
</ul>
</li>
<li>Querying</li>
<li>Conclusion</li>
</ul>
<h2><a name="introduction"class="anchor" href="#introduction"><span class="header-link"></span></a>Introduction</h2>
<p>This was intended to be a quick post about how to use the embedded relational database &quot;<a href="http://www.sqlite.org/">SQLite</a>&quot; with a Ruby/Sinatra application but will also include information on incorporating the ActiveRecord pattern as well.</p>
<p>We&#39;ll look at installing and setting up SQLite and incorporating the ActiveRecord pattern using the open-source library of the same name (which is included as part of the <a href="http://rubyonrails.org/">Ruby on Rails Framework</a>).</p>
<h2><a name="sqlite"class="anchor" href="#sqlite"><span class="header-link"></span></a>SQLite</h2>
<p>Typically if you&#39;re developing an application in Ruby using the <a href="http://rubyonrails.org/">Ruby on Rails framework</a> then you&#39;ll use SQLite in development and then switch over to another database for production (maybe <a href="http://www.mysql.com/">MySQL</a> or <a href="http://www.postgresql.org/">PostgreSQL</a>). </p>
<p>What most people don&#39;t realise is that if you have a low traffic website then SQLite is fine to use. </p>
<p>The only thing to be aware of when using SQLite in production is that it inherently isn&#39;t designed to scale. To help clarify, the author of SQLite had this to say on the subject… </p>
<blockquote>
<p>SQLite usually will work great as the database engine for low to medium traffic websites. The amount of web traffic that SQLite can handle depends, of course, on how heavily the website uses its database. Generally speaking, any site that gets fewer than 100K hits/day should work fine with SQLite. The 100K hits/day figure is a conservative estimate, not a hard upper bound. SQLite has been demonstrated to work with 10 times that amount of traffic.</p>
<p>SQLite will normally work fine as the database backend to a website. But if your website is so busy that you are thinking of splitting the database component off onto a separate machine, then you should definitely consider using an enterprise-class client/server database engine instead of SQLite.</p>
</blockquote>
<h2><a name="activerecord"class="anchor" href="#activerecord"><span class="header-link"></span></a>ActiveRecord</h2>
<p>So most Ruby developers will know of <a href="http://guides.rubyonrails.org/active_record_querying.html">ActiveRecord</a> but may not realise that it&#39;s actually an architectural pattern and the term was originally coined by <a href="http://martinfowler.com/">Martin Fowler</a> (a legend in the field of software engineering and data modeling).</p>
<p>The pattern describes how to provide an Interface that lets the user interact with a relational database in a more user friendly fashion rather than constructing their own SQL queries.</p>
<p>We&#39;ll be using Ruby on Rails&#39; implementation of the pattern which they&#39;ve extracted into an external library/module (so it&#39;s not specifically reliant on the Ruby on Rails framework if you&#39;re using something more lightweight like Sinatra).</p>
<h2><a name="installation"class="anchor" href="#installation"><span class="header-link"></span></a>Installation</h2>
<p>There are a couple of things we need to do:</p>
<ol>
<li>Install the SQLite libraries</li>
<li>Install the SQLite Ruby module</li>
<li>Install the ActiveRecord Ruby module</li>
</ol>
<p>So if you have <a href="http://brew.sh/">Homebrew</a> installed then you can simply run <code>brew install sqlite</code>.</p>
<p>Note: you may need to run <code>brew --force link</code> afterwards, as a much older version of SQLite is already installed on the Mac OS and so the OS will attempt to load that first.</p>
<p>To install the ruby module just run <code>gem install sqlite3</code></p>
<p>To install the ActiveRecord ruby module just run <code>gem install activerecord</code></p>
<h2><a name="command-line-tool"class="anchor" href="#command-line-tool"><span class="header-link"></span></a>Command Line Tool</h2>
<p>Once the SQLite libraries are installed you will have access to a command line tool that lets you directly inspect the contents of a SQLite database file.</p>
<p>For example, if you have a database file called <code>test.db</code> then you can run <code>sqlite3 test.db</code> to open the database.</p>
<p>You can then run SQL commands against the database such as <code>select * from tableName;</code> (notice the semicolon at the end <code>;</code> you&#39;ll need this otherwise the command won&#39;t know when it is considered completed, the plus side is that you can write complex SQL queries across multiple lines).</p>
<h2><a name="set-up"class="anchor" href="#set-up"><span class="header-link"></span></a>Set-up</h2>
<p>Imagine we have a single file <code>sqlite-example.rb</code> with the following content… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;active_record&#39;</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;database.log&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">establish_connection</span><span class="p">(</span>
  <span class="ss">:adapter</span>  <span class="o">=&gt;</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span>
  <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;example.db&#39;</span>
<span class="p">)</span>
</pre></div>
</code></pre>
<p>…so let&#39;s analyse what this script is doing.</p>
<p>First thing we&#39;re doing is loading the SQLite module.</p>
<p>Second, ActiveRecord allows us to specify a recipient for any log information. In this instance we store any log information into a file called <code>database.log</code>. We could also send the log information directly to the terminal screen using <code>Logger.new(STDERR)</code> instead.</p>
<p>Thirdly, we actually connect to the SQLite database. ActiveRecord has adapters for multiple databases and so here we specify we&#39;re using SQLite and that we want to connect to the <code>example.db</code> database. We could store data all in memory if we wanted (e.g. it wouldn&#39;t persist after the application has finished running), we do this by changing to…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;:memory:&#39;</span>
</pre></div>
</code></pre>
<h2><a name="schema"class="anchor" href="#schema"><span class="header-link"></span></a>Schema</h2>
<p>As you should probably already know, we need to define a Schema for our database. Because although we&#39;re using an ActiveRecord interface we&#39;re still interacting with a relational database underneath that layer.</p>
<p>A Schema helps dictate in code what the structure of the database should be and what the different columns/rows and data types should be used.</p>
<p>To do this we&#39;ll add… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Schema</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="k">unless</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">include?</span> <span class="s1">&#39;albums&#39;</span>
    <span class="n">create_table</span> <span class="ss">:albums</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
      <span class="n">table</span><span class="o">.</span><span class="n">column</span> <span class="ss">:title</span><span class="p">,</span>     <span class="ss">:string</span>
      <span class="n">table</span><span class="o">.</span><span class="n">column</span> <span class="ss">:performer</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">unless</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">include?</span> <span class="s1">&#39;tracks&#39;</span>
    <span class="n">create_table</span> <span class="ss">:tracks</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
      <span class="n">table</span><span class="o">.</span><span class="n">column</span> <span class="ss">:album_id</span><span class="p">,</span>     <span class="ss">:integer</span> <span class="c1"># foreign key &lt;table-name-singular&gt;_id (i.e. this is the primary key from the &#39;albums&#39; table)</span>
      <span class="n">table</span><span class="o">.</span><span class="n">column</span> <span class="ss">:track_number</span><span class="p">,</span> <span class="ss">:integer</span>
      <span class="n">table</span><span class="o">.</span><span class="n">column</span> <span class="ss">:title</span><span class="p">,</span>        <span class="ss">:string</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>…as you might be able to tell, we&#39;re doing a couple of things.</p>
<p>First we&#39;re defining a new Schema.</p>
<p>Second, we&#39;re creating two tables: <code>albums</code> and <code>tracks</code> (we wrap the creation of the tables in a condition so we make sure we don&#39;t cause any errors by trying to create a table that already exists). Also, the convention is to name the tables as plurals (notice we don&#39;t call it <code>album</code> or <code>track</code> as they&#39;ll be holding multiples of that data).</p>
<p>Thirdly, inside of the table creation we&#39;re specifying specific columns and what their data types should be.</p>
<p>When we create a table a &quot;<a href="http://en.wikipedia.org/wiki/Primary_key">primary key</a>&quot; is automatically created for us and is named after the table. So in this instance we have two primary keys created for us: <code>albums_id</code> and <code>tracks_id</code> (notice the naming convention of <code>tableName_id</code> - singular, not plural).</p>
<p>Inside the <code>tracks</code> table you&#39;ll see the first column we create is actually a &quot;<a href="http://en.wikipedia.org/wiki/Foreign_key">foreign key</a>&quot; because we&#39;re creating a column which is named after the <code>albums</code> table&#39;s primary key (<code>album_id</code>).</p>
<h2><a name="creating"class="anchor" href="#creating"><span class="header-link"></span></a>Creating</h2>
<p>The ActiveRecord pattern is based on conventions, so in this instance we&#39;ll create two new classes that inherit from ActiveRecord&#39;s base class and we&#39;ll use these two classes for creating new records for each table… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Album</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:tracks</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Track</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:album</span>
<span class="k">end</span>

<span class="k">unless</span> <span class="no">Album</span><span class="o">.</span><span class="n">find_by_title</span><span class="p">(</span><span class="s1">&#39;In Utero&#39;</span><span class="p">)</span>
  <span class="n">album</span> <span class="o">=</span> <span class="no">Album</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="ss">:title</span>     <span class="o">=&gt;</span> <span class="s1">&#39;In Utero&#39;</span><span class="p">,</span>
    <span class="ss">:performer</span> <span class="o">=&gt;</span> <span class="s1">&#39;Nirvana&#39;</span>
  <span class="p">)</span>

  <span class="n">track_listing</span> <span class="o">=</span> <span class="o">[</span>
    <span class="kp">nil</span><span class="p">,</span>
    <span class="s1">&#39;Serve the Servants&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Scentless Apprentice&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Heart-Shaped Box&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Rape Me&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Frances Farmer&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Dumb&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Very Ape&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Milk It&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Pennyroyal Tea&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Radio Friendly Unit Shifter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Tourettes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;All Apologies&#39;</span>
  <span class="o">]</span>

  <span class="n">track_listing</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
    <span class="n">album</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:track_number</span> <span class="o">=&gt;</span> <span class="n">index</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">value</span><span class="p">)</span> <span class="k">unless</span> <span class="n">index</span> <span class="o">===</span> <span class="mi">0</span> <span class="c1"># skip zero index</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">unless</span> <span class="no">Album</span><span class="o">.</span><span class="n">find_by_title</span><span class="p">(</span><span class="s1">&#39;La-te-ra-lus&#39;</span><span class="p">)</span>
  <span class="n">album</span> <span class="o">=</span> <span class="no">Album</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="ss">:title</span>     <span class="o">=&gt;</span> <span class="s1">&#39;La-te-ra-lus&#39;</span><span class="p">,</span>
    <span class="ss">:performer</span> <span class="o">=&gt;</span> <span class="s1">&#39;Tool&#39;</span>
  <span class="p">)</span>

  <span class="n">track_listing</span> <span class="o">=</span> <span class="o">[</span>
    <span class="kp">nil</span><span class="p">,</span>
    <span class="s1">&#39;The Grudge&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Eon Blue Apocalypse&#39;</span><span class="p">,</span>
    <span class="s1">&#39;The Patient&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Mantra&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Schism&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Parabol&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Parabola&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Ticks &amp; Leeches&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Lateralus&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Disposition&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Reflection&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Triad&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Faaip de Oiad&#39;</span>
  <span class="o">]</span>

  <span class="n">track_listing</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
    <span class="n">album</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:track_number</span> <span class="o">=&gt;</span> <span class="n">index</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">value</span><span class="p">)</span> <span class="k">unless</span> <span class="n">index</span> <span class="o">===</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</code></pre>
<p>…OK, so there are a couple of things worth noting here:</p>
<p>When we inherit from <code>ActiveRecord::Base</code> our class is mapped to a table of the same name. So for example our class <code>Album</code> is mapped to the <code>albums</code> table.</p>
<p>Also, as we&#39;re inheriting from the ActiveRecord Base class, we don&#39;t need to specify attributes (for example, inside our Tracks class) such as <code>:title</code> or <code>:track_number</code> within our class, as they will be indirectly inferred from the Schema we defined earlier and will come from that table which the class is mapped to.</p>
<h3><a name="association"class="anchor" href="#association"><span class="header-link"></span></a>Association</h3>
<p>You&#39;ll notice within the <code>Album</code> class we call a <code>has_many</code> method (provided through the inheritance chain via <code>ActiveRecord::Base</code>) which sets up the association between &#39;albums&#39; and &#39;tracks&#39;.</p>
<p>Similarly, within the <code>Track</code> class we call <code>belongs_to</code> and tell it that our tracks belong to the &#39;albums&#39; table. We should only do this when the class/table holds the foreign key for the table we&#39;re saying it belongs to. In this case our &#39;Track&#39; class holds the foreign key that points to the &#39;albums&#39; table.</p>
<h3><a name="record-creation"class="anchor" href="#record-creation"><span class="header-link"></span></a>Record Creation</h3>
<p>Finally we actually create some records to insert into each table.</p>
<p>We call a <code>create</code> method like so…</p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">album</span> <span class="o">=</span> <span class="no">Album</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</code></pre>
<p>…which is equivalent to… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">album</span> <span class="o">=</span> <span class="no">Album</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">);</span>
<span class="n">album</span><span class="o">.</span><span class="n">save</span>
</pre></div>
</code></pre>
<p>…so it saves us a little extra typing (which is nice).</p>
<p>You&#39;ll also notice that when we create a new <code>Album</code> instance we can access and create new <code>Tracks</code> as well (via the <code>album</code> instance: <code>album.tracks.create(…)</code>). This is because we&#39;ve made an association within the top level classes between Albums and Tracks.</p>
<p>In my example I&#39;m trying to be a bit smarter by not repeating the same chunk of code over and over. So rather than doing… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="n">album</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:track_number</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">album</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:track_number</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">album</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:track_number</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
<span class="c1">#…rinse repeat…</span>
</pre></div>
</code></pre>
<p>…instead, I create the track listing as an <code>Array</code> and then loop the Array creating new records. </p>
<p>The only additional logic I need is to avoid including the <code>[0]</code> item in the Array which I do using <code>album.tracks.create(…) unless index === 0</code>. </p>
<p>The reason I avoid it is simply because track listings on albums always start at <code>1</code> where as our Array is zero-indexed.</p>
<h2><a name="querying"class="anchor" href="#querying"><span class="header-link"></span></a>Querying</h2>
<p>Now in my example code you&#39;ll find me wrapping certain chunks in <code>begin/rescue</code> as my example isn&#39;t made to work when accessed multiple times (<em>it&#39;s just a silly example to demonstrate how to connect, populate and query data using ActiveRecords</em>). So don&#39;t worry about those aspects and instead just focus on the APIs I&#39;m using. Specifically…</p>
<h3><a name="-find-"class="anchor" href="#-find-"><span class="header-link"></span></a><code>find</code></h3>
<p>This allows you to find a record by ID. So <code>Album.find(1)</code> would return the first album in the table. <code>Album.find(1).tracks.length</code> would then tell you the number of tracks that particular album held.</p>
<h3><a name="-find_by-"class="anchor" href="#-find_by-"><span class="header-link"></span></a><code>find_by</code></h3>
<p>This is actually a very intelligent method. It is based on conventions again, so <code>find_by_title</code> maps to a standard <code>find_by</code> method but passes through <code>title</code> as the attribute we&#39;re interested in searching within: <code>Album.find_by_title(&#39;La-te-ra-lus&#39;)</code></p>
<h3><a name="-all-"class="anchor" href="#-all-"><span class="header-link"></span></a><code>all</code></h3>
<p>This is an alias for <code>find(:all)</code>. So <code>Album.all</code> would return all records found within the &#39;Album` table.</p>
<h3><a name="-where-"class="anchor" href="#-where-"><span class="header-link"></span></a><code>where</code></h3>
<p>This is a conditional that maps to SQL&#39;s <code>where</code> clause. So <code>Track.where(title: &#39;Triad&#39;)</code> would return the record(s) within the Track database whose <code>title</code> attribute contained the value <code>Triad</code>. You can do more complicated filters such as: <code>Table.where(user_name: user_name, password: password).first</code> which safely sanitises your input and checks two different attributes and then returns the first record found (in case there are multiples).</p>
<h3><a name="-first-"class="anchor" href="#-first-"><span class="header-link"></span></a><code>first</code></h3>
<p>We&#39;ve seen this used already and works in a similar way to how Ruby&#39;s <code>first</code> property works (it returns the first item found).</p>
<h3><a name="-last-"class="anchor" href="#-last-"><span class="header-link"></span></a><code>last</code></h3>
<p>Same as <code>first</code> but returns the last item found.</p>
<h3><a name="-delete-"class="anchor" href="#-delete-"><span class="header-link"></span></a><code>delete</code></h3>
<p>Once you&#39;ve found a record then you can delete it using this method. So <code>Album.first.delete</code> would find the first record in the <code>Album</code> table and then delete that record.</p>
<h3><a name="-save-"class="anchor" href="#-save-"><span class="header-link"></span></a><code>save</code></h3>
<p>You can modify records by first locating them and simply assigning a new value to them, but you would then use the <code>save</code> method to store that update back to the database: <code>track = Track.where(title: &#39;yolo&#39;).first.title = &#39;Blah&#39;; track.save</code></p>
<h2><a name="conclusion"class="anchor" href="#conclusion"><span class="header-link"></span></a>Conclusion</h2>
<p>So we&#39;ve not delved too deeply (as there is far too much to cover in one post) but hopefully this has been a good starting point for you.</p>
<p>The complete code I was using looks like this… </p>
<pre><code class="lang-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;active_record&#39;</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;database.log&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">establish_connection</span><span class="p">(</span>
  <span class="ss">:adapter</span>  <span class="o">=&gt;</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span>
  <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;example.db&#39;</span>
<span class="p">)</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Schema</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="k">unless</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">include?</span> <span class="s1">&#39;albums&#39;</span>
    <span class="n">create_table</span> <span class="ss">:albums</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
      <span class="n">table</span><span class="o">.</span><span class="n">column</span> <span class="ss">:title</span><span class="p">,</span>     <span class="ss">:string</span>
      <span class="n">table</span><span class="o">.</span><span class="n">column</span> <span class="ss">:performer</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">unless</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">include?</span> <span class="s1">&#39;tracks&#39;</span>
    <span class="n">create_table</span> <span class="ss">:tracks</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
      <span class="n">table</span><span class="o">.</span><span class="n">column</span> <span class="ss">:album_id</span><span class="p">,</span>     <span class="ss">:integer</span>
      <span class="n">table</span><span class="o">.</span><span class="n">column</span> <span class="ss">:track_number</span><span class="p">,</span> <span class="ss">:integer</span>
      <span class="n">table</span><span class="o">.</span><span class="n">column</span> <span class="ss">:title</span><span class="p">,</span>        <span class="ss">:string</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Album</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:tracks</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Track</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:album</span>
<span class="k">end</span>

<span class="k">unless</span> <span class="no">Album</span><span class="o">.</span><span class="n">find_by_title</span><span class="p">(</span><span class="s1">&#39;In Utero&#39;</span><span class="p">)</span>
  <span class="n">album</span> <span class="o">=</span> <span class="no">Album</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="ss">:title</span>     <span class="o">=&gt;</span> <span class="s1">&#39;In Utero&#39;</span><span class="p">,</span>
    <span class="ss">:performer</span> <span class="o">=&gt;</span> <span class="s1">&#39;Nirvana&#39;</span>
  <span class="p">)</span>

  <span class="n">track_listing</span> <span class="o">=</span> <span class="o">[</span>
    <span class="kp">nil</span><span class="p">,</span>
    <span class="s1">&#39;Serve the Servants&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Scentless Apprentice&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Heart-Shaped Box&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Rape Me&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Frances Farmer&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Dumb&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Very Ape&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Milk It&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Pennyroyal Tea&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Radio Friendly Unit Shifter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Tourettes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;All Apologies&#39;</span>
  <span class="o">]</span>

  <span class="n">track_listing</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
    <span class="n">album</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:track_number</span> <span class="o">=&gt;</span> <span class="n">index</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">value</span><span class="p">)</span> <span class="k">unless</span> <span class="n">index</span> <span class="o">===</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">unless</span> <span class="no">Album</span><span class="o">.</span><span class="n">find_by_title</span><span class="p">(</span><span class="s1">&#39;La-te-ra-lus&#39;</span><span class="p">)</span>
  <span class="n">album</span> <span class="o">=</span> <span class="no">Album</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="ss">:title</span>     <span class="o">=&gt;</span> <span class="s1">&#39;La-te-ra-lus&#39;</span><span class="p">,</span>
    <span class="ss">:performer</span> <span class="o">=&gt;</span> <span class="s1">&#39;Tool&#39;</span>
  <span class="p">)</span>

  <span class="n">track_listing</span> <span class="o">=</span> <span class="o">[</span>
    <span class="kp">nil</span><span class="p">,</span>
    <span class="s1">&#39;The Grudge&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Eon Blue Apocalypse&#39;</span><span class="p">,</span>
    <span class="s1">&#39;The Patient&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Mantra&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Schism&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Parabol&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Parabola&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Ticks &amp; Leeches&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Lateralus&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Disposition&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Reflection&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Triad&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Faaip de Oiad&#39;</span>
  <span class="o">]</span>

  <span class="n">track_listing</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
    <span class="n">album</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:track_number</span> <span class="o">=&gt;</span> <span class="n">index</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">value</span><span class="p">)</span> <span class="k">unless</span> <span class="n">index</span> <span class="o">===</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">begin</span>
  <span class="nb">p</span> <span class="no">Album</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">length</span> <span class="c1"># 13 (on first run of this script it&#39;s fine, but next run we&#39;ve deleted the record)</span>
<span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span>
  <span class="nb">p</span> <span class="s1">&#39;We just rescued a &quot;RecordNotFound&quot; error&#39;</span>
<span class="k">end</span>

<span class="nb">p</span> <span class="no">Album</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">length</span> <span class="c1"># 14</span>
<span class="nb">p</span> <span class="no">Album</span><span class="o">.</span><span class="n">find_by_title</span><span class="p">(</span><span class="s1">&#39;La-te-ra-lus&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span> <span class="c1"># &quot;La-te-ra-lus&quot;</span>
<span class="nb">p</span> <span class="no">Track</span><span class="o">.</span><span class="n">find_by_title</span><span class="p">(</span><span class="s1">&#39;Very Ape&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">album_id</span> <span class="c1"># 1</span>
<span class="nb">p</span> <span class="no">Album</span><span class="o">.</span><span class="n">all</span> <span class="c1"># ActiveRecord::Relation =&gt; complete set of database records</span>
<span class="nb">p</span> <span class="no">Album</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">length</span> <span class="c1"># 2</span>
<span class="nb">p</span> <span class="no">Track</span><span class="o">.</span><span class="n">all</span> <span class="c1"># ActiveRecord::Relation =&gt; complete set of database records</span>
<span class="nb">p</span> <span class="no">Track</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">title</span><span class="p">:</span> <span class="s1">&#39;Triad&#39;</span><span class="p">)</span> <span class="c1"># ActiveRecord::Relation =&gt; single record</span>
<span class="nb">p</span> <span class="no">Track</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">track_number</span><span class="p">:</span> <span class="mi">6</span><span class="o">.</span><span class="n">.</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># returns tracks 6 to 8 from all albums</span>
<span class="nb">p</span> <span class="no">Album</span><span class="o">.</span><span class="n">first</span> <span class="c1"># returns first record (calling `Album.find(:first|:last) is deprecated`)</span>
<span class="nb">p</span> <span class="no">Album</span><span class="o">.</span><span class="n">last</span> <span class="c1"># returns last record</span>

<span class="k">if</span> <span class="no">Album</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
  <span class="nb">p</span> <span class="no">Album</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">delete</span> <span class="c1"># delete the first record</span>
<span class="k">end</span>

<span class="nb">p</span> <span class="no">Album</span><span class="o">.</span><span class="n">all</span> <span class="c1"># now we&#39;ll see there is only one record remaining</span>

<span class="n">track_to_be_modified</span> <span class="o">=</span> <span class="no">Track</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">title</span><span class="p">:</span> <span class="s1">&#39;The Grudge&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="n">track_to_be_modified</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Grudgeola&#39;</span>
<span class="n">track_to_be_modified</span><span class="o">.</span><span class="n">save</span>
<span class="nb">p</span> <span class="n">track_to_be_modified</span> <span class="c1"># displays modified record</span>
<span class="nb">p</span> <span class="no">Track</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">title</span><span class="p">:</span> <span class="s1">&#39;The Grudge&#39;</span><span class="p">)</span> <span class="c1"># empty Array (not found as we&#39;ve overridden the original record)</span>
<span class="nb">p</span> <span class="no">Track</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">title</span><span class="p">:</span> <span class="s1">&#39;Grudgeola&#39;</span><span class="p">)</span> <span class="c1"># displays Array of records found (only one, the modified record)</span>
</pre></div>
</code></pre>
<p>But remember this was just a quick introduction to the concepts of the ActiveRecord pattern (and using it with a SQLite database). There are <em>many</em> different querying methods available via ActiveRecord so do get stuck into the API documentation to see what other goodies are at your disposal. </p>
<p>If you don&#39;t use/like Ruby then as I said previously: there are many different adaptations of the ActiveRecord pattern so look out for implementations in your language of choice.</p>
</div>

  <div class="comments">
    <a href="/posts/sqlite-and-activerecord/#comments">
      <span class="icon-bubbles"></span>
      Comments
    </a>
  </div>

  <div class="post-head group">
  <a href="/posts/unix-commands/">
    <h1 class="post-title">Unix Commands</h1>
  </a>
  <span class="post-date">2013 &#183; 10 &#183; 1</span>
</div>

<div class="post-body"><h2><a name="what-we-ll-cover"class="anchor" href="#what-we-ll-cover"><span class="header-link"></span></a>What we&#39;ll cover</h2>
<p><em>reading time: approx. 15mins</em></p>
<ul>
<li>Introduction</li>
<li>Basics<ul>
<li>What directory am I currently in?</li>
<li>How can I see what&#39;s in this directory?</li>
<li>Moving around</li>
<li>Display content of a file</li>
<li>Copy a file</li>
<li>Move a file</li>
<li>Rename a file</li>
<li>Delete a file</li>
<li>Delete a directory</li>
</ul>
</li>
<li>Grep (Searching for patterns)</li>
<li>Sed (Find and Replace)</li>
<li>Awk (Looping Logic)</li>
<li>Piping I/O<ul>
<li>Input and Output</li>
<li>Redirection</li>
<li>Piping</li>
<li>Piping examples</li>
</ul>
</li>
<li>Miscellaneous Commands<ul>
<li>tee</li>
<li>dig</li>
<li>ps</li>
<li>xargs</li>
<li>cut</li>
</ul>
</li>
<li>Conclusion</li>
</ul>
<h2><a name="introduction"class="anchor" href="#introduction"><span class="header-link"></span></a>Introduction</h2>
<p>The unix command line has a hundred or so commands, and a small majority of those you can realistically find yourself using on a regular basis. In this post I want to cover some common commands that can actually be quite useful to you.</p>
<p>Shell commands aren&#39;t something you can cover in one post. Entire books have been written on the subject. So don&#39;t expect anything other than the bare bone basics here, which should hopefully give you enough of an understanding to take your own learning forward.</p>
<p>So let&#39;s begin… </p>
<h2><a name="basics"class="anchor" href="#basics"><span class="header-link"></span></a>Basics</h2>
<p>OK, so I&#39;ll assume you have absolutely no prior command line experience which means we need to start at the basics.</p>
<p>So, first things first: open up your shell (if you&#39;re on a Mac then this will be your <code>Terminal.app</code> application.</p>
<h3><a name="what-directory-am-i-currently-in-"class="anchor" href="#what-directory-am-i-currently-in-"><span class="header-link"></span></a>What directory am I currently in?</h3>
<p><code>pwd</code> - this stands for &quot;Print Working Directory&quot;</p>
<h3><a name="how-can-i-see-what-s-in-this-directory-"class="anchor" href="#how-can-i-see-what-s-in-this-directory-"><span class="header-link"></span></a>How can I see what&#39;s in this directory?</h3>
<p><code>ls</code> - this tells the shell to list out any files or folders in the current working directory.</p>
<p>You can also tell the command a directory path you want it to look inside of: <code>ls ~/Desktop</code> (this will list all files and folders on your desktop).</p>
<p><code>ls -l</code> - the <code>-l</code> flag tells the command to stack the list when it prints its output to the shell.</p>
<p><code>ls -la</code> - this is a combination of the previous flag and the <code>-a</code> flag which means &quot;show all files&quot; (by this I mean, it&#39;ll show you hidden files).</p>
<h3><a name="moving-around"class="anchor" href="#moving-around"><span class="header-link"></span></a>Moving around</h3>
<p>To move around your file system you use the &#39;change directory&#39; command <code>cd</code>.</p>
<p>So: <code>cd ~/Desktop</code> will put you in the Desktop.</p>
<p>You can also use relative paths such as <code>cd ../</code> which will take you up one level from wherever you happen to be.</p>
<h3><a name="displaying-content-of-a-file"class="anchor" href="#displaying-content-of-a-file"><span class="header-link"></span></a>Displaying content of a file</h3>
<p>The <code>cat</code> command is a concatenation command, meaning that if you ran <code>cat original.txt new.txt</code> it would display on your screen the combination of the content from both files specified.</p>
<p>So, with that understanding we can use <code>cat original.txt</code> (i.e. specifying just a single file) to show the contents of that file.</p>
<h3><a name="let-s-copy-a-file"class="anchor" href="#let-s-copy-a-file"><span class="header-link"></span></a>Let&#39;s copy a file</h3>
<p>To copy a file we need the <code>cp</code> command, and we tell it what file to copy and where to copy it to.</p>
<p>So: <code>cp ~/Downloads/test.txt ~/Desktop/test.txt</code> will copy the file <code>test.txt</code> (which is inside our &#39;Downloads&#39; folder) and put the copy on our Desktop.</p>
<h3><a name="let-s-move-a-file"class="anchor" href="#let-s-move-a-file"><span class="header-link"></span></a>Let&#39;s move a file</h3>
<p>To move a file you need the <code>mv</code> command, and we tell it what file to move and where to move it to.</p>
<p>So: <code>mv ~/Downloads/test.txt ~/Desktop/test.txt</code> will move the file <code>test.txt</code> from our &#39;Downloads&#39; folder onto our &#39;Desktop&#39;.</p>
<h3><a name="let-s-rename-a-file"class="anchor" href="#let-s-rename-a-file"><span class="header-link"></span></a>Let&#39;s rename a file</h3>
<p>There is no <code>rename</code> command on Unix (although there is in Linux) and so we need to use a trick, the trick being to use the <code>mv</code> command.</p>
<p>So: <code>mv ~/Downloads/test.txt ~/Downloads/new.txt</code> will actually rename the file <code>test.txt</code> to <code>new.txt</code> as we&#39;ve moved the file into the same directory it was already in but with a different name (effectively acting like we renamed it)</p>
<h3><a name="let-s-delete-a-file"class="anchor" href="#let-s-delete-a-file"><span class="header-link"></span></a>Let&#39;s delete a file</h3>
<p>To delete a file we need the &#39;remove&#39; command <code>rm</code>.</p>
<p>So: <code>rm ~/Downloads/test.txt</code> will delete our <code>test.txt</code> file.</p>
<h3><a name="let-s-delete-a-directory"class="anchor" href="#let-s-delete-a-directory"><span class="header-link"></span></a>Let&#39;s delete a directory</h3>
<p>To delete a folder we need the &#39;remove&#39; command <code>rm</code> again but this time we need to pass in a couple of flags to the command.</p>
<p>The first flag is <code>-f</code> which means &#39;force&#39; the removal (otherwise if you try to remove a folder then the shell will try and prevent this as it&#39;ll assume you&#39;ve made a mistake, and deleting a whole folder could be a big mistake if you&#39;re not careful).</p>
<p>The second flag is <code>-r</code> which means &#39;recursively&#39;. So you&#39;ll recursively delete files within the folder.</p>
<p>So: <code>rm -rf ~/Desktop/some-folder</code> will delete our <code>some-folder</code> folder on the Desktop.</p>
<h2><a name="grep-searching-for-patterns-"class="anchor" href="#grep-searching-for-patterns-"><span class="header-link"></span></a>Grep (Searching for patterns)</h2>
<p>Grep is a command that lets you find a pattern (either a string or a regular expression) inside of a file or list of files.</p>
<p>So: <code>grep &#39;something&#39; test.txt</code> looks for the word &#39;something&#39; inside of the file <code>test.txt</code>.</p>
<p>To use grep on a directory of files then we need to use an additional flag: <code>-r</code> which means &#39;recursive&#39; (similar to the <code>rm</code> command we saw previously).</p>
<p>So: <code>grep -r &#39;something&#39; ~/Desktop</code> looks for the word &#39;something&#39; inside of any files on the Desktop.</p>
<h2><a name="sed-find-and-replace-"class="anchor" href="#sed-find-and-replace-"><span class="header-link"></span></a>Sed (Find and Replace)</h2>
<p>The <code>sed</code> command stands for (S)tream (Ed)itor and allows you to  read in the contents of a file and then write the modified output to another file or pipe it through to another I/O command (we&#39;ll cover piping later).</p>
<p>A basic example of its use would be: <code>sed s/day/night/ novel.txt</code></p>
<p>This replaces the first occurrence of &#39;day&#39; to &#39;night&#39;. If we wanted to replace multiple occurrences then you would need to pass a <code>g</code> flag (meaning global) to the regular expression like so: <code>sed s/day/night/g novel.txt</code></p>
<h2><a name="awk-looping-logic-"class="anchor" href="#awk-looping-logic-"><span class="header-link"></span></a>Awk (Looping Logic)</h2>
<p>The <code>awk</code> command reads in each line of a file and splits the line into fields (using whitespace - space, tab - as its default delimiter).</p>
<p>You can then execute commands for each line and reference each field.</p>
<p>A basic example of its use would be: <code>awk &#39;{ print $1 }&#39;</code> which means &quot;print the first field found in the current line&quot;.</p>
<p>So imagine you have the following <code>test.txt</code> file…</p>
<pre><code class="lang-sh"><div class="highlight"><pre>This is my first line
This is my second line
This is my third line
</pre></div>
</code></pre>
<p>…you could print the line number followed by a specific word (in this case the second from last word on each line) using the following awk command: <code>awk &#39;{ print &quot;Line &quot; NR &quot;: &quot; $(NF-1) }&#39; test.txt</code></p>
<p>Which would display the following content on your screen… </p>
<pre><code class="lang-sh"><div class="highlight"><pre>Line 1: first
Line 2: second
Line 3: third
</pre></div>
</code></pre>
<p>Let&#39;s break this command down a little…</p>
<ul>
<li>Awk commands are placed inside of single quotes <code>awk &#39;commands go here&#39;</code>.</li>
<li>Inside the single quotes we need a set of brackets to place our specific code we want to run: <code>awk &#39;{ code to run here }&#39;</code></li>
<li>We specifically tell awk to <code>print</code> something to stdout (i.e. the terminal screen).</li>
<li>In this case we tell it to print the text &quot;Line &quot; followed by the current line number <code>NR</code>.</li>
<li>As part of the same print command we then tell it to print &quot;: &quot; followed by the second from last number.</li>
<li>To do that we use two pieces of syntax <code>$()</code> and <code>NF</code>.</li>
<li><code>NF</code> stands for (N)umber of (F)ields.</li>
<li>The <code>$()</code> wrapping around <code>NF</code> is our &#39;process substitution&#39;. This means we&#39;re not just outputting some data but manipulating it by using logic to give us 1 field back from the last, hence it needs to be wrapped in <code>$()</code></li>
</ul>
<h2><a name="piping-i-o"class="anchor" href="#piping-i-o"><span class="header-link"></span></a>Piping I/O</h2>
<p>The previous commands <code>awk</code>, <code>sed</code>, <code>grep</code> are all really useful, but it&#39;s when you can combine them that their true power shines.</p>
<h3><a name="input-and-output"class="anchor" href="#input-and-output"><span class="header-link"></span></a>Input and Output</h3>
<p>Unix is based on the principle of &quot;input&quot; and &quot;output&quot; (known as &quot;I/O&quot;). In the Shell you have <code>stdin</code> (standard input) and <code>stdout</code> (standard output).</p>
<p>By default, <code>stdin</code> is your keyboard (i.e. whatever you type into the terminal shell) and <code>stdout</code> is the terminal (i.e. your screen).</p>
<h3><a name="redirection"class="anchor" href="#redirection"><span class="header-link"></span></a>Redirection</h3>
<p>Once you understand <code>stdin</code> and <code>stdout</code> you can start to look at redirecting them.</p>
<p>For example when using the <code>sed</code> command you could use redirection to not overwrite your original file and instead direct the output <code>stdout</code> coming from the <code>sed</code> command to another file: <code>sed s/day/night/g original.txt &gt; new.txt</code></p>
<h3><a name="piping"class="anchor" href="#piping"><span class="header-link"></span></a>Piping</h3>
<p>Another way to <em>direct</em> input and output is to use pipes <code>|</code> (a vertical bar).</p>
<p>A really simple example would be: look at the <code>sed</code> command we used earlier (<code>sed s/day/night/ novel.txt</code>). Rather than actually execute it and have it make the specified change to our file <code>novel.txt</code> we could instead test the command to make sure it does what we expect it to.</p>
<p>To do that we would use the <code>cat</code> command (which we looked at previously) and pipe its output through to the <code>sed</code> command like so… </p>
<p><code>cat original.txt | sed s/day/night/g</code></p>
<p>So, to clarify how this works: we&#39;re redirecting the <code>cat</code> command&#39;s <code>stdout</code> through to the <code>sed</code> command&#39;s <code>stdin</code>. </p>
<p>In our original <code>sed</code> example we directed the <code>sed</code> command&#39;s <code>stdout</code> to an actual file (<code>novel.txt</code>), but in this case it has no <code>stdout</code> specified so it falls back to the default <code>stdout</code> which in this case is the terminal shell itself.</p>
<p>Hence the results of the <code>sed</code> command (the modified content) are displayed on your screen.</p>
<h3><a name="piping-to-vim"class="anchor" href="#piping-to-vim"><span class="header-link"></span></a>Piping to Vim</h3>
<p>One thing I discovered recently (via <a href="http://twitter.com/Pand0ra83">Crystal Hirschorn</a>) was that you can&#39;t just pipe <code>stdout</code> into Vim unless you add a hyphen/dash <code>-</code> to the end of the command like so: <code>ls | vim -</code></p>
<p>Otherwise Vim will complain that: <code>Input is not from a terminal</code></p>
<p>That&#39;s a good one to remember!</p>
<p>Also you can pipe the input into Vim in read-only mode using the <code>-R</code> flag as well: <code>ls | vim -R -</code></p>
<h3><a name="piping-examples"class="anchor" href="#piping-examples"><span class="header-link"></span></a>Piping examples</h3>
<p>Here are three real world examples I&#39;ve used recently…</p>
<pre><code class="lang-sh"><div class="highlight"><pre>phantomjs 2&gt;<span class="p">&amp;</span>1 network-test.js <span class="p">|</span> tee log.txt
</pre></div>
</code></pre>
<p>In this example I&#39;m executing a <a href="http://phantomjs.org/">PhantomJS</a> script <code>network-test.js</code> but I wanted to capture both the results of the script (which just logs out DNS information into the terminal) and any errors that may have occurred into a log text file.</p>
<p>The way it works might be a little confusing as it shows some things you might not have seen before: <code>2&gt;&amp;1</code> and <code>tee</code>.</p>
<p>Those two commands may look confusing but it just comes down to understanding the numbers that are associated with specific processes, so…</p>
<ul>
<li><code>0</code> = <code>stdin</code></li>
<li><code>1</code> = <code>stdout</code></li>
<li><code>2</code> = <code>stderr</code></li>
</ul>
<p>…this means <code>2&gt;&amp;1</code> is saying direct <code>2</code> (any errors) through to <code>1</code> (standard output).</p>
<p>We then pipe the <code>stdout</code> through to the <code>tee</code> command which copies it into a file called <code>log.txt</code>.</p>
<pre><code class="lang-sh"><div class="highlight"><pre>ls File-* <span class="p">|</span> sed <span class="s1">&#39;s/\(File-[^-]*\)-\(.*\)/mv &amp; \1\2/&#39;</span> <span class="p">|</span> sh
</pre></div>
</code></pre>
<p>In this example I&#39;m trying to remove a hyphen <code>-</code> from some file names.</p>
<p>The files I have look like <code>File-A-B.gif</code> and I want them to be renamed to <code>File-AB.gif</code>.</p>
<p>So first I list out any files in the current directory that begin <code>File-</code> and then pipe those results through to <code>sed</code>.</p>
<p>Sed then uses Regular Expressions to store a reference to the opening part of the file name (in this case <code>File-A</code>) and then stores the end part of the file name (in this case <code>B.gif</code>).</p>
<p>In the second part of the <code>sed</code> command, instead of doing a &#39;replace&#39; of what we&#39;ve found, we actually pass in a <code>mv</code> command (remember from before that we can rename a file by using <code>mv original.txt new.txt</code>). In this case the stored references to the beginning and ending parts of the file&#39;s name can be referenced within the replacement section using <code>\1</code> and <code>\2</code> (and the <code>&amp;</code> in regular expressions means, the original string being inspected).</p>
<p>So when we use <code>mv &amp; \1\2</code> we&#39;re saying &quot;move the original file and move it to the same directory but using the new name of File-AB.gif (remember <code>\1</code> is &quot;File-A&quot; and <code>\2</code> is &quot;B.gif&quot;).</p>
<p>Finally, because the <code>sed</code> command&#39;s replacement is an actual command rather than just a string replacement we pipe that replacement content (which is now <code>sed</code>&#39;s <code>stdout</code>) over to the <code>sh</code> bin command to execute and hence actually rename the file(s).</p>
<p>Note: whenever you write a shell script, you would store it (for example) inside a file with the extension of <code>sh</code> and then you&#39;d use the terminal command <code>sh</code> to execute that shell script.</p>
<pre><code class="lang-sh"><div class="highlight"><pre>tmux ls <span class="p">|</span> cut -d : -f 1 <span class="p">|</span> xargs -I <span class="o">{}</span> tmux <span class="nb">kill</span>-session -t <span class="o">{}</span>
</pre></div>
</code></pre>
<p>So in this example I wanted an easy way to destroy all my tmux sessions. </p>
<p>Typically I would run <code>tmux ls</code> to see what sessions I had (it returns something like <code>0: 1 windows (created Fri Oct  4 18:24:38 2013) [129x33]</code>, where the opening <code>0</code> is the number/name of the session followed by details about the session -&gt; in this case <code>1 window</code>, and when it was created, and the size of that window).</p>
<p>Once I had my session number (in this case <code>0</code>) I could run the command <code>tmux kill-session -t 0</code> but if I had loads of sessions open I would have to run the same command for all of them.</p>
<p>To fix this I tried using the commands Awk and Sed but discovered an issue with &#39;scope&#39; (which I&#39;m still not 100% sure I understand, but I&#39;ll explain what happened any way)… </p>
<p>I was using <code>tmux ls | awk &#39;{print $1}&#39; | sed &#39;s/://g&#39; | xargs -I {} tmux kill-session -t {}</code>. This works, but not when you stick it inside an alias for easy reuse.</p>
<p>The way it works is that it lists out all the tmux sessions and pipes it over to Awk.</p>
<p>Awk then grabs the first field <code>0:</code> (remember Awk splits the input line into &#39;fields&#39; using a space delimiter). We then pipe that over to Sed.</p>
<p>Sed then uses a regular expression to remove the <code>:</code> from the <code>0:</code> leaving us with just <code>0</code>. We then pipe that through to xargs.</p>
<p>xargs runs our kill-session command and passes through the value of <code>0</code> into that command using the placeholder <code>{}</code>.</p>
<p>We define what the placeholder will be using <code>-I</code> so we could of used <code>-I target</code> instead if we wanted to like so: <code>tmux ls | awk &#39;{print $1}&#39; | sed &#39;s/://g&#39; | xargs -I target tmux kill-session -t target</code> and it would of achieved the same.</p>
<p>Like I say, this works. But I wanted it inside an alias so I could easily reuse it (I mean, just <em>try</em> and memorise that massive chunk of commands!?). The moment it went into an alias the xargs failed to work because instead of getting <code>0</code> it got the entire line <code>0: 1 windows (created Fri Oct  4 18:24:38 2013) [129x33]</code>. The scope of the argument was being lost some how? A bit annoying really.</p>
<p>My colleague at BBC News (<a href="http://twitter.com/sthulb">Simon Thulbourn</a> - all round command line wizard, amongst many other technical talents) helped me understand a more efficient and fully functioning version (i.e. it can be safely aliased): <code>tmux ls | cut -d : -f 1 | xargs -I {} tmux kill-session -t {}</code>.</p>
<p>So the only difference here is instead of using both Awk and Sed, we&#39;re just using Cut. I&#39;ve not mentioned it before but <code>cut</code> works like this: </p>
<p>Cut splits the input into fields (like Awk does). We then tell it that we want the fields to be split by <code>:</code> (that&#39;s the <code>-d :</code> section). Then finally we use <code>-f 1</code> to say we want the first field, which we pipe over to xargs. Otherwise the rest of the command is the same as before.</p>
<p>Nice huh!</p>
<h2><a name="miscellaneous-commands"class="anchor" href="#miscellaneous-commands"><span class="header-link"></span></a>Miscellaneous Commands</h2>
<h3><a name="-tee-"class="anchor" href="#-tee-"><span class="header-link"></span></a><code>tee</code></h3>
<p>The <code>tee</code> command you&#39;ve seen already now (in our above example) but just to reiterate its use, here is how the manual describes it… </p>
<blockquote>
<p>The tee utility copies standard input to standard output, making a copy in zero or more files.</p>
</blockquote>
<h3><a name="-dig-"class="anchor" href="#-dig-"><span class="header-link"></span></a><code>dig</code></h3>
<p>The <code>dig</code> command is used for carrying out DNS lookups: <code>dig integralist.co.uk</code> returns the DNS records found for my domain name.</p>
<h3><a name="-ps-"class="anchor" href="#-ps-"><span class="header-link"></span></a><code>ps</code></h3>
<p>The <code>ps</code> command stands for (p)rocess (s)tatus</p>
<p>It shows you all running processes on your computer.</p>
<p>You can use piping again to narrow down the results to something in particular you know is causing your computer to slow down and then execute another command to kill that process.</p>
<p>So: <code>ps aux | grep ruby</code></p>
<p>In the above example we also pass <code>aux</code> which basically specifies table of results that should be returned (see: <a href="http://en.wikipedia.org/wiki/Ps_\(Unix\"><a href="http://en.wikipedia.org/wiki/Ps_(Unix">http://en.wikipedia.org/wiki/Ps_(Unix</a>)</a>) for more information).</p>
<p>We then pipe that through to <code>grep</code> and tell it we&#39;re interested only in processes that have the text <code>ruby</code> somewhere (that way we can narrow down the results printed to the screen).</p>
<p>Finally to kill a particular process you&#39;ll need its PID number (which <code>ps aux</code> would have displayed) so locate that PID and then run <code>kill -9 xxxx</code> where <code>xxxx</code> is the PID number you want to stop.</p>
<h3><a name="-xargs-"class="anchor" href="#-xargs-"><span class="header-link"></span></a><code>xargs</code></h3>
<p>I know we&#39;ve covered Xargs already in my previous examples, but it&#39;s worth mentioning that you can also use the <code>-0</code> flag which helps with some commands that won&#39;t work when passed arguments that have spaces in them (imagine a file name with spaces). Using the <code>-0</code> flag resolves that issue.</p>
<p>Also, if the command you want to run only excepts a single argument (for example <code>echo 123</code>) then you can omit the <code>-I {}</code> placeholder definition. </p>
<h3><a name="-cut-"class="anchor" href="#-cut-"><span class="header-link"></span></a><code>cut</code></h3>
<p>Again, we&#39;ve covered Cut above already, but just to note that you can change the field delimiter using <code>-d</code> (e.g. <code>-d ,</code> would split the line on commas).</p>
<p>Also, <code>-f</code> allows a range, not just a single field index. So if you wanted fields 3 to 4 you could do <code>-f 3,4</code></p>
<h2><a name="conclusion"class="anchor" href="#conclusion"><span class="header-link"></span></a>Conclusion</h2>
<p>This was a pretty fast paced run through of some different unix commands. As time goes on I&#39;ll update this post to include other commands and real work use cases that I think would be interesting and useful to those readers new to the command line.</p>
<p>If there were any errors or any thing like that then just let me know by pinging me on <a href="http://twitter.com/integralist">twitter</a>.</p>
</div>

  <div class="comments">
    <a href="/posts/unix-commands/#comments">
      <span class="icon-bubbles"></span>
      Comments
    </a>
  </div>


<div class="pagination group">
  
    
    
  
    
    
      <a href="/page/1/" class="older"> &#8592; Older</a>
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
</div>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js" type="text/javascript"></script>
    <script src="/scripts/main.js" type="text/javascript"></script>
    <script src="/scripts/Imager.js" type="text/javascript"></script>
    <script>
        var _gaq=[['_setAccount','UA-33159515-1'],['_trackPageview']];
        (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
        g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>
  </body>
</html>

